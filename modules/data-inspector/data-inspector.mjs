var it=Object.defineProperty;var ht=(r,t,e)=>t in r?it(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var p=(r,t)=>it(r,"name",{value:t,configurable:!0});var T=(r,t,e)=>(ht(r,typeof t!="symbol"?t+"":t,e),e),nt=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var w=(r,t,e)=>(nt(r,t,"read from private field"),e?e.call(r):t.get(r)),Y=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},E=(r,t,e,s)=>(nt(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e);var m={module:"data-inspector",SETTINGS:{allowEditing:"allowEditing",allowEditingUnsupported:"allowEditingUnsupported",allowUsers:"allowUsers",functions:"functions",results:"results",mode:"mode"},COLORS:{main:"color:deepskyblue",number:"color:mediumpurple",label:"color:mediumseagreen",id:"color:darkseagreen",unset:"color:unset"}};async function st(r){if(window.isSecureContext)return navigator.clipboard.writeText(r);ui.notification.warn("Copying to clipboard requires secure contet (HTTPS) in modern browsers.")}p(st,"copyToClipboard");var o={undefined:-1,null:0,object:110,number:410,boolean:420,string:430,array:120,map:510,function:910,getter:980,custom:1e3,data:2010,document:2020},M=invertObject(o);function rt(r){if(r===void 0)return"undefined";if(r===null)return"null";let t=typeof r;if(["string","number","function","boolean"].includes(t))return t;if(Array.isArray(r))return"array";let e=r.__proto__.constructor.name;return e==="Object"?"object":e==="Map"?"map":"_"+e}p(rt,"getTypeName");function L(r){if(r===void 0)return o.undefined;if(r===null)return o.null;switch(typeof r){case"string":return o.string;case"number":return o.number;case"function":return o.function;case"boolean":return o.boolean}if(Array.isArray(r))return o.array;if(r instanceof foundry.abstract.DocumentData)return o.data;if(r instanceof foundry.abstract.Document)return o.document;let e=r.__proto__.constructor.name;return e==="Object"?o.object:e==="Map"?o.map:o.custom}p(L,"getTypeId");Hooks.once("init",p(function(){game.settings.register(m.module,m.SETTINGS.mode,{name:"Koboldworks.DataInspector.Settings.DefaultMode",hint:"Koboldworks.DataInspector.Settings.DefaultModeHint",scope:"client",config:!0,type:String,default:"rolldata",choices:{rolldata:"Koboldworks.DataInspector.Data.Roll",source:"Koboldworks.DataInspector.Data.Source",derived:"Koboldworks.DataInspector.Data.Derived"}}),game.settings.register(m.module,m.SETTINGS.results,{name:"Koboldworks.DataInspector.Settings.ResultQuality",hint:"Koboldworks.DataInspector.Settings.ResultQualityHint",scope:"client",config:!0,type:Number,default:.7,range:{min:0,max:1,step:.01}}),game.settings.register(m.module,m.SETTINGS.functions,{name:"Koboldworks.DataInspector.Settings.IncludeFunctions",hint:"Koboldworks.DataInspector.Settings.IncludeFunctionsHint",scope:"client",config:!0,type:Boolean,default:!1}),game.settings.register(m.module,m.SETTINGS.allowEditing,{name:"Koboldworks.DataInspector.Settings.AllowEditing",hint:"Koboldworks.DataInspector.Settings.AllowEditingHint",config:!0,scope:"world",type:Boolean,default:!1}),game.settings.register(m.module,m.SETTINGS.allowEditingUnsupported,{name:"Koboldworks.DataInspector.Settings.AllowEditingUnsupported",hint:"Koboldworks.DataInspector.Settings.AllowEditingUnsupportedHint",config:!0,scope:"world",type:Boolean,default:!1}),game.settings.register(m.module,m.SETTINGS.allowUsers,{name:"Koboldworks.DataInspector.Settings.AllowUsers",hint:"Koboldworks.DataInspector.Settings.AllowUsersHint",config:!0,scope:"world",type:Boolean,default:!0})},"registerSettings"));var N=p(r=>game.release.generation>=10?r:r?.data,"getDocData"),ot=p(r=>game.release.generation>=10?foundry.utils.isEmpty(r):foundry.utils.isObjectEmpty(r),"isEmpty"),U=p(()=>game.release.generation>=10?"system":"data","systemPrefix");var C=class extends FormApplication{_path;_type;document;parentApp;static get supportedTypes(){return[o.number,o.string,o.boolean,o.null,o.undefined]}constructor(t,e,s,{isToken:n=!1,app:a}={}){let i=["Data Inspector"];i.push(t.name),i.push(e);let c={};c.title=i.join(": "),c.id="lil-data-inspector-"+t.uuid+"-"+e,super(void 0,c),this.parentApp=a,this.isToken=n,this._path=e,this.document=t;let f=getProperty(t.toObject(),e);this.originalTypeId=s??L(f),this.originalTypeName=M[this.originalTypeId],this._type=this.originalTypeName}get template(){return`modules/${m.module}/template/editor.hbs`}static get defaultOptions(){let t=super.defaultOptions;return mergeObject(t,{...t,title:"Data Inspector \u2013 Editor",classes:[...t.classes,"koboldworks","data-inspector-editor"],submitOnChange:!1,submitOnClose:!1,closeOnSubmit:!1,resizable:!0,width:520,height:360})}getData(){let t=super.getData(),e=this.document,s=getProperty(e.toObject(),this._path),n=this._typeId=L(s),a=this._type??rt(s),i=this.originalTypeName;return t.document=e,t.path=this._path,t.value=s,t.type=a,t.typeName=a,t.originalType=i,t.similarType=i==="string"&&["text","html"].includes(a),t.isHTML=a==="html"||i==="string"&&s[0]==="<",t.isLongString=a==="html"||a==="text"||i==="string"&&(t.value.length>16||t.value.indexOf(`
`)>=0),t.isUnsupported=!C.supportedTypes.includes(n),t.isActor=e instanceof Actor,t.isItem=e instanceof Item,t.simpleType=["number","string","boolean"].includes(a),t.deadType=["null","undefined"].includes(a),t.selectedType=this._type,t.types={number:"Number",boolean:"Boolean",string:"String",null:"Null",undefined:"Undefined",text:"Text Block",html:"HTML (TinyMCE)"},t.isToken=this.isToken,t.TYPES=o,t}activateListeners(t){super.activateListeners(t);let e=t[0],s=this,n=this.parentApp,a=this.isToken;e.querySelector('select[name="type"]')?.addEventListener("change",u=>{u.preventDefault(),u.stopPropagation();let D=this._type,h=u.target.value;this._type=h,this.render()});let i=e.querySelector(".editor > .tox");i&&(i.style.height="100%"),e.querySelector('select[name="type"]')?.addEventListener("change",function(u){u.preventDefault(),u.stopPropagation(),s._type=this.value,s.render(!0)});let c=this.document,f=this._path;e.querySelector("button.delete")?.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation();let h={[f.replace(/([^.]+)$/,g=>`-=${g}`)]:null};console.log("Delete:",h),Dialog.confirm({title:"Delete data?",content:`<p>Delete: <code>${f}</code></p>`,yes:async()=>{let g=game.release.generation>=10;!g&&a&&(c.token._actor=null);let b=p(()=>{s.close(),!g&&a&&n.reAssociate(c.token.actor)},"end");c.update(h).then(v=>b()).catch(v=>b())},defaultYes:!1})})}_updateObject(t,e){let s=this._type,n=this._path,a=this.document,i=e.value;s==="undefined"?i=void 0:s==="null"&&(i=null),console.log("Setting data:",s,n,i);let c={[n]:i};a.update(c).then(f=>this.close())}async close(t){return super.close(t)}};p(C,"ValueEditor");var at=p((r,t)=>r.key.localeCompare(t.key),"dataKeySorter"),$=class{key;type;constructor(t,e){this.key=t,this.type=e}};p($,"ChildKeyData");var j,R,F,V,O,B=class{constructor({key:t,path:e,value:s,parent:n,type:a,treeType:i,depth:c}){T(this,"key");T(this,"path");T(this,"type");T(this,"typeId");T(this,"root");T(this,"value");T(this,"parent");T(this,"children",[]);T(this,"depth",0);T(this,"treetype");T(this,"_sourceData");T(this,"_derivedData");T(this,"_rollData");T(this,"_overides");Y(this,j,void 0);Y(this,R,void 0);Y(this,F,void 0);Y(this,V,void 0);Y(this,O,void 0);this.key=t,this.path=e,this.typeId=a??L(s),this.type=M[this.typeId],this.value=s,this.parent=n,this.root=n?.root??n,this.depth=c,this.treetype=i}get isRollData(){return this.root.treetype==="rolldata"}get isBigString(){return this.typeId===o.string&&this.value?.length>24}get isNull(){return this.typeId===o.null}get isFunction(){return this.typeId===o.function}get isGetter(){return this.typeId===o.getter}get isUndefined(){return this.typeId===o.undefined}get isNullish(){return!!([o.null,o.undefined].includes(this.typeId)||this.isArray&&this.value.length===0||this.isMap&&this.value.size==0)}get isArray(){return this.typeId===o.array}get isMap(){return this.typeId===o.map}get isObject(){return this.typeId===o.object}get isDocument(){return[o.document,o.data].includes(this.typeId)}get documentId(){if(this.typeId===o.data)return this.value._id;if(this.typeId===o.document)return this.value.id}get className(){return this.value.__proto__.constructor.name}get isEmpty(){return this.isNullish?!0:this.typeId===o.array?this.value.length==0:this.typeId===o.object?ot(this.value):this.typeId===o.map?this.value.size===0:this.typeId===o.custom?this.children.length==0:!1}get isString(){return this.typeId===o.string}get isNumber(){return this.typeId===o.number}get inArray(){return this.parent?.isArray??!1}get isContainer(){return[o.array,o.object,o.map,o.custom].includes(this.typeId)}get isCustom(){return this.typeId===o.custom}get formattedValue(){return this.typeId===o.undefined?"undefined":this.typeId===o.null?"null":this.typeId===o.function?"function":this.value}get inRollData(){if(w(this,j)===void 0){if(this.root.treetype==="rolldata")return E(this,j,!0);if(!this.root._rollData)return!1;try{return E(this,j,hasProperty(this.root._rollData,this.path))}catch{}return E(this,j,3)}return w(this,j)}rollDataPathToSystem(t){return this.isRollData?`${U()}.${t}`:t}get inSourceData(){if(w(this,R)===void 0){if(this.root.treetype==="source")return E(this,R,!0);if(!this.root._sourceData)return!1;let t=this.rollDataPathToSystem(this.path);try{let e=this.root._sourceData;return E(this,R,hasProperty(e,t))}catch{}return E(this,R,3)}return w(this,R)}get inDerivedData(){if(w(this,F)===void 0){if(this.root.treetype==="derived")return E(this,F,!0);if(!this.root._derivedData)return!1;let t=this.rollDataPathToSystem(this.path);try{let e=this.root._derivedData;return E(this,F,hasProperty(e,t))}catch{}return E(this,F,3)}return w(this,F)}get inTemporaryData(){if(w(this,V)===void 0){if(!this.root._temporaryData)return!1;let t=this.rollDataPathToSystem(this.path);try{let e=this.root._temporaryData;return E(this,V,hasProperty(e,t))}catch{}return E(this,V,3)}return w(this,V)}get hasOverrides(){return!!this._overrides}get css(){return this.typeId===o.boolean?this.value?"true":"false":this.typeId===o.number?this.value===0?"zero":this.value<0?"negative":"positive":""}childKeys(){if(w(this,O))return w(this,O);if(this.isDocument)return[];switch(this.typeId){case o.array:return E(this,O,[this.value.map(t=>new $(t))]);case o.map:return E(this,O,[Array.from(this.value.keys()).map(t=>new $(t))]);case o.object:case o.custom:{let t=[],e=[],s=[];if(t.push(...Object.getOwnPropertyNames(this.value).map(n=>new $(n))),B.includeFunctions){let n=this.value,a=["constructor","toString","almostEqual","__proto__","prototype","between"];do{if(n.constructor.name==="Object")break;let i=Object.getOwnPropertyNames(n);for(let c of i){if(a.includes(c))continue;let f=Object.getOwnPropertyDescriptor(n,c);!f||(f.get!==void 0?e.push(new $(c,o.getter)):typeof f.value=="function"&&s.push(new $(c,o.function)))}n=Object.getPrototypeOf(n)}while(n)}return E(this,O,[t.sort(at),e.sort(at),s.sort(at)])}default:return E(this,O,[])}}fillChildren(){let t=this.path,e=t?.length?t:this.key,s=this.isArray,n=this.isMap,a=p(u=>{u?.forEach((D,h)=>{let{key:g,type:b}=D,v=s?h:g,x=n?this.value.get(v):this.value[v],H=e?`${e}.${v}`:v;if(Hooks.call("data-inspector.filterData",this.root.document,H,this.treetype)===!1||L(x)===o.function&&!B.includeFunctions)return;let l=new B({key:v,path:H,value:x,parent:this,type:b,depth:this.depth+1});this.children.push(l)})},"parseChildren"),[i,c,f]=this.childKeys();return a(i),a(c),a(f),this.children}static recurse(t,e,s,n,{includeFunctions:a=!1,document:i}={}){B.includeFunctions=a??!1;let c=new B({key:e,path:s,value:t,parent:null,treeType:n,depth:0});c.document=i,c.root=c;let f={};c.path&&(f[c.path]=c);let u=0,D=!1;function h(g){g.fillChildren().forEach(b=>{if(f[b.path]=b,u++,u>25e3){D||(ui.notifications.error("DATA INSPECTOR | Possible cyclic reference encountered; ending inspection early"),console.error(b.path,`
DATA INSPECTOR | Possible cyclic reference encountered; ending inspection early
`,b),D=!0);return}h(b)})}return p(h,"recurseChildren"),h(c),{root:c,all:f}}getAtPath(t){let e=t.split("."),s=e.shift(),a=p(()=>{switch(this.typeId){case o.array:return this.children[parseInt(s)];default:return this.children.find(i=>i.key===s)}},"getPart")();return e.length===0?a:a?.getAtPath(e.join("."))}},K=B;p(K,"DataStructure"),j=new WeakMap,R=new WeakMap,F=new WeakMap,V=new WeakMap,O=new WeakMap,T(K,"includeFunctions",!1);function dt(r){let t=U(),e={name:r.name+" [Temporary]",type:r.type,[t]:{}};return Hooks.call("data-inspector.temporaryData",r,e),r instanceof Actor?new Actor(e):new Item(e)}p(dt,"createTemporaryDocument");var Z=class{path;keyFocus=!0;match;get mismatch(){return this.indexes.path.length===0}target;score;keyFullMatch;pathFullMatch;indexes={path:[],key:[]};ratio;get good(){return this.ratio>.8}get bad(){return this.ratio<.3}scoring={full:void 0,key:void 0};constructor({path:t,match:e,target:s,score:n,keyFocus:a,keyFullMatch:i,pathFullMatch:c,pathIndexes:f,keyIndexes:u,ratio:D,scoring:h}={}){this.path=t,this.match=e,this.target=s,this.keyFocus=a,this.score=n,this.keyFullMatch=i,this.pathFullMatch=c,this.indexes.path=f,this.indexes.key=u,this.ratio=D,this.scoring=h}};p(Z,"SearchResult");var tt=class{score;indexes;full;half;ratio;consecutives;longestChain;scoring;constructor({indexes:t,full:e,half:s,ratio:n,consecutives:a,longestChain:i,scoring:c}={}){this.indexes=t,this.full=e,this.half=s,this.ratio=n,this.consecutives=a,this.longestChain=i,this.scoring=c,this.score=c.reduce((f,u)=>f+u.value)}};p(tt,"TermMatch");var k=class{value;description;constructor(t,e){this.value=t,this.description=e}};p(k,"Score");var Q=class extends FormApplication{_path="";_pathEl;_search="";_searchEnd=!0;_functions=!1;_document=!1;_mode="rolldata";_expandedItems=new Set;_derivedData;_sourceData;_temporaryData;_rollData;_overrides;_resultQuality=.7;root;parentActor;paths;constructor(t,e={}){let s=["Data Inspector"],n=null;t.actor&&(n=t.actor),n&&s.push(n.name),s.push(t.name),e.title=s.join(": "),e.id="lil-data-inspector-"+t.uuid,super(t,e),this._functions=game.settings.get(m.module,m.SETTINGS.functions),this._resultQuality=game.settings.get(m.module,m.SETTINGS.results),this._mode=game.settings.get(m.module,m.SETTINGS.mode),this.document=t,this.parentActor=n,t.apps[this.appId]=this}get template(){return`modules/${m.module}/template/inspector.hbs`}static get defaultOptions(){let t=super.defaultOptions;return mergeObject(t,{title:"Data Inspector",classes:[...t.classes,"koboldworks","data-inspector"],resizable:!0,width:520,height:620,scrollY:["div.data"]})}getDataVariant(t,e){let s=game.release.generation>=10;switch(e??this._mode){default:case"mixed":return this._rollData==null&&(this._rollData=t.getRollData()),this._sourceData==null&&(this._sourceData=t.toObject()),this._derivedData==null&&(this._derivedData=N(t)),this._overrides==null&&(this._overrides=s?t.token?.actorData:t.token?.data.actorData),{};case"override":return this._overrides==null&&(this._overrides=s?t.token?.actorData:t.token?.data.actorData),this._overrides;case"rolldata":return this._rollData==null&&(this._rollData=t.getRollData()),this._rollData;case"source":return this._sourceData==null&&(this._sourceData=t.toObject()),this._sourceData;case"derived":return this._derivedData==null&&(this._derivedData=N(t)),this._derivedData}}reAssociate(t){this.document=t,t.apps[this.appId]=this,this.render()}getData(){let t=super.getData(),e=this.document,s=e instanceof Actor,n=e.type,a=`${s?"ACTOR":"ITEM"}.Type${n.capitalize()}`,i=game.i18n.localize(a);this._mode==="source"&&(this._temporaryData??=dt(this.document).toObject());let c=U();t.rolldata={[c]:this.getDataVariant(e,"rolldata")},t.sourcedata=this.getDataVariant(e,"source"),t.derived=this.getDataVariant(e,"derived"),t.overrides=this.getDataVariant(e,"override");let f=this.getDataVariant(e);t.document=e,t.type=n,t.typeLabel=i,t.docType=e.constructor.name,t.dataType=this._mode,t.isRollData=this._mode==="rolldata",t.isSourceData=this._mode==="source",t.isDerivedData=this._mode==="derived",t.isOverrideData=this._mode==="override",t.resultQuality=this._resultQuality;let u=this._mode==="rolldata",D=u?null:c,{root:h,all:g}=K.recurse(u?f:f[c],D,D,this._mode,{includeFunctions:this._functions,document:e});return t.data=h,this.root=h,h._sourceData=t.sourcedata,h._derivedData=t.derived,h._rollData=t.rolldata,h._overrides=t.overrides,h._temporaryData=this._temporaryData,this._mode==="rolldata"&&(t.sourcedata=N(t.sourcedata),t.derived=N(t.derived)),t.uuid=e.uuid,t.search=this._search,t.searchEnd=this._searchEnd,t.includeFunctions=this._functions,t.includeDocument=this._document,t.path=this._path,t.TYPES=o,t}treeWalker(t,e,...s){e(t,...s);let n=t.parentElement;n&&["LI","UL"].includes(n.tagName)&&this.treeWalker(n,e,...s)}highlightEl(t,e=!0){this._pathEl&&this._pathEl.classList.toggle("selected",!1),t.classList.toggle("selected",e),this._pathEl=t}expandDataElTree(t){this.treeWalker(t,this.expandDataEl,!1,!0)}expandDataEl(t,e=!0,s=void 0){if(t.classList.toggle("hide",!1),!(t.classList.contains("value")||t.classList.contains("empty"))){if(e){let n=t.dataset.path,a=this._expandedItems;t.classList.contains("collapsed")?a.add(n):a.delete(n)}t.classList.toggle("collapsed",s!==void 0?!s:void 0),t.classList.toggle("expanded",s)}}collapseAndClearEl(t,e=!1,s=!1){t.classList.toggle("hide",e),t.dataset.matchQuality=null,t.classList.toggle("selected",!1),!(t.classList.contains("value")||t.classList.contains("empty"))&&(t.classList.toggle("collapsed",!0),t.classList.toggle("expanded",!1))}expandData(t,e){t.preventDefault(),t.stopPropagation(),this.expandDataEl(e)}activateListeners(t){super.activateListeners(t);let e=t[0],s=e.querySelector(".header"),n=e.closest("[data-appid]");if(n){let l=this.document,d=l instanceof Item?l:null;d&&(n.dataset.itemId=d.id,n.dataset.itemUuid=d.uuid);let y=l instanceof Actor?l:this.parentActor;y&&(n.dataset.actorId=y.id,n.dataset.actorUuid=y.uuid)}let a=s.querySelector("input.path"),i=this,c=this._mode==="rolldata",f=this._mode==="source";function u(l){let d=l.target.value;if(i._mode!==d){l.preventDefault(),l.stopPropagation(),l.target.disabled=!0;let y=i._path;if(y.length>0){let _=y.split(""),P=`${U()}.`;y[0]==="@"&&i._mode==="rolldata"?_.splice(0,1,P):y.length>5&&y.startsWith(P)&&d==="rolldata"&&_.splice(0,P.length,"@"),i._path=_.join("")}i._path=i.getBasePath(i._path,i._mode),i._mode=d,i._lastSearch=void 0,i.render(!1,{keepCache:!0})}}p(u,"changeDataSource"),s.querySelector("select.type").addEventListener("change",u);function D(l){i._resultQuality=Number(this.value),i._search.length>0&&i.doSearch(i._search,{forceRefresh:!0})}p(D,"changeSearchQuality"),s.querySelector("input.search-quality").addEventListener("change",D);function h(l){l.preventDefault(),l.stopPropagation();let d=this,y=d.dataset.path,_=c?`@${y}`:y;if(a.value=_,i._path=_,i.highlightEl(d,!0),window.isSecureContext)return st(_)}p(h,"copyPath"),t.on("click","[data-path]",function(l){i.expandData(l,this)}),t.on("contextmenu","[data-path]",h),a.addEventListener("input",l=>this.debounceCustomPath(l.target.value,l,!0)),a.addEventListener("change",l=>this.debounceCustomPath(l.target.value,l,!1)),e.querySelectorAll("[data-path]").forEach(l=>{let d=l.dataset.path;this._expandedItems.has(d)&&this.expandDataEl(l)});let g=e.querySelector("form > .data");g.addEventListener("dblclick",p(function(d){if(d.preventDefault(),d.stopPropagation(),["source","override"].includes(i._mode)){let y=d.target,_=y.dataset.path?y:y.closest("[data-path]");_&&i._openValueEditor(d,_.dataset.path)}else ui.notifications.warn(`Editing not supported in "${i._mode}" mode!`)},"openEditor"));let b=p(l=>{let d=l.dataset.path,y=l.dataset.key,_=l.querySelector("h4");this.paths.set(d,{path:d,key:y,element:l,label:_.textContent})},"buildSearchCache");function v(l,d){let y=l.getBoundingClientRect();d.style.cssText+=`--top:${y.bottom};--width:${d.clientWidth};--p-left:${y.left};--height:${d.clientHeight};--p-height:${y.height};--p-width:${y.width};--p-right:${y.right};--p-top:${y.top};`}p(v,"updateTooltipData");let x=g.querySelectorAll("li[data-path]"),H=this._mode==="rolldata"?"@":"";x.forEach(l=>{let d=l.querySelector(".details");d.addEventListener("mouseenter",y=>{let _=document.createElement("span");_.classList.add("tooltip"),d.classList.add("has-tooltip");let P=l.dataset.path,S=H+P,A=P;if(i._mode!=="rolldata"){let J=P.split(".");J.shift(),A=J.join(".")}let I=this.root?.getAtPath(A),z=I.typeId,ut=z!==o.custom?M[z]:`{${I.className}}`,q=["<label>Path</label>: <span class='path'>",S,"</span><br>","<label>Type</label>: <span class='type'>",ut,"</span><br>"];[o.data,o.document].includes(z)&&q.push("<label>Document ID</label>: <span class='type'>",I.documentId,"</span><br>"),q.push("<br>");let W=[];I.root.treetype!=="rolldata"&&W.push({label:"Roll Data",present:I.inRollData}),I.root.treetype!=="derived"&&W.push({label:"Derived",present:I.inDerivedData}),I.root.treetype!=="source"?W.push({label:"Source",present:I.inSourceData}):W.push({label:"Temporary",present:I.inTemporaryData}),q.push('<div class="in-data">');for(let J of W)q.push('<div class="data-source">','<label class="header">',J.label,"</label>",'<span class="value">',J.present?"\u2713":"\u2717","</span>","</div>");q.push("</div>"),_.innerHTML=q.join(""),d.prepend(_),v(l,_),l.addEventListener("mouseenter",()=>v(l,_),{passive:!0})},{passive:!0,once:!0})});let G=s.querySelector("input.search");G.addEventListener("change",l=>this.debounceSearch(l.target.value,l,!1),{passive:!0}),G.addEventListener("input",l=>this.debounceSearch(l.target.value,l,!0),{passive:!0}),this.paths=new Collection,x.forEach(l=>b(l)),s.querySelector("input.functions").addEventListener("change",l=>{l.preventDefault(),l.stopPropagation(),this._functions=l.target.checked,this.render()}),this._search.length&&this.debounceSearch(this._search),this._functions&&(this._getGetterValueBound||(this._getGetterValueBound=this._getGetterValue.bind(this)),g.addEventListener("click",function(l){!l.target.matches(".getter.value")||(l.preventDefault(),l.stopPropagation(),i._getGetterValueBound(l))})),this.expandSelectedPath()}_openValueEditor(t,e){if(!game.settings.get(m.module,m.SETTINGS.allowEditing))return ui.notifications.warn("Editing has been disabled.");let s=e.split("."),a=N(this.document);for(;s.length>0;){let f=s.shift();if(a=a[f],a==null&&s.length>0)return ui.notifications.warn(`Failed to navigate to the target datapath: ${e}`);if(Array.isArray(a)&&s.length>0)return ui.notifications.warn(`Editing arrays or values inside of arrays not supported: ${e}`)}let i=L(a),c=C.supportedTypes.includes(i);if(!C.supportedTypes.includes(i)&&!game.settings.get(m.module,m.SETTINGS.allowEditingUnsupported))return ui.notifications.warn(`Unsupported type for editing: ${M[i]}`);new C(this.document,e,i,{isToken:this._mode==="override",app:this}).render(!0,{focus:!0})}_copyId(t){let e=this.dataset.id;return console.log("Copying ID:",e),st(e)}_getGetterValueBound;_getGetterValue(t){t.stopImmediatePropagation(),t.preventDefault();let e=t.target;!e||(e.removeEventListener("click",this._getGetterValueBound),this._resolveGetter(e))}_resolveGetter(t){let e=t.dataset.path?t:t.closest("[data-path]");if(!e)return;let n=e.dataset.path.split(".");n.shift(),n=n.join(".");let a=this.root.getAtPath(n),i=a.value;t.textContent=i,t.classList.add("resolved");let c=L(i),f=new K({key:a.key,path:a.path,value:i,type:c});t.classList.add(f.type)}getBasePath(t,e){switch(e??=this._mode,e){case"rolldata":return t.replace(/^@/,"");default:return t.substring(U.length)}}expandSelectedPath(){if(this._path.length==0)return;let t=this.getBasePath(this._path),e=this.paths.get(t);e&&(this.expandDataElTree(e.element),this._pathEl=e.element,this.highlightEl(this._pathEl,!0),this._pathEl.scrollIntoView({block:"center"}))}inputDebounceDelay=250;searchDelayTimer;selectDelayTimer;debounceSearch(t,e,s=!1){clearTimeout(this.searchDelayTimer),t.length===0&&(s=!1);let n=Math.clamped(s?t.length>3?this.inputDebounceDelay:this.inputDebounceDelay*2:this.inputDebounceDelay/2,150,500);this.searchDelayTimer=setTimeout(a=>this.doSearch(t),n)}debounceCustomPath(t,e,s=!1){this._path=t,this._pathEl&&(this._pathEl.classList.toggle("selected",!1),this._pathEl=null),clearTimeout(this.selectDelayTimer),t.length===0&&(s=!1);let n=s?t.length>3?this.inputDebounceDelay:this.inputDebounceDelay*2:this.inputDebounceDelay/2;this.selectDelayTimer=setTimeout(a=>this.selectCustomPath(t),n)}selectCustomPath(t){this._path=t,this.expandSelectedPath();let e=this.paths.get(t);e?(this.expandDataElTree(e.element),this.highlightEl(e.element),this._pathEl=e.element):this._pathEl=null}_lastSearch;lastEndSerch;doSearch(t,{forceRefresh:e=!1}={}){if(this._search=t,console.log("Searching:",this._search),e!==!0&&this._lastSearch===t&&this.lastEndSerch===this._searchEnd)return;if(this._lastSearch=t,this.lastEndSerch=this._searchEnd,t.length==0){this.paths.forEach(u=>this.collapseAndClearEl(u.element,!1)),this.expandSelectedPath();return}this.paths.forEach(u=>this.collapseAndClearEl(u.element,!0));let s=t.toLowerCase().split("");function n(u,D,{harsh:h=!0}={}){let g=[],b=D.toLowerCase().split(""),v=0,x=0,H=0,G=u[0],X=-2,l=1,d=[],y=p(()=>{l>x&&(x=l),l=1},"updateLongestChain");for(let S=0;S<b.length;S++)if(b[S]===G){g.push(S),X===S-1?(d.push(new k(3,`Consecutive [${S}]: +3`)),v++,l++):(d.push(new k(1,`Match [${S}]: +1`)),y()),X=S;let A=Math.clamped(Math.round((b.length-S)/5),0,3);if(A>0&&d.push(new k(A,`End bonus: +${A}`)),G=u[++H],G===void 0)break}y(),g.length>0?d.push(new k(g.length*3,`Matched letters bonus: ${g.length*3}`)):d.push(new k(-100,"No matches: -100"));let _=g.length==u.length;_&&d.push(new k(20,"Full match: +20"));let P=g.length<Math.floor(u.length/2)-2;if(h){let S=d.reduce((I,z)=>z.value+I),A=-Math.floor(S/2);P&&d.push(new k(A,`Partial match: ${A}`)),x<=1&&d.push(new k(-20,"Short chains: -20"))}return new tt({indexes:g,full:_,half:P,ratio:(v+1)/u.length,consecutives:v,longestChain:x,scoring:d})}p(n,"matchTerm");let a=0,i=0,c=this.paths.reduce((u,D)=>{let h=n(s,D.path),g=n(s,D.key);g.full&&a++,h.full&&i++;let b=h.ratio>.5,v=h.ratio;return this._keyFocus?(h.score/=5,v=g.ratio,b=g.ratio>h.ratio):(v+=g.ratio*2,v/=3),u.push(new Z({path:D.path,match:b,target:D,keyFocus:this._keyFocus,score:h.score/2+g.score*2,keyFullMatch:g.full,pathFullMatch:h.full,pathIndexes:h.indexes,keyIndexes:g.indexes,ratio:v,scoring:{full:h.scoring,key:g.scoring}})),u},[]);c.sort((u,D)=>u.full&&!D.full?-1:D.full&&!u.full?1:D.score-u.score);var f={};try{c.forEach((u,D)=>{let h=u.target.element;h.dataset.searchScore=`${u.score}`,h.dataset.searchRatio=`${u.ratio}`;let g="decent";u.mismatch?g="mismatch":u.bad?g="bad":u.good&&(g="good"),h.dataset.matchQuality=g,a>0?u.ratio>this._resultQuality&&this.expandDataElTree(h):u.bad||this.expandDataElTree(h)})}catch(u){if(u!==f)throw u}this.expandSelectedPath()}async close(t){return delete this.document.apps[this.appId],super.close(t)}render(t=!1,e={}){return e.keepCache||(this._rollData=void 0,this._sourceData=void 0,this._derivedData=void 0,this._overrides=void 0,this._lastSearch=void 0),super.render(t,e)}};p(Q,"DataInspectorDialog");function ct(r){let t=Object.values(r.apps).find(e=>e.document===r&&e instanceof Q);t?(t.maximize(),t.bringToTop()):new Q(r).render(!0)}p(ct,"openInspector");function lt(r,t){t.unshift({class:"data-inspector",icon:"fas fa-atom",label:game.i18n.localize("Koboldworks.DataInspector.DataButton"),onclick:e=>ct(r.document)})}p(lt,"injectDataButton");var et=class{static listExt(t){let e=[],s=[],n=["constructor","toString"],a=t;do{if(a.constructor.name==="Object")break;let i=Object.getOwnPropertyNames(a);for(let c of i){if(n.includes(c))continue;let f=Object.getOwnPropertyDescriptor(a,c);!f||(f.get!==void 0?e.push({name:c,type:"getter"}):typeof f.value=="function"&&s.push({name:c,type:"function"}))}a=Object.getPrototypeOf(a)}while(a);return[...e,...s]}};p(et,"HandlebarsHelpers");Hooks.once("ready",async()=>{let r=new RegExp(`/modules/${m.module}/`);if(!game.settings.get(m.module,m.SETTINGS.allowUsers)&&!game.user.isGM)return;let e=["object","inspector","value","object-data"];Hooks.on("getActorSheetHeaderButtons",lt),Hooks.on("getItemSheetHeaderButtons",lt),Handlebars.registerHelper("koboldworks-di-objext",et.listExt),await loadTemplates(e.map(c=>`modules/${m.module}/template/${c}.hbs`));let s=game.modules.get(m.module);s.api={inspect:ct};let n=`modules/${m.module}/systems/${game.system.id}.mjs`,a=m.COLORS;fetch(n,{method:"HEAD",cache:"no-cache",redirect:"manual"}).then(function(c){if(c.status!==200||!c.ok){console.log("%cDATA INSPECTOR%c \u{1F50D} | System specific extensions not found.",a.main,a.unset);return}import(`./systems/${game.system.id}.mjs`).then(f=>console.log("%cDATA INSPECTOR%c \u{1F50D} | System specific extensions loaded.",a.main,a.unset))});let i=N(s);console.log(`%cDATA INSPECTOR%c \u{1F50D} | %c${i.version}%c | READY`,a.main,a.unset,a.id,a.unset)});
//# sourceMappingURL=data-inspector.mjs.map
