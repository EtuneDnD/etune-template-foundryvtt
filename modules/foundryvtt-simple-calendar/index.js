(()=>{var e={162:function(e,t,a){var s,n,i;n=[],s=function(){function t(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}function s(e,t,a){var s=new XMLHttpRequest;s.open("GET",e),s.responseType="blob",s.onload=function(){c(s.response,t,a)},s.onerror=function(){console.error("could not download file")},s.send()}function n(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function i(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(a){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var o="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof a.g&&a.g.global===a.g?a.g:void 0,r=o.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),c=o.saveAs||("object"!=typeof window||window!==o?function(){}:"download"in HTMLAnchorElement.prototype&&!r?function(e,t,a){var r=o.URL||o.webkitURL,c=document.createElement("a");t=t||e.name||"download",c.download=t,c.rel="noopener","string"==typeof e?(c.href=e,c.origin===location.origin?i(c):n(c.href)?s(e,t,a):i(c,c.target="_blank")):(c.href=r.createObjectURL(e),setTimeout((function(){r.revokeObjectURL(c.href)}),4e4),setTimeout((function(){i(c)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,a,o){if(a=a||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(t(e,o),a);else if(n(e))s(e,a,o);else{var r=document.createElement("a");r.href=e,r.target="_blank",setTimeout((function(){i(r)}))}}:function(e,t,a,n){if((n=n||open("","_blank"))&&(n.document.title=n.document.body.innerText="downloading..."),"string"==typeof e)return s(e,t,a);var i="application/octet-stream"===e.type,c=/constructor/i.test(o.HTMLElement)||o.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent);if((l||i&&c||r)&&"undefined"!=typeof FileReader){var d=new FileReader;d.onloadend=function(){var e=d.result;e=l?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),n?n.location.href=e:location=e,n=null},d.readAsDataURL(e)}else{var h=o.URL||o.webkitURL,m=h.createObjectURL(e);n?n.location=m:location.href=m,n=null,setTimeout((function(){h.revokeObjectURL(m)}),4e4)}});o.saveAs=c.saveAs=c,e.exports=c},void 0===(i="function"==typeof s?s.apply(t,n):s)||(e.exports=i)}},t={};function a(s){var n=t[s];if(void 0!==n)return n.exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,a),i.exports}a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={};a.r(e),a.d(e,{Calendars:()=>c,DateSelector:()=>qe,DateSelectorPositions:()=>T,Icons:()=>f,LeapYearRules:()=>h,MoonIcons:()=>f,MoonYearResetOptions:()=>y,NoteRepeat:()=>l,PresetTimeOfDay:()=>C,YearNamingRules:()=>m,activateFullCalendarListeners:()=>Ue,addNote:()=>ze,advanceTimeToPreset:()=>He,changeDate:()=>_e,chooseRandomDate:()=>Be,clockStatus:()=>Ve,configureCalendar:()=>Ze,dateToTimestamp:()=>Ke,formatDateTime:()=>Je,getAllCalendars:()=>Xe,getAllMonths:()=>Qe,getAllMoons:()=>et,getAllSeasons:()=>tt,getAllWeekdays:()=>at,getCurrentCalendar:()=>st,getCurrentDay:()=>nt,getCurrentMonth:()=>it,getCurrentSeason:()=>ot,getCurrentWeekday:()=>rt,getCurrentYear:()=>ct,getLeapYearConfiguration:()=>lt,getNotes:()=>dt,getNotesForDay:()=>ht,getTimeConfiguration:()=>mt,isPrimaryGM:()=>ut,pauseClock:()=>gt,removeNote:()=>pt,runMigration:()=>ft,searchNotes:()=>yt,secondsToInterval:()=>Ct,setDate:()=>bt,showCalendar:()=>St,startClock:()=>wt,stopClock:()=>Dt,timestamp:()=>vt,timestampPlusInterval:()=>kt,timestampToDate:()=>Mt});const t="foundryvtt-simple-calendar",s=`module.${t}`;var n,i,o,r,c,l;!function(e){e.Theme="theme",e.OpenOnLoad="open-on-load",e.OpenCompact="open-compact",e.RememberPosition="remember-position",e.AppPosition="app-position",e.CalendarConfigurationMenu="calendar-configuration-menu",e.CalendarConfiguration="calendar-configuration",e.ActiveCalendar="active-calendar",e.GlobalConfiguration="global-configuration",e.YearConfiguration="year-config",e.WeekdayConfiguration="weekday-config",e.MonthConfiguration="month-config",e.CurrentDate="current-date",e.Notes="notes",e.AllowPlayersToAddNotes="allow-players-add-notes",e.DefaultNoteVisibility="default-note-visibility",e.LeapYearRule="leap-year-rule",e.TimeConfiguration="time-configuration",e.GeneralConfiguration="general-configuration",e.SeasonConfiguration="season-configuration",e.MoonConfiguration="moon-configuration",e.NoteCategories="note-categories"}(n||(n={})),function(e){e.light="light",e.dark="dark",e.classic="classic"}(i||(i={})),function(e){e.Active="active",e.Current="current"}(o||(o={})),function(e){e.none="none",e.v1To2="v1-v2"}(r||(r={})),function(e){e.Gregorian="gregorian",e.DarkSun="darksun",e.Eberron="eberron",e.Exandrian="exandrian",e.ForbiddenLands="forbidden-lands",e.Harptos="harptos",e.GolarianPF1E="golarianpf1e",e.GolarianPF2E="golarianpf2e",e.Greyhawk="greyhawk",e.TravellerImperialCalendar="traveller-ic",e.WarhammerImperialCalendar="warhammer"}(c||(c={})),function(e){e[e.Never=0]="Never",e[e.Weekly=1]="Weekly",e[e.Monthly=2]="Monthly",e[e.Yearly=3]="Yearly"}(l||(l={}));var d,h,m,u,g,p,f,y,C,b,S,w,D,v,k,M,T,N,I,L;!function(e){e.None="none",e.Start="start",e.End="end",e.Middle="mid",e.Exact="exact"}(d||(d={})),function(e){e.None="none",e.Gregorian="gregorian",e.Custom="custom"}(h||(h={})),function(e){e.Default="default",e.Repeat="repeat",e.Random="random"}(m||(m={})),function(e){e.mainAppUpdate="main-app-update",e.primary="primary",e.clock="clock",e.checkClockRunning="check-clock-running",e.journal="journal",e.dateTimeChange="date-time-change",e.noteUpdate="note-update",e.emitHook="emit-hook",e.setActiveCalendar="set-calendar"}(u||(u={})),function(e){e.setDate="set-date",e.changeDateTime="change-date-time",e.advanceTimeToPreset="advance-time-to-preset"}(g||(g={})),function(e){e.None="none",e.Self="self",e.ThirdParty="third-party",e.Mixed="mixed"}(p||(p={})),function(e){e.None="none",e.Logo="logo",e.Clock="clock",e.Midday="midday",e.Midnight="midnight",e.Sunrise="sunrise",e.Sunset="sunset",e.NewMoon="new",e.WaxingCrescent="waxing-crescent",e.FirstQuarter="first-quarter",e.WaxingGibbous="waxing-gibbous",e.Full="full",e.WaningGibbous="waning-gibbous",e.LastQuarter="last-quarter",e.WaningCrescent="waning-crescent",e.Spring="spring",e.Summer="summer",e.Fall="fall",e.Winter="winter"}(f||(f={})),function(e){e.None="none",e.LeapYear="leap-year",e.XYears="x-years"}(y||(y={})),function(e){e.Midnight="midnight",e.Sunrise="sunrise",e.Midday="midday",e.Sunset="sunset"}(C||(C={})),function(e){e.DnD5E="dnd5e",e.PF1E="pf1",e.PF2E="pf2e",e.WarhammerFantasy4E="wfrp4e",e.Other="other"}(b||(b={})),function(e){e.DateTimeChange="simple-calendar-date-time-change",e.ClockStartStop="simple-calendar-clock-start-stop",e.PrimaryGM="simple-calendar-primary-gm",e.Ready="simple-calendar-ready"}(S||(S={})),function(e){e.Started="started",e.Stopped="stopped",e.Paused="paused"}(w||(w={})),function(e){e.Month="Month",e.Year="year"}(D||(D={})),function(e){e.previous="previous",e.next="next",e.day="day",e.year="year"}(v||(v={})),function(e){e.wheel="wheel",e.change="change",e.dropdownClick="dropdown-click"}(k||(k={})),function(e){e.seasonStartingDate="ssd",e.seasonSunriseSunsetTime="ssst",e.moonFirstNewMoonDate="mfnmd"}(M||(M={})),function(e){e.Auto="auto",e.LeftDown="left-down",e.LeftUp="left-up",e.RightDown="right-down",e.RightUp="right-up"}(T||(T={})),function(e){e.Day="day",e.Month="month",e.Year="year",e.Hour="hour",e.Minute="minute",e.Round="round",e.Second="seconds"}(N||(N={})),function(e){e[e.Date=0]="Date",e[e.Time=1]="Time",e[e.DateTime=2]="DateTime",e[e.Year=3]="Year",e[e.Month=4]="Month",e[e.Day=5]="Day"}(I||(I={})),function(e){e[e.Equal=0]="Equal",e[e.Before=1]="Before",e[e.After=2]="After",e[e.Nth=3]="Nth"}(L||(L={}));class O{static on(e){const t=game.socket;t&&t.on(s,e)}static async emit(e){const t=game.socket;return!!t&&(await t.emit(s,e),!0)}}class A{static info(e){e&&console.info("%cSimple Calendar","color:blue;",` | ${e}`)}static warn(e){e&&console.warn("%cSimple Calendar","color:orange;",` | ${e}`)}static error(e){e instanceof Error?console.error("%cSimple Calendar","color:red;",` | Error "${e.message}"\n${e.stack}`):console.error("%cSimple Calendar","color:red;",` | ${e}`)}static debug(e){e&&A.debugMode&&console.debug("%cSimple Calendar","color:green;",` | ${e}`)}}A.debugMode=!1;class R{constructor(){}async initialize(){return!0}async process(e,t){return!1}}function F(e){return e&&"object"==typeof e&&!Array.isArray(e)}function j(e){return e&&0===Object.keys(e).length&&Object.getPrototypeOf(e)===Object.prototype}function P(e,...t){if(!t.length)return e;const a=t.shift();if(F(e)&&F(a))for(const t in a)F(a[t])?(e[t]||Object.assign(e,{[t]:{}}),P(e[t],a[t])):Object.assign(e,{[t]:a[t]});return P(e,...t)}let Y,x,E,W,$,G;class q{static IsGm(){const e=game.user;return!!e&&e.isGM}static UserName(){const e=game.user;return e&&e.name?e.name:""}static UserID(){const e=game.user;return e&&e.id?e.id:""}static GetUser(e){const t=game.users;if(t)return t.find((t=>t.id===e))}static GetModuleVersion(){const e=game.modules.get(t);return e?e.data.version:""}static Localize(e){if(game.i18n)return game.i18n.localize(e);{const t=e.split(".");return t[t.length-1]}}static GetBooleanSettings(e){return game.settings.get(t,e)}static GetObjectSettings(e){return game.settings.get(t,e)}static GetStringSettings(e){return game.settings.get(t,e)}static async SaveBooleanSetting(e,a,s=!0){let n=!1;return s?this.IsGm()&&(n=!0):n=!0,!!n&&await game.settings.set(t,e,a).then((()=>!0))}static async SaveStringSetting(e,a,s=!0){let n=!1;return s?this.IsGm()&&(n=!0):n=!0,!!n&&await game.settings.set(t,e,a).then((()=>!0))}static async SaveObjectSetting(e,a,s=!0){let n=!1;if(s?this.IsGm()&&(n=!0):n=!0,n){const s=q.GetObjectSettings(e);if(JSON.stringify(a)!==JSON.stringify(s))return await game.settings.set(t,e,a).then((()=>!0))}return!1}static UiNotification(e,t="info"){ui.notifications?"info"===t?ui.notifications.info(e):"warn"===t?ui.notifications.warn(e):"error"===t&&ui.notifications.error(e):A.error("The UI class is not initialized.")}static GetSceneForCombatCheck(){let e=null;const t=game.scenes;return t&&($.globalConfiguration.combatPauseRule===o.Active?e=t.active||null:$.globalConfiguration.combatPauseRule===o.Current&&(e=t.current||null)),e}}function U(){return window.crypto.getRandomValues(new Uint32Array(1))[0].toString(16)}function z(e){return[void 0,q.Localize("FSC.OrdinalSuffix.st"),q.Localize("FSC.OrdinalSuffix.nd"),q.Localize("FSC.OrdinalSuffix.rd")][e%100>>3^1&&e%10]||q.Localize("FSC.OrdinalSuffix.th")}function H(e,t){const a=e.split("."),s=t.split("."),n=Math.max(a.length,s.length);for(let e=0;e<n;e++){if(a[e]&&!s[e]&&parseInt(a[e])>0||parseInt(a[e])>parseInt(s[e]))return 1;if(s[e]&&!a[e]&&parseInt(s[e])>0||parseInt(a[e])<parseInt(s[e]))return-1}return 0}function _(e,t=1){if(e<Math.pow(10,t)){const a=t-(Math.log(e)*Math.LOG10E|0);return`${"0".repeat(a)}${e}`}return`${e}`}class B{static getWorldCreateSeconds(e,t=!0){let a=0;if(game.hasOwnProperty("pf2e")){let s=Math.floor(game.pf2e.worldClock.worldCreatedOn/1e3);"AR"!==game.pf2e.worldClock.dateTheme&&"IC"!==game.pf2e.worldClock.dateTheme||(s+=62167219200),a+=s,!t&&H(game.system.data.version,B.worldClockCodeChangeVersion)>0&&H(game.system.data.version,B.worldClockCodeChangeBackVersion)<=0?a+=e.time.secondsPerDay:t&&(H(game.system.data.version,B.worldClockCodeChangeVersion)<=0||H(game.system.data.version,B.worldClockCodeChangeBackVersion)>=0)&&(a-=e.time.secondsPerDay)}return a}static newYearZero(){let e;return game.hasOwnProperty("pf2e")&&("AD"===game.pf2e.worldClock.dateTheme?e=H(game.system.data.version,B.worldClockCodeChangeVersion)>0&&H(game.system.data.version,B.worldClockCodeChangeBackVersion)<=0?1970:1875:"CE"===game.pf2e.worldClock.dateTheme?e=1970:"AR"===game.pf2e.worldClock.dateTheme&&(e=H(game.system.data.version,B.worldClockCodeChangeVersion)>0&&H(game.system.data.version,B.worldClockCodeChangeBackVersion)<=0?0:2700)),e}static checkLeapYearRules(e){"AD"!==game.pf2e.worldClock.dateTheme&&"CE"!==game.pf2e.worldClock.dateTheme&&"AR"!==game.pf2e.worldClock.dateTheme||(e.rule=h.Gregorian)}static weekdayAdjust(){let e;return"CE"===game.pf2e.worldClock.dateTheme||"AD"===game.pf2e.worldClock.dateTheme?e=4:"AR"===game.pf2e.worldClock.dateTheme&&(e=H(game.system.data.version,B.worldClockCodeChangeBackVersion)>0?6:5),e}}function V(e,t,a,s={}){s=P({year:!1,month:!1},s);const n=/DO|d{1,4}|M{1,4}|YN|YA|YZ|YY(?:YY)?|([HhMmsD])\1?|[aA]/g,i={D:e=>String(a.months[e.month].days[e.day].numericRepresentation),DD:e=>_(a.months[e.month].days[e.day].numericRepresentation),DO:e=>`${String(a.months[e.month].days[e.day].numericRepresentation)}${z(a.months[e.month].days[e.day].numericRepresentation)}`,d:e=>String(a.weekdays[a.dayOfTheWeek(e.year,e.month,e.day)].numericRepresentation),dd:e=>_(a.weekdays[a.dayOfTheWeek(e.year,e.month,e.day)].numericRepresentation),ddd:e=>`${a.weekdays[a.dayOfTheWeek(e.year,e.month,e.day)].abbreviation}`,dddd:e=>`${a.weekdays[a.dayOfTheWeek(e.year,e.month,e.day)].name}`,M:e=>String(a.months[e.month].numericRepresentation),MM:e=>_(a.months[e.month].numericRepresentation),MMM:e=>a.months[e.month].abbreviation,MMMM:e=>a.months[e.month].name,YN:e=>a.year.getYearName(e.year),YA:e=>a.year.prefix,YZ:e=>a.year.postfix,YY:e=>s.year?`<input type="number" style="width:4ch;" value="${_(e.year,2).substring(2)}" />`:_(e.year,2).substring(2),YYYY:e=>s.year?`<input type="number" style="width:${String(e.year).length+2}ch;" value="${e.year}" />`:String(e.year),H:e=>String(e.hour),HH:e=>_(e.hour),h:e=>{const t=Math.floor(a.time.hoursInDay/2),s=e.hour%t||t;return String(s)},hh:e=>{const t=Math.floor(a.time.hoursInDay/2);return _(e.hour%t||t)},m:e=>String(e.minute),mm:e=>_(e.minute),s:e=>String(e.seconds),ss:e=>_(e.seconds),A:e=>{const t=Math.floor(a.time.hoursInDay/2);return e.hour>=t?"PM":"AM"},a:e=>{const t=Math.floor(a.time.hoursInDay/2);return e.hour>=t?"pm":"am"}},o=[];t=t.replace(/\[([^]*?)\]/gm,(function(e,t){return o.push(t),"@@@"}));try{return(t=t.replace(n,(t=>i[t](e)))).replace(/@@@/g,(()=>o.shift()))}catch(e){return A.error(e),""}}function Z(e,t,a,s,n=!0){let i=e.dateToDays(t,a,s,!0,!0),o=e.time.getTotalSeconds(i,n);if(e.gameSystem===b.PF2E&&e.generalSettings.pf2eSync){const r=B.newYearZero();void 0!==r&&(e.year.yearZero=r,i=e.dateToDays(t,a,s,!0,!0)),i++,o=e.time.getTotalSeconds(i,n)-B.getWorldCreateSeconds(e,!1)}return o}function K(e,t,a,s,n=!1,i=!0,o="-"){const r=e.generalSettings.dateFormat.time.replace(/:?[s]/g,"");let c=e.generalSettings.dateFormat.date;i||(c=c.replace(/[,.\/\\\s]*?(YN|YA|YZ|YY(?:YY)?)/g,""));let l="",d="";return J(t,a)?n||(l=`${c}`):(l=`${c}`,d=`${c}`),s||(l+=` ${r}`),s||t.hour===a.hour&&t.minute===a.minute||(d+=` ${r}`),""!==d&&(d=` ${o} ${d}`),`${V(t,l,e)}${V(a,d,e)}`}function J(e,t){return e.year===t.year&&e.month==t.month&&e.day===t.day}function X(e,t,a){const s=e.dateToDays(t.year,t.month,t.day);return e.dateToDays(a.year,a.month,a.day)-s}function Q(e,t,a,s){let n=d.None,i=Z(e,t.year,t.month,t.day,!1),o=Z(e,a.year,a.month,a.day,!1),r=Z(e,s.year,s.month,s.day,!1);return i===o&&i===r?n=d.Exact:i===o?n=d.Start:i===r?n=d.End:i<r&&i>o&&(n=d.Middle),n}function ee(e,t){const a={year:0,month:0,dayOffset:0,day:0,dayOfTheWeek:0,hour:0,minute:0,second:0,yearZero:0,sunrise:0,sunset:0,midday:0,weekdays:[],showWeekdayHeadings:!0,currentSeason:{id:"",name:"",color:"",icon:f.None,sunsetTime:0,sunriseTime:0,startingDay:0,startingMonth:0},isLeapYear:!1,display:{date:"",day:"",daySuffix:"",weekday:"",monthName:"",month:"",year:"",yearName:"",yearPrefix:"",yearPostfix:"",time:""}};t.gameSystem===b.PF2E&&t.generalSettings.pf2eSync&&(e+=B.getWorldCreateSeconds(t));const s=t.secondsToDate(e);a.year=s.year,a.month=s.month,a.day=s.day,a.hour=s.hour,a.minute=s.minute,a.second=s.seconds;const n=t.months[s.month],i=n.days[s.day];return a.dayOffset=n.numericRepresentationOffset,a.yearZero=t.year.yearZero,a.dayOfTheWeek=t.dayOfTheWeek(a.year,a.month,a.day),a.currentSeason=t.getSeason(a.month,a.day+1),a.weekdays=t.weekdays.map((e=>e.name)),a.showWeekdayHeadings=t.year.showWeekdayHeadings,a.isLeapYear=t.year.leapYearRule.isLeapYear(a.year),a.sunrise=t.getSunriseSunsetTime(a.year,a.month,a.day,!0),a.sunset=t.getSunriseSunsetTime(a.year,a.month,a.day,!1),a.midday=te({year:a.year,month:a.month,day:a.day,hour:0,minute:0,seconds:0},t)+Math.floor(t.time.secondsPerDay/2),a.display.year=s.year.toString(),a.display.yearName=t.year.getYearName(a.year),a.display.yearPrefix=t.year.prefix,a.display.yearPostfix=t.year.postfix,a.display.month=n.numericRepresentation.toString(),a.display.monthName=n.name,t.weekdays.length>a.dayOfTheWeek&&(a.display.weekday=t.weekdays[a.dayOfTheWeek].name),a.display.day=i.numericRepresentation.toString(),a.display.daySuffix=z(i.numericRepresentation),a.display.time=V({year:a.year,month:a.month,day:a.day,hour:a.hour,minute:a.minute,seconds:a.second},t.generalSettings.dateFormat.time,t),a.display.date=V({year:a.year,month:a.month,day:a.day,hour:a.hour,minute:a.minute,seconds:a.second},t.generalSettings.dateFormat.date,t),a}function te(e,t){let a=0;const s=t.clone(!1),n=s.months.findIndex((e=>e.current)),i=s.time.getCurrentTime();if(void 0===e.seconds&&(e.seconds=i.seconds),void 0===e.minute&&(e.minute=i.minute),void 0===e.hour&&(e.hour=i.hour),void 0===e.year&&(e.year=s.year.numericRepresentation),void 0===e.month&&(e.month=n>-1?n:0),void 0===e.day&&(e.day=0,n>-1)){const t=s.months[n].days.findIndex((e=>e.current));e.day=t>-1?t:0}return s.updateMonth(e.month,"current",!0,e.day),s.year.numericRepresentation=e.year,s.time.setTime(e.hour,e.minute,e.seconds),a=s.toSeconds(),a}async function ae(e,t){if(t){let a=0,s=0;if(e===C.Sunrise||e===C.Sunset){let n=t.getMonthAndDayIndex();a=t.getSunriseSunsetTime(t.year.numericRepresentation,n.month||0,n.day||0,e===C.Sunrise,!1),s=a-t.time.seconds}else e===C.Midday?s=Math.floor(t.time.secondsPerDay/2)-t.time.seconds:e===C.Midnight&&(s=t.time.secondsPerDay-t.time.seconds);if(s<=0&&(s+=t.time.secondsPerDay),t.changeDateTime({seconds:s},{updateApp:!1,showWarning:!0}),e===C.Sunrise||e===C.Sunset){let n=t.getMonthAndDayIndex();a=t.getSunriseSunsetTime(t.year.numericRepresentation,n.month||0,n.day||0,e===C.Sunrise,!1),a!==t.time.seconds&&(s=a-t.time.seconds,t.changeDateTime({seconds:s},{updateApp:!1,showWarning:!0}))}}}B.worldClockCodeChangeVersion="2.14.4.8167",B.worldClockCodeChangeBackVersion="3.0.1";function se(e){let t="#000000";if(0===e.indexOf("#")&&(e=e.slice(1)),3===e.length||6===e.length){3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);t=.299*parseInt(e.slice(0,2),16)+.587*parseInt(e.slice(2,4),16)+.114*parseInt(e.slice(4,6),16)>186?"#000000":"#FFFFFF"}return t}function ne(e,t="#000000",a="#000000"){let s="",n=/fill="#000000"/g;switch(e){case f.Logo:s='<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 163.632 179.888" width="163.632" height="179.888" xmlns="http://www.w3.org/2000/svg" xmlns:bx="https://boxy-svg.com">\n  <g style="" transform="matrix(1.109639, 0, 0, 1.109639, -25.722576, 0.588635)">\n    <path style="paint-order: fill; stroke: rgb(0, 0, 0); stroke-width: 0.901194px; fill: rgb(26, 51, 68);" d="M 27.687 51.087 H 165.041 V 138.185 A 18.993 18.993 0 0 1 146.048 157.178 H 49.975 A 22.288 22.288 0 0 1 27.687 134.89 V 51.087 Z" bx:shape="rect 27.687 51.087 137.354 106.091 0 0 18.993 22.288 1@cbaa1f8b"/>\n    <path style="fill: rgb(60, 118, 158); stroke: rgb(0, 0, 0); stroke-width: 0.901194px;" d="M 38.13 15.855 H 154.421 A 10.683 10.683 0 0 1 165.104 26.538 V 51.06 H 27.721 V 26.264 A 10.409 10.409 0 0 1 38.13 15.855 Z" bx:shape="rect 27.721 15.855 137.383 35.205 10.409 10.683 0 0 1@30307c42"/>\n    <ellipse style="fill: rgb(26, 70, 112);" cx="53.467" cy="33.021" rx="6.84" ry="6.498"/>\n    <ellipse style="fill: rgb(26, 70, 112);" cx="139.291" cy="33.007" rx="6.84" ry="6.498"/>\n    <rect x="49.037" y="3.983" width="9.076" height="31.905" style="fill: rgb(216, 216, 216); stroke-width: 0.930572px; stroke: rgb(0, 0, 0);" rx="3.013" ry="3.013"/>\n    <rect x="134.781" y="3.975" width="9.076" height="31.905" style="fill: rgb(216, 216, 216); stroke-width: 0.930572px; stroke: rgb(0, 0, 0);" rx="3.013" ry="3.013"/>\n    <g transform="matrix(0.006346, 0, 0, -0.006346, 72.998573, 44.807747)" fill="#000000" stroke="none" style="">\n      <path d="M 2062 3457.803 C 2046 3441.803 2045 1808.803 2060 1762.803 C 2074 1722.803 2113 1702.803 2305 1634.803 C 2393 1603.803 2502 1558.803 2548 1533.803 L 2630 1489.803 L 4945 1488.803 L 5030 1530.803 C 5083 1555.803 5162 1582.803 5240 1600.803 C 5309 1616.803 5377 1634.803 5391 1640.803 C 5427 1654.803 5465 1697.803 5479 1738.803 C 5495 1788.803 5495 3440.803 5478 3457.803 C 5469 3466.803 5355 3469.803 5028 3469.803 L 4590 3469.803 L 4430 3469.803 L 3785 3469.803 L 3140 3469.803 L 2990 3469.803 L 2532 3469.803 C 2189 3469.803 2071 3466.803 2062 3457.803 Z" style=""/>\n      <path d="M 440 3270.803 C 392 3265.803 384 3260.803 367 3231.803 C 348 3198.803 348 3194.803 364 3066.803 C 382 2927.803 496 2346.803 511 2317.803 C 534 2274.803 629 2241.803 1140 2104.803 C 1412 2030.803 1950 1899.803 1979 1899.803 C 1990 1899.803 2000 1908.803 2004 1922.803 C 2007 1934.803 2010 2237.803 2010 2596.803 C 2010 3175.803 2008 3249.803 1994 3263.803 C 1980 3277.803 1899 3279.803 1237 3277.803 C 829 3276.803 470 3273.803 440 3270.803 Z" style=""/>\n      <path d="M 5572 3257.803 C 5556 3241.803 5554 1858.803 5571 1827.803 C 5585 1801.803 5582 1801.803 5927 1899.803 C 6490 2058.803 6711 2137.803 7060 2305.803 C 7378 2457.803 7619 2604.803 7840 2782.803 C 8106 2996.803 8216 3187.803 8107 3246.803 C 8077 3263.803 7999 3264.803 6830 3267.803 C 5861 3269.803 5582 3267.803 5572 3257.803 Z" style=""/>\n      <path d="M 2740 1352 C 2629 1135 2469 950 2268 810 C 2209 769 2158 727 2155 717 C 2137 668 2055 670 3789 670 C 5450 670 5430 670 5430 707 C 5430 713 5352 781 5258 857 C 4985 1075 4902 1166 4810 1350 C 4792 1386 4777 1416 4775 1418 C 4774 1419 2795 1440 2791 1440 C 2788 1440 2765 1401 2740 1352 Z" style=""/>\n      <path d="M1902 628 c-17 -17 -17 -529 0 -546 9 -9 447 -12 1909 -12 1735 0 1899 1 1914 16 14 14 16 48 13 276 -3 217 -5 260 -18 268 -24 15 -3803 13 -3818 -2z" style=""/>\n    </g>\n    <path d="M 76.481 119.745 C 76.481 117.167 75.57 115.183 73.753 113.807 C 71.935 112.429 68.656 110.971 63.928 109.443 C 59.194 107.905 55.449 106.397 52.691 104.911 C 45.171 100.847 41.411 95.378 41.411 88.491 C 41.411 84.913 42.415 81.725 44.436 78.917 C 46.454 76.114 49.346 73.918 53.123 72.34 C 56.9 70.767 61.136 69.975 65.838 69.975 C 70.568 69.975 74.783 70.833 78.483 72.547 C 82.18 74.26 85.055 76.679 87.101 79.804 C 89.148 82.927 90.173 86.472 90.173 90.446 L 76.527 90.446 C 76.527 87.415 75.57 85.056 73.663 83.373 C 71.752 81.692 69.064 80.85 65.61 80.85 C 62.275 80.85 59.681 81.554 57.833 82.963 C 55.982 84.377 55.058 86.233 55.058 88.534 C 55.058 90.69 56.14 92.495 58.311 93.95 C 60.476 95.404 63.67 96.766 67.885 98.046 C 75.649 100.377 81.304 103.275 84.85 106.728 C 88.402 110.188 90.173 114.5 90.173 119.648 C 90.173 125.383 88.005 129.874 83.673 133.136 C 79.33 136.398 73.493 138.029 66.151 138.029 C 61.06 138.029 56.424 137.098 52.237 135.23 C 48.05 133.367 44.855 130.812 42.659 127.568 C 40.462 124.324 39.361 120.559 39.361 116.284 L 53.055 116.284 C 53.055 123.593 57.422 127.249 66.151 127.249 C 69.401 127.249 71.935 126.587 73.753 125.267 C 75.57 123.953 76.481 122.11 76.481 119.745 Z M 151.384 115.057 C 150.87 122.184 148.235 127.794 143.49 131.888 C 138.748 135.982 132.493 138.029 124.724 138.029 C 116.234 138.029 109.553 135.171 104.69 129.454 C 99.822 123.736 97.391 115.886 97.391 105.914 L 97.391 101.865 C 97.391 95.497 98.512 89.886 100.753 85.032 C 103 80.18 106.209 76.459 110.378 73.866 C 114.546 71.277 119.39 69.975 124.909 69.975 C 132.547 69.975 138.709 72.024 143.376 76.116 C 148.048 80.213 150.746 85.956 151.476 93.357 L 137.826 93.357 C 137.493 89.084 136.305 85.979 134.258 84.055 C 132.209 82.128 129.095 81.169 124.909 81.169 C 120.359 81.169 116.959 82.795 114.699 86.054 C 112.435 89.317 111.277 94.372 111.218 101.228 L 111.218 106.236 C 111.218 113.389 112.304 118.619 114.469 121.924 C 116.634 125.231 120.056 126.881 124.724 126.881 C 128.94 126.881 132.088 125.921 134.165 123.996 C 136.241 122.069 137.434 119.091 137.738 115.057 Z" style="fill: rgb(225, 180, 56); line-height: 25.051px; stroke: rgb(0, 0, 0); white-space: pre;"/>\n  </g>\n</svg>';break;case f.Clock:s='<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">\n    <path fill="#000000" d="M50 92.5C26.6 92.5 7.5 73.4 7.5 50S26.6 7.5 50 7.5 92.5 26.6 92.5 50 73.4 92.5 50 92.5zm0-79.3c-20.3 0-36.8 16.5-36.8 36.8S29.7 86.8 50 86.8 86.8 70.3 86.8 50 70.3 13.2 50 13.2z"/>\n    <path id="c_arm_s" fill="#000000" d="M65.7 26.4c.5-.9.2-2-.7-2.5s-2-.2-2.5.6l-15 24c0 .1-.1.1-.1.2-.4.7-.4 1.6-.1 2.3.2.6.7 1.1 1.2 1.4.2.1.3.2.5.2 1.3.4 2.8-.2 3.5-1.5l13.2-24.7z"/>\n    <path id="c_arm_m" fill="#000000" d="M60.02350382678833,34.42733963723822 C60.37102334373321,33.801804506737426 60.16251163356629,33.03726156945868 59.53697650306549,32.68974205251379 S58.14689843528595,32.55073424573584 57.79937891834106,33.106765472847655 L47.373793409994505,49.78770228620215 C47.373793409994505,49.857206189591125 47.30428950660553,49.857206189591125 47.30428950660553,49.9267100929801 C47.02627389304962,50.41323741670294 47.02627389304962,51.038772547203735 47.23478560321655,51.525299870926574 C47.373793409994505,51.942323291260436 47.72131292693939,52.28984280820532 48.068832443884276,52.49835451837225 C48.20784025066223,52.56785842176123 48.27734415405121,52.63736232515021 48.41635196082916,52.63736232515021 C49.31990270488586,52.915377938706115 50.36246125572052,52.49835451837225 50.84898857944336,51.59480377431555 L60.02350382678833,34.42733963723822 z"/>\n</svg>';break;case f.Midday:s='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49">\n    <circle cx="24.534" cy="24.483" r="10.5" stroke="#000000" stroke-miterlimit="10" stroke-width="0.5" fill="#000000"/>\n    <path d="M 24.5 8.21 L 24.5 2 M 24.5 47 L 24.5 40.79 M 36.02 12.98 L 40.41 8.59 M 8.59 40.41 L 12.98 36.02 M 12.98 13.02 L 8.59 8.63 M 40.41 40.41 L 36.02 36.02 M 8.21 24.5 L 2 24.5 M 47 24.5 L 40.79 24.5" fill="none" stroke="#000000" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3"/>\n</svg>';break;case f.Midnight:s='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49">\n    <path d="M 38.767 28.7 C 29.562 28.767 22.048 21.355 21.987 12.15 C 21.991 10.749 22.176 9.354 22.537 8 C 9.887 9.573 3.682 24.25 11.369 34.42 C 19.057 44.589 34.87 42.624 39.833 30.882 C 40.146 30.141 40.405 29.379 40.607 28.6 C 39.997 28.66 39.387 28.7 38.767 28.7 Z" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="0.5" fill="#000000"/>\n</svg>';break;case f.Sunrise:s='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49">\n    <defs>\n        <clipPath id="a">\n            <rect y="7.5" width="64" height="32" fill="none"/>\n        </clipPath>\n    </defs>\n    <g clip-path="url(#a)" transform="matrix(1, 0, 0, 1, -7.5, -12.5)">\n        <circle cx="32" cy="39" r="10.5" stroke="#000000" stroke-miterlimit="10" stroke-width="0.5" fill="#000000"/>\n        <path d="M32,22.71V16.5m0,45V55.29M43.52,27.48l4.39-4.39M16.09,54.91l4.39-4.39m0-23-4.39-4.39M47.91,54.91l-4.39-4.39M15.71,39H9.5m45,0H48.29" fill="none" stroke="#000000" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3"/>\n    </g>\n    <line x1="8.33" y1="30.091" x2="40.692" y2="30.091" fill="none" stroke="#000000" stroke-linecap="round" stroke-width="2"/>\n    <path d="M 18.308 40.395 L 22.673 40.395 L 22.673 45.795 L 30.632 38.595 L 22.673 31.396 L 22.673 36.793 L 18.308 36.793 L 18.308 40.395 Z" fill="#000000" stroke="#000000" style="" transform="matrix(0, -1, 1, 0, -14.125499, 63.065498)"/>\n</svg>';break;case f.Sunset:s='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49">\n    <defs>\n        <clipPath id="a">\n            <rect y="7.5" width="64" height="32" fill="none"/>\n        </clipPath>\n    </defs>\n    <g clip-path="url(#a)" transform="matrix(1, 0, 0, 1, -7.5, -12.5)">\n        <circle cx="32" cy="39" r="10.5" stroke="#000000" stroke-miterlimit="10" stroke-width="0.5" fill="#000000"/>\n        <path d="M32,22.71V16.5m0,45V55.29M43.52,27.48l4.39-4.39M16.09,54.91l4.39-4.39m0-23-4.39-4.39M47.91,54.91l-4.39-4.39M15.71,39H9.5m45,0H48.29" fill="none" stroke="#000000" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3"/>\n    </g>\n    <line x1="8.33" y1="30.091" x2="40.692" y2="30.091" fill="none" stroke="#000000" stroke-linecap="round" stroke-width="2"/>\n    <path d="M 18.308 40.395 L 22.673 40.395 L 22.673 45.795 L 30.632 38.595 L 22.673 31.396 L 22.673 36.793 L 18.308 36.793 L 18.308 40.395 Z" fill="#000000" stroke="#000000" style="" transform="matrix(0, 1, -1, 0, 63.065498, 14.125499)"/>\n</svg>';break;case f.FirstQuarter:s='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="16.217882" cy="42.249027" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(-24)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 31.651447,14.498703 c 0.04016,34.977641 0.01944,27.709462 0.04016,34.977641 9.74162,0.07836 17.711025,-7.738374 17.821085,-17.479687 C 49.412665,22.232359 41.41574,14.398087 31.651447,14.498703 Z"/></svg>\n',n=/fill="#ffffff"/g;break;case f.Full:s='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="17.5" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>\n',n=/fill="#ffffff"/g;break;case f.LastQuarter:s='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="-16.217882" cy="-42.249027" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(156)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 32.348553,49.501297 c -0.04016,-34.977641 -0.01944,-27.709462 -0.04016,-34.977641 -9.74162,-0.07836 -17.711025,7.738374 -17.821085,17.479687 0.100027,9.764298 8.096952,17.59857 17.861245,17.497954 z"/></svg>\n',n=/fill="#ffffff"/g;break;case f.NewMoon:s='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>\n',n=/fill="#ffffff"/g;break;case f.WaningCrescent:s='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="42.249027" cy="16.217882" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(24)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 34.422458,49.301058 c -15.451442,-6.354 -15.456399,-28.248933 0.0034,-34.599957 v 0 l 0.09749,-0.02227 a 18.38,18.38 0 0 0 -2.524032,-0.182384 17.508125,17.508125 45 1 0 -0.0026,35.016249 18.21,18.21 0 0 0 2.521223,-0.180096 z"/></svg>\n',n=/fill="#ffffff"/g;break;case f.WaningGibbous:s='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="42.249027" cy="16.217882" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(24)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 38.163354,44.316704 C 30.937776,37.984029 30.507493,28.490768 36.581412,21.046356 39.089436,18.621787 39.94547,18.422461 41.135375,17.578924 33.984048,12.487765 24.11729,13.768992 18.50341,20.51775 c -6.096193,7.464693 -5.157206,18.422603 2.120091,24.741318 5.853103,5.207431 14.525266,5.687523 20.917408,1.15799 z"/></svg>\n',n=/fill="#ffffff"/g;break;case f.WaxingCrescent:s='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="-42.249027" cy="-16.217882" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(-156)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 29.577542,14.698942 c 15.451442,6.354 15.456399,28.248933 -0.0034,34.599957 v 0 l -0.09749,0.02227 a -18.38,-18.38 0 0 0 2.524032,0.182384 17.508125,17.508125 0 1 0 0.0026,-35.016249 -18.21,-18.21 0 0 0 -2.521223,0.180096 z"/></svg>\n',n=/fill="#ffffff"/g;break;case f.WaxingGibbous:s='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="-42.249027" cy="-16.217882" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(-156)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 25.836646,19.683296 c 7.225578,6.332675 7.655861,15.825936 1.581942,23.270348 -2.508024,2.424569 -3.364058,2.623895 -4.553963,3.467432 7.151327,5.091159 17.018085,3.809932 22.631965,-2.938826 6.096193,-7.464693 5.157206,-18.422603 -2.120091,-24.741318 -5.853103,-5.207431 -14.525266,-5.687523 -20.917408,-1.15799 z"/></svg>\n',n=/fill="#ffffff"/g;break;case f.Spring:s=`<span class="fa fa-seedling" style="color:${t};"></span>`;break;case f.Summer:s=`<span class="fa fa-sun" style="color:${t};"></span>`;break;case f.Fall:s=`<span class="fa fa-leaf" style="color:${t};"></span>`;break;case f.Winter:s=`<span class="fa fa-snowflake" style="color:${t};"></span>`}return s=s.replace(/stroke="#000000"/g,`stroke="${t}"`),s=s.replace(n,`fill="${a}"`),s}function ie(e,t,a=!1){let s=!1;return e&&!e.classList.contains("fsc-a")&&(e.classList.contains("fsc-b")||a?(e.classList.add("fsc-a"),e.classList.remove("fsc-b"),s=!1,setTimeout(oe.bind(null,e,!0,"fsc-c"),t)):(e.classList.add("fsc-a","fsc-b"),e.classList.remove("fsc-c"),s=!0),setTimeout(oe.bind(null,e,!1,"fsc-a"),t)),s}function oe(e,t,a){t?e.classList.add(a):e.classList.remove(a)}function re(e,t,a=document){const s=a.querySelector(e)?.closest(".form-group");s&&(s.classList.contains("fsc-c")&&t||s.classList.contains("fsc-b")&&!t?ie(s,200):t?(s.classList.remove("fsc-c"),s.classList.add("fsc-b")):(s.classList.add("fsc-c"),s.classList.remove("fsc-b")))}class ce{static GenerateNoteIconTitle(e,t){let a=`${e} ${q.Localize("FSC.Configuration.General.Notes")}`;if(t.length<3){a=q.Localize("FSC.Configuration.General.Notes")+":\n";for(let e=0;e<t.length;e++){0!==e&&(a+="\n");a+=`${t[e].title.replace(/"/g,"&quot;")}`}}return a}}class le{static Render(e,t={id:""}){let a="";if((t=P({},this.defaultOptions,t)).view===D.Month)a=this.Build(e,t);else if(t.view===D.Year){a='<div class="fsc-d">',t.showYear=!1,t.allowChangeMonth=!1;for(let s=0;s<e.months.length;s++)t.date={year:e.year.visibleYear,month:s,day:0},a+=this.Build(e,t);a+="</div>"}if("none"!==t.theme){a=`<div class="simple-calendar ${"auto"===t.theme?$.clientSettings.theme:t.theme}">${a}</div>`}return a}static Build(e,t){let a=e.generalSettings.dateFormat.monthYear;t.showYear||(a=a.replace(/YN|YA|YZ|YY(?:YY)?/g,""));let s,n,i,o,r,c,l,h=0,m=[],u="",g="",p="";if(t.date?(t.date.month>=0&&t.date.month<e.months.length&&(h=t.date.month),s=t.date.year):(s=e.year.visibleYear,h=e.getMonthIndex("visible")),m=e.daysIntoWeeks(h,s,e.weekdays.length),t.selectedDates?(n=t.selectedDates.start.year,r=t.selectedDates.end.year,i=t.selectedDates.start.month>0&&t.selectedDates.start.month<e.months.length?t.selectedDates.start.month:0,c=t.selectedDates.end.month>0&&t.selectedDates.end.month<e.months.length?t.selectedDates.end.month:0,o=t.selectedDates.start.day||0,l=t.selectedDates.end.day||0):(n=r=e.year.selectedYear,i=c=e.getMonthIndex("selected"),i>-1&&(o=l=e.months[i].getDayIndex("selected"))),t.showSeasonName||t.colorToMatchSeason){const t=e.getSeason(h,o||0);p=t.name,g=ne(t.icon,t.color,t.color),u=`border-color: ${t.color};`}let f=`<div id="${t.id}" class="fsc-e ${t.cssClasses}" style="${t.colorToMatchSeason?u:""}" data-calendar="${e.id}">`;f+=`<input class="fsc-f" type="hidden" value="${encodeURIComponent(JSON.stringify(t))}"/>`,f+='<div class="fsc-g">',f+='<div class="fsc-h">',t.allowChangeMonth?f+=`<a class="fa fa-chevron-left" title="${q.Localize("FSC.ChangePreviousMonth")}"></a>`:f+="<span></span>",f+=`<span class="fsc-i" data-visible="${h}/${s}">${V({year:s,month:h,day:0,hour:0,minute:0,seconds:0},a,e,{year:t.editYear})}</span>`,t.allowChangeMonth?f+=`<a class="fa fa-chevron-right" title="${q.Localize("FSC.ChangeNextMonth")}"></a>`:f+="<span></span>",f+="</div>",t.showSeasonName&&(f+=`<div class="fsc-j">${g}${p}</div>`),e.year.showWeekdayHeadings&&(f+=`<div class="fsc-k">${e.weekdays.map((e=>`<div class="fsc-l" title="${e.name}">${e.abbreviation}</div>`)).join("")}</div>`),f+="</div>",f+='<div class="fsc-m">';for(let a=0;a<m.length;a++)if(m[a]){f+='<div class="fsc-n">';for(let u=0;u<m[a].length;u++)if(m[a][u]){let g="fsc-o";const p=e.months[h].days.findIndex((e=>e.numericRepresentation===m[a][u].numericRepresentation));if(void 0!==i&&void 0!==o&&void 0!==c&&void 0!==l){switch(Q(e,{year:t.showYear?s:0,month:h,day:p,hour:0,minute:0,seconds:0},{year:n,month:i,day:o,hour:0,minute:0,seconds:0},{year:r,month:c,day:l,hour:0,minute:0,seconds:0})){case d.Exact:g+=" fsc-p",m[a][u].selected=!0;break;case d.Start:g+=" fsc-p fsc-q";break;case d.Middle:g+=" fsc-p fsc-r";break;case d.End:g+=" fsc-p fsc-s"}}t.showCurrentDate&&s===e.year.numericRepresentation&&m[a][u].current&&(g+=" fsc-t"),f+=`<div class="${g}" data-day="${p}">`,t.showNoteCount&&(f+=`<div class="fsc-u">${le.NoteIndicator(e,s,h,p)}</div>`),f+=m[a][u].name,t.showMoonPhases&&(f+=`<div class="fsc-v">${le.MoonPhaseIcons(e,s,h,p,0!==u&&u===m[a].length-1,a===m.length-1)}</div>`),f+="</div>"}else f+='<div class="fsc-w"></div>';f+="</div>"}return f+="</div>",f+="</div>",f}static ActivateListeners(e,t=null,a=null,s=null){const n=document.getElementById(e);if(n){const i=n.querySelector(".fsc-g .fsc-h .fa-chevron-left");i&&i.addEventListener("click",le.EventListener.bind(le,e,v.previous,{onMonthChange:t,onDayClick:a,onYearChange:s}));const o=n.querySelector(".fsc-g .fsc-h .fa-chevron-right");o&&o.addEventListener("click",le.EventListener.bind(le,e,v.next,{onMonthChange:t,onDayClick:a,onYearChange:s}));const r=n.querySelector(".fsc-g .fsc-h .fsc-i input[type=number]");r&&(r.addEventListener("click",(e=>e.preventDefault())),r.addEventListener("change",le.EventListener.bind(le,e,v.year,{onMonthChange:t,onDayClick:a,onYearChange:s}))),n.querySelectorAll(".fsc-m .fsc-o").forEach((n=>{n.addEventListener("click",le.EventListener.bind(le,e,v.day,{onMonthChange:t,onDayClick:a,onYearChange:s}))}))}}static EventListener(e,t,a,s){s.stopPropagation();const n=document.getElementById(e);if(n){const e=n.getAttribute("data-calendar")||"",i=Y.getCalendar(e);if(i){let e={id:""};const o=n.querySelector(".fsc-f");o&&(e=JSON.parse(decodeURIComponent(o.value)));const r=n.querySelector(".fsc-i");if(r){const a=r.getAttribute("data-visible");if(a){const n=a.split("/");if(2===n.length){let a=parseInt(n[0]),o=parseInt(n[1]);if(!isNaN(o)&&!isNaN(a)){if(t===v.previous||t===v.next){let e=!0,s=0;for(;e&&s<i.months.length;){t===v.previous?0===a?(a=i.months.length-1,o--):a--:a===i.months.length-1?(a=0,o++):a++;const n=i.year.leapYearRule.isLeapYear(o);(n&&i.months[a].numberOfLeapYearDays>0||!n&&i.months[a].numberOfDays>0)&&(e=!1),s++}}else if(t===v.day){let t=s.target;const n=t.closest(".fsc-o");n&&(t=n);const i=t.getAttribute("data-day");if(i){const t=parseInt(i);if(!isNaN(t)){const s={year:0,month:0,day:0},n={year:0,month:0,day:0};e.allowSelectDateRange?e.selectedDates&&null===e.selectedDates.end.year?(s.year=e.selectedDates.start.year,s.month=e.selectedDates.start.month,s.day=e.selectedDates.start.day||0,n.year=o,n.month=a,n.day=t,(s.day>t&&s.month===a&&s.year===o||s.month>a&&s.year===o||s.year>o)&&(n.year=e.selectedDates.start.year,n.month=e.selectedDates.start.month,n.day=e.selectedDates.start.day||0,s.year=o,s.month=a,s.day=t)):(s.year=o,s.month=a,s.day=t,n.year=NaN,n.month=NaN,n.day=NaN):(s.year=o,s.month=a,s.day=t,n.year=o,n.month=a,n.day=t),e.selectedDates={start:s,end:n}}}}else if(t===v.year){const e=r.querySelector("input[type=number]");if(e){const t=parseInt(e.value);isNaN(t)||(o=t)}}e.date={year:o,month:a,day:0}}}}}const c=le.Render(i,e),l=document.createElement("div");l.innerHTML=c,l.firstChild&&(n.replaceWith(l.firstChild),le.ActivateListeners(e.id,a.onMonthChange,a.onDayClick)),null===a.onMonthChange||t!==v.previous&&t!==v.next?null!==a.onDayClick&&t===v.day?a.onDayClick(e):null!==a.onYearChange&&t===v.year&&a.onYearChange(e):a.onMonthChange(t,e)}}}static NoteIndicator(e,t,a,s){let n="";const i=G.getNotesForDay(e.id,t,a,s);if(i.length){const e=i.filter((e=>!e.userReminderRegistered)),t=i.filter((e=>e.userReminderRegistered));if(e.length){const t=e.length<100?e.length:99;n=`<span class="fsc-x" title="${ce.GenerateNoteIconTitle(t,e)}">${t}</span>`}if(t.length){const e=t.length<100?t.length:99;n+=`<span class="fsc-x fsc-y" title="${ce.GenerateNoteIconTitle(e,t)}">${e}</span>`}}return n}static MoonPhaseIcons(e,t,a,s,n=!1,i=!1){let o;const r=[];for(let n=0;n<e.moons.length;n++){const i=e.moons[n].getDateMoonPhase(e,t,a,s),o=e.months[a].days[s];if(i&&(i.singleDay||o.selected||o.current)){let t=ne(i.icon,"#000000",e.moons[n].color);r.push(`<span class="fsc-z ${i.icon}" title="${e.moons[n].name} - ${i.name}">${t}</span>`)}}return o=r.length<3?r.join(""):`<div class="fsc-_">${r[0]}<span class="fsc-z fa fa-caret-down"></span><div class="fsc-aa ${n?"fsc-ba":"fsc-ca"} ${i?"fsc-da":"fsc-ea"}">${r.join("")}</div></div>`,o}}le.defaultOptions={id:"",allowChangeMonth:!0,allowSelectDateRange:!1,colorToMatchSeason:!0,cssClasses:"",editYear:!1,showCurrentDate:!0,showSeasonName:!0,showNoteCount:!0,showMoonPhases:!0,showYear:!0,theme:"auto",view:D.Month};class de{static Render(e,t={id:""}){let a=`<div id="${(t=P({},this.defaultOptions,t)).id}" class="fsc-ga" data-calendar="${Y.getAllCalendars(t.useCalendarClones).findIndex((t=>t.id===e.id))}">`;return a+=`<input class="fsc-f" type="hidden" value="${encodeURIComponent(JSON.stringify(t))}"/><span class="far fa-clock"></span>`,t.allowTimeRange?(a+=this.RenderTimeInputGroup(e,"fsc-ha",t.selectedTime?.start),a+=`<span class="fsc-ia">${t.timeDelimiter}</span>`,a+=this.RenderTimeInputGroup(e,"fsc-ja",t.selectedTime?.end)):a+=this.RenderTimeInputGroup(e,"",t.selectedTime?.start),a+="</div>",a}static RenderTimeInputGroup(e,t="",a={hour:0,minute:0}){let s=`<div class="fsc-ka ${t}">`;s+=`<input class="fsc-la" data-list="fsc-ma" type="number" value="${_(a.hour)}" /><ul class="fsc-na fsc-oa fsc-ma">`;for(let t=0;t<e.time.hoursInDay;t++)s+=`<li>${_(t)}</li>`;s+="</ul>",s+=`<span class="fsc-ia">:</span><input class="fsc-pa" data-list="fsc-qa" type="number" value="${_(a.minute)}" /><ul class="fsc-na fsc-oa fsc-qa">`;for(let t=0;t<e.time.minutesInHour;t+=5)s+=`<li>${_(t)}</li>`;return s+="</ul>",s+="</div>",s}static ActivateListeners(e,t=null){const a=document.getElementById(e);a&&(a.parentElement&&a.parentElement.addEventListener("click",de.HideTimeDropdown.bind(de,e)),a.querySelectorAll(".fsc-ka .fsc-la").forEach((a=>{a.addEventListener("change",de.ChangeEventListener.bind(de,e,k.change,t)),a.addEventListener("click",de.InputClickEventListener.bind(de,e)),a.addEventListener("wheel",de.ChangeEventListener.bind(de,e,k.wheel,t))})),a.querySelectorAll(".fsc-ka .fsc-pa").forEach((a=>{a.addEventListener("change",de.ChangeEventListener.bind(de,e,k.change,t)),a.addEventListener("click",de.InputClickEventListener.bind(de,e)),a.addEventListener("wheel",de.ChangeEventListener.bind(de,e,k.wheel,t))})),a.querySelectorAll(".fsc-ka .fsc-na").forEach((a=>{a.addEventListener("click",de.ChangeEventListener.bind(de,e,k.dropdownClick,t))})))}static HideTimeDropdown(e){const t=document.getElementById(e);t&&t.querySelectorAll(".fsc-na").forEach((e=>{e.classList.add("fsc-oa")}))}static ChangeEventListener(e,t,a,s){s.stopPropagation(),s.preventDefault();const n=document.getElementById(e);if(n){let e={id:""};const i=n.querySelector(".fsc-f");i&&(e=JSON.parse(decodeURIComponent(i.value)));const o=parseInt(n.getAttribute("data-calendar")||""),r=Y.getAllCalendars(e.useCalendarClones);if(!isNaN(o)&&o>=0&&o<r.length){const i=r[o];e.selectedTime||(e.selectedTime={start:{hour:0,minute:0,seconds:0},end:{hour:0,minute:0,seconds:0}});let c=s.target,l=0,d=!0,h=!0;if(t===k.change||t===k.wheel?(l=parseInt(c.value),isNaN(l)?l=0:(d=c.classList.contains("fsc-la"),c.parentElement&&(h=c.parentElement.classList.contains("fsc-ha"))),t===k.wheel&&(l+=s.deltaY<0?1:-1)):t===k.dropdownClick&&(l=parseInt(c.innerText),!isNaN(l)&&c.parentElement&&(d=c.parentElement.classList.contains("fsc-ma"),c.parentElement.parentElement&&(h=c.parentElement.parentElement.classList.contains("fsc-ha")))),e.allowTimeRange?h?d?e.selectedTime.start.hour=l:e.selectedTime.start.minute=l:d?e.selectedTime.end.hour=l:e.selectedTime.end.minute=l:d?(e.selectedTime.start.hour=l,e.selectedTime.end.hour=l):(e.selectedTime.start.minute=l,e.selectedTime.end.minute=l),e.selectedTime.start.hour<0&&(e.selectedTime.start.hour=0),e.selectedTime.start.minute<0&&(e.selectedTime.start.minute=0),e.selectedTime.end.hour<0&&(e.selectedTime.end.hour=0),e.selectedTime.end.minute<0&&(e.selectedTime.end.minute=0),e.selectedTime.start.hour>=i.time.hoursInDay&&(e.selectedTime.start.hour=i.time.hoursInDay-1),e.selectedTime.start.minute>=i.time.minutesInHour&&(e.selectedTime.start.minute=i.time.minutesInHour-1),e.selectedTime.end.hour>=i.time.hoursInDay&&(e.selectedTime.end.hour=i.time.hoursInDay-1),e.selectedTime.end.minute>=i.time.minutesInHour&&(e.selectedTime.end.minute=i.time.minutesInHour-1),!e.disableSelfUpdate){const t=de.Render(i,e),s=document.createElement("div");s.innerHTML=t,s.firstChild&&(n.replaceWith(s.firstChild),de.ActivateListeners(e.id,a))}a&&a(e)}}}static InputClickEventListener(e,t){t.stopPropagation(),de.HideTimeDropdown(e);let a=t.target;if(a&&a.parentElement){const e=a.getAttribute("data-list");e&&a.parentElement.querySelector(`.${e}`)?.classList.remove("fsc-oa")}}}de.defaultOptions={id:"",allowTimeRange:!0,disableSelfUpdate:!1,timeDelimiter:"-",useCalendarClones:!1};class he{static Render(e,t={id:""}){t=P({},this.defaultOptions,t);const a=e.timeKeeper.getStatus();t.cssClasses+=` ${a}`;let s=`<div id="${t.id}" class="fsc-ra ${t.cssClasses} ${a===w.Started?"fsc-a":""}" data-calendar="${e.id}">`;if(s+=`<input class="fsc-f" type="hidden" value="${encodeURIComponent(JSON.stringify(t))}"/>`,s+=`<div class="fsc-sa">${ne(f.Clock)}</div>`,s+=this.RenderTime(e,t),s+="</div>","none"!==t.theme){s=`<div class="simple-calendar ${"auto"===t.theme?$.clientSettings.theme:t.theme}">${s}</div>`}return s}static RenderTime(e,t){return`<div class="fsc-ta">${e.time.toString()}</div>`}static ActivateListeners(e){const t=document.getElementById(e);if(t){const a=t.getAttribute("data-calendar")||"",s=Y.getCalendar(a);s&&s.timeKeeper.registerUpdateListener(e,he.UpdateListener.bind(he,e))}}static UpdateListener(e,t){const a=document.getElementById(e);if(a){const e=a.getAttribute("data-calendar")||"",s=Y.getCalendar(e);if(s){let e={id:""};const n=a.querySelector(".fsc-f");n&&(e=JSON.parse(decodeURIComponent(n.value)));const i=he.RenderTime(s,e),o=document.createElement("div");if(o.innerHTML=i,o.firstChild){const e=a.querySelector(".fsc-ta");e&&(e.replaceWith(o.firstChild),a.classList.contains(t)||(a.classList.remove(w.Started,w.Stopped,w.Paused,"fsc-a"),a.classList.add(t),t===w.Started&&a.classList.add("fsc-a")))}}}}}he.defaultOptions={id:"",cssClasses:"",theme:"auto"};class me{}me.CalendarFull=le,me.Clock=he,me.TimeSelector=de;class ue extends R{constructor(){super()}async process(e,t){return e.type===u.clock&&(t.timeKeeper.setStatus(e.data),x.clockClass=e.data,t.generalSettings.gameWorldTimeIntegration===p.None&&me.Clock.UpdateListener(`sc_${t.id}_clock`,e.data),!0)}}class ge extends R{constructor(){super()}async initialize(){return O.emit({type:u.checkClockRunning,data:{}})}async process(e,t){return!(e.type!==u.checkClockRunning||!q.IsGm()||!$.primary)&&O.emit({type:u.clock,data:t.timeKeeper.getStatus()})}}class pe extends R{constructor(){super()}async process(e,t){if(e.type===u.dateTimeChange&&q.IsGm()&&$.primary){const a=e.data;return a.type===g.setDate?x.setCurrentDate(a.interval.year||0,a.interval.month||0,a.interval.day||0):a.type===g.changeDateTime?t.changeDateTime(a.interval,{updateMonth:!1}):a.type===g.advanceTimeToPreset&&a.presetTimeOfDay&&await ae(a.presetTimeOfDay,t),!0}return!1}}class fe{static emit(e,t,a){let s={};if(e===S.DateTimeChange){s.date=ee(t.toSeconds(),t),s.diff=a,s.moons=[],s.season={},s.month={},s.day={},s.time={},s.year={number:t.year.numericRepresentation,prefix:t.year.prefix,postfix:t.year.postfix,isLeapYear:t.year.leapYearRule.isLeapYear(t.year.numericRepresentation)};const e=t.getMonth();if(e){s.month={name:e.name,number:e.numericRepresentation,intercalary:e.intercalary,numberOfDays:e.numberOfDays,numberOfLeapYearDays:e.numberOfLeapYearDays};const t=e.getDay();t&&(s.day={number:t.numericRepresentation})}s.time=t.time.getCurrentTime(),s.season=t.getCurrentSeason();for(let e=0;e<t.moons.length;e++){const a=t.moons[e].getMoonPhase(t);s.moons.push({name:t.moons[e].name,color:t.moons[e].color,cycleLength:t.moons[e].cycleLength,cycleDayAdjust:t.moons[e].cycleDayAdjust,currentPhase:a})}}else if(e===S.ClockStartStop){const e=t.timeKeeper.getStatus();s={started:e===w.Started,stopped:e===w.Stopped,paused:e===w.Paused}}else e===S.PrimaryGM&&(s.isPrimaryGM=$.primary);Hooks.callAll(e,s)}}class ye extends R{constructor(){super()}async process(e,t){if(e.type===u.emitHook){const a=e.data.hook;return a&&fe.emit(a,t,e.data.param),!0}return!1}}class Ce extends R{constructor(){super()}async process(e,a){if(e.type===u.noteUpdate){const a=e.data,s=game.journal?.get(a.journalId||"");if(s&&a.userId){const e=s.getFlag(t,"noteData");if(e){const n=e.remindUsers.indexOf(a.userId);-1===n?e.remindUsers.push(a.userId):e.remindUsers.splice(n,1);const i={};i[t]={noteData:e},await s.update({flags:i}),await O.emit({type:u.mainAppUpdate,data:{userId:a.userId}})}}else a.calendarId&&a.newOrder&&a.date&&(await G.orderNotesOnDay(a.calendarId,a.newOrder,a.date),await O.emit({type:u.mainAppUpdate,data:{}}),x.updateApp());return!0}return!1}}class be extends R{constructor(){super(),this.checkDuration=5e3,this.otherPrimaryFound=!1}async primaryCheckTimeoutCall(){const e=Y.getActiveCalendar();$.primary=!0;const t={type:u.primary,data:{amPrimary:$.primary}};await O.emit(t);const a={type:u.clock,data:w.Stopped};await O.emit(a),e.time.unifyGameAndClockPause&&game.togglePause(!0,!0),await x.timeKeepingCheck(),fe.emit(S.PrimaryGM,e)}async initialize(){if(q.IsGm()){const e=game.users;if((e?e.filter((e=>e.isGM)).length:0)>1){const e={type:u.primary,data:{primaryCheck:!0}};return O.emit(e).then((()=>new Promise((e=>{window.setTimeout((e=>{this.otherPrimaryFound||this.primaryCheckTimeoutCall(),x.uiElementStates.primaryCheckRunning=!1,e(!0)}).bind(this,e),this.checkDuration)}))))}return await this.primaryCheckTimeoutCall(),!0}return x.uiElementStates.primaryCheckRunning=!1,!0}async process(e,t){return e.type===u.primary&&(q.IsGm()&&(e.data.primaryCheck?await O.emit({type:u.primary,data:{amPrimary:$.primary}}):void 0!==e.data.amPrimary&&e.data.amPrimary&&(this.otherPrimaryFound=!0,$.primary=!1)),!0)}}class Se extends R{constructor(){super()}async process(e,t){if(e.type===u.mainAppUpdate){const t=e.data;return t.userId?q.UserID()===t.userId&&x.updateApp():x.updateApp(),!0}return!1}}class we extends R{constructor(){super()}async process(e,t){return!(e.type!==u.setActiveCalendar||!q.IsGm()||!$.primary)&&(Y.setActiveCalendar(e.data.calendarId),!0)}}class De{constructor(){this.sockets=[],this.sockets.push(new Se),this.sockets.push(new be),this.sockets.push(new ge),this.sockets.push(new ue),this.sockets.push(new pe),this.sockets.push(new ye),this.sockets.push(new Ce),this.sockets.push(new we)}initialize(){O.on(this.process.bind(this)),Promise.all(this.sockets.map((e=>e.initialize()))).then((e=>{x.updateApp(),fe.emit(S.Ready,Y.getActiveCalendar())})).catch(A.error)}async process(e){const t=Y.getActiveCalendar();for(let a=0;a<this.sockets.length&&!await this.sockets[a].process(e,t);a++);}}class ve{constructor(e="",t=NaN){this.id=U(),this.name=e,this.numericRepresentation=t}clone(){const e=new ve(this.name,this.numericRepresentation);return e.id=this.id,e}toConfig(){return{id:this.id,name:this.name,numericRepresentation:this.numericRepresentation}}toTemplate(e=null){return{id:this.id,name:this.name,numericRepresentation:this.numericRepresentation}}loadFromSettings(e){this.id=e.id,e.hasOwnProperty("name")&&e.name&&(this.name=e.name),e.hasOwnProperty("numericRepresentation")&&e.numericRepresentation&&(this.numericRepresentation=e.numericRepresentation)}}class ke extends ve{constructor(e,t=""){super(t,e),this.current=!1,this.selected=!1,""===this.name&&this.numericRepresentation&&(this.name=this.numericRepresentation.toString())}toConfig(){return{...super.toTemplate(),name:this.name,numericRepresentation:this.numericRepresentation}}toTemplate(){return{...super.toTemplate(),name:this.name,numericRepresentation:this.numericRepresentation,current:this.current,selected:this.selected}}clone(){const e=new ke(this.numericRepresentation,this.name);return e.id=this.id,e.current=this.current,e.selected=this.selected,e}}class Me extends ve{constructor(e="",t=NaN,a=0,s=0,n=null){super(e,t),this.days=[],this.numberOfDays=0,this.numberOfLeapYearDays=0,this.numericRepresentationOffset=0,this.intercalary=!1,this.intercalaryInclude=!1,this.current=!1,this.visible=!1,this.selected=!1,this.showAdvanced=!1,this.startingWeekday=null,this.abbreviation="",this.numericRepresentationOffset=a,""===this.name&&(this.name=t.toString()),this.abbreviation=this.name.substring(0,3),this.numberOfLeapYearDays=null===n?s:n,this.numberOfDays=s,this.populateDays(this.numberOfLeapYearDays>this.numberOfDays?this.numberOfLeapYearDays:this.numberOfDays)}populateDays(e,t=null){for(let a=1;a<=e;a++){const e=new ke(a+this.numericRepresentationOffset);a===t&&(e.current=!0),this.days.push(e)}}toConfig(){return{id:this.id,name:this.name,abbreviation:this.abbreviation,numericRepresentation:this.numericRepresentation,numericRepresentationOffset:this.numericRepresentationOffset,numberOfDays:this.numberOfDays,numberOfLeapYearDays:this.numberOfLeapYearDays,intercalary:this.intercalary,intercalaryInclude:this.intercalaryInclude,startingWeekday:this.startingWeekday}}toTemplate(e=null){let t=!1;return e&&(t=e.year.leapYearRule.isLeapYear(e.year.visibleYear)),{...super.toTemplate(),abbreviation:this.abbreviation,name:this.name,numericRepresentation:this.numericRepresentation,numericRepresentationOffset:this.numericRepresentationOffset,current:this.current,visible:this.visible,selected:this.selected,days:this.getDaysForTemplate(t),numberOfDays:this.numberOfDays,numberOfLeapYearDays:this.numberOfLeapYearDays,intercalary:this.intercalary,intercalaryInclude:this.intercalaryInclude,showAdvanced:this.showAdvanced,startingWeekday:this.startingWeekday}}clone(){const e=new Me(this.name,this.numericRepresentation,this.numericRepresentationOffset);return e.id=this.id,e.name=this.name,e.abbreviation=this.abbreviation,e.current=this.current,e.selected=this.selected,e.visible=this.visible,e.days=this.days.map((e=>e.clone())),e.numberOfDays=this.numberOfDays,e.numberOfLeapYearDays=this.numberOfLeapYearDays,e.intercalary=this.intercalary,e.intercalaryInclude=this.intercalaryInclude,e.showAdvanced=this.showAdvanced,e.startingWeekday=this.startingWeekday,e}loadFromSettings(e){if(e&&Object.keys(e).length){e.hasOwnProperty("id")&&(this.id=e.id),this.name=e.name,this.numericRepresentation=e.numericRepresentation,this.numericRepresentationOffset=e.numericRepresentationOffset;let t=parseInt(e.numberOfDays.toString()),a=void 0===e.numberOfLeapYearDays?0:parseInt(e.numberOfLeapYearDays.toString());isNaN(t)&&(t=1),isNaN(a)&&(a=1),this.numberOfDays=t,this.numberOfLeapYearDays=a,this.intercalary=e.intercalary,this.intercalaryInclude=e.intercalaryInclude,e.hasOwnProperty("startingWeekday")&&(this.startingWeekday=e.startingWeekday),e.hasOwnProperty("abbreviation")?this.abbreviation=e.abbreviation:this.abbreviation=this.name.substring(0,3),this.days=[],this.populateDays(this.numberOfLeapYearDays>this.numberOfDays?this.numberOfLeapYearDays:this.numberOfDays)}}getDay(e="current"){const t=e.toLowerCase();return this.days.find((e=>e[t]))}getDayIndex(e="current"){const t=e.toLowerCase();return this.days.findIndex((e=>e[t]))}getDaysForTemplate(e=!1){let t=this.days.map((e=>e.toTemplate()));if(this.numberOfDays!==this.numberOfLeapYearDays){const a=this.numberOfLeapYearDays-this.numberOfDays;if(a>0&&!e)return t.slice(0,t.length-a);if(a<0&&e)return t.slice(0,t.length-Math.abs(a))}return t}changeDay(e,t=!1,a="current"){const s=this.getDayIndex(a);let n=0;const i=t?this.numberOfLeapYearDays:this.numberOfDays;if(s>-1){let o=s+e;e>0&&o>=i||e<0&&o<0||o<0?(this.resetDays(a),n=e>0?1:-1):this.updateDay(o,t,a)}return n}resetDays(e="current"){const t=e.toLowerCase();this.days.forEach((e=>{e[t]=!1}))}updateDay(e,t=!1,a="current"){const s=a.toLowerCase(),n=t?this.numberOfLeapYearDays:this.numberOfDays;this.resetDays(a),e<0||e>=n?this.days[n-1][s]=!0:this.days[e]&&(this.days[e][s]=!0)}}class Te extends ve{constructor(e=NaN,t=""){super(t,e),this.abbreviation="",this.abbreviation=t.substring(0,2)}toConfig(){return{abbreviation:this.abbreviation,id:this.id,name:this.name,numericRepresentation:this.numericRepresentation}}toTemplate(){return{...super.toTemplate(),abbreviation:this.abbreviation,name:this.name,numericRepresentation:this.numericRepresentation}}clone(){const e=new Te(this.numericRepresentation,this.name);return e.id=this.id,e.abbreviation=this.abbreviation,e}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.name=e.name,this.numericRepresentation=e.numericRepresentation,e.hasOwnProperty("abbreviation")?this.abbreviation=e.abbreviation:this.abbreviation=this.name.substring(0,2))}}class Ne extends ve{constructor(e="",t=0,a=0){super(e),this.color="#ffffff",this.startingMonth=-1,this.startingDay=-1,this.sunriseTime=0,this.sunsetTime=0,this.icon=f.None,this.startingMonth=t,this.startingDay=a}clone(){const e=new Ne(this.name,this.startingMonth,this.startingDay);return e.id=this.id,e.color=this.color,e.icon=this.icon,e.sunriseTime=this.sunriseTime,e.sunsetTime=this.sunsetTime,e}toConfig(){return{id:this.id,name:this.name,startingMonth:this.startingMonth,startingDay:this.startingDay,color:this.color,icon:this.icon,sunriseTime:this.sunriseTime,sunsetTime:this.sunsetTime}}toTemplate(){const e=`sc_season_start_date_${this.id}`,t=`sc_season_sunrise_time_${this.id}`;let a=0,s=0,n=0,i=0;const o=Y.getActiveCalendar();return s=Math.floor(this.sunriseTime/o.time.secondsInMinute),i=Math.floor(this.sunsetTime/o.time.secondsInMinute),s>=o.time.minutesInHour&&(a=Math.floor(s/o.time.minutesInHour),s-=a*o.time.minutesInHour),i>=o.time.minutesInHour&&(n=Math.floor(i/o.time.minutesInHour),i-=n*o.time.minutesInHour),{...super.toTemplate(),name:this.name,startingMonth:this.startingMonth,startingDay:this.startingDay,color:this.color,icon:this.icon,startDateSelectorId:e,startDateSelectedDate:{year:0,month:this.startingMonth,day:this.startingDay,hour:0,minute:0,seconds:0},sunriseSelectorId:t,sunriseSelectorSelectedDates:{start:{year:0,month:0,day:0,hour:a,minute:s,seconds:0},end:{year:0,month:0,day:0,hour:n,minute:i,seconds:0}}}}loadFromSettings(e){if(e&&Object.keys(e).length){e.hasOwnProperty("id")&&(this.id=e.id),this.name=e.name,this.startingMonth=e.startingMonth,this.startingDay=e.startingDay;const t=e.customColor;this.color="custom"===e.color&&t?t:e.color,e.hasOwnProperty("sunriseTime")&&(this.sunriseTime=e.sunriseTime),e.hasOwnProperty("sunsetTime")&&(this.sunsetTime=e.sunsetTime),e.hasOwnProperty("icon")&&(this.icon=e.icon)}}}class Ie extends ve{constructor(e="",t=0){super(e),this.phases=[],this.firstNewMoon={yearReset:y.None,yearX:0,year:0,month:1,day:1},this.color="#ffffff",this.cycleDayAdjust=0,this.cycleLength=t,this.phases.push({name:q.Localize("FSC.Moon.Phase.New"),length:3.69,icon:f.NewMoon,singleDay:!0})}clone(){const e=new Ie(this.name,this.cycleLength);return e.id=this.id,e.phases=this.phases.map((e=>({name:e.name,length:e.length,icon:e.icon,singleDay:e.singleDay}))),e.firstNewMoon.yearReset=this.firstNewMoon.yearReset,e.firstNewMoon.yearX=this.firstNewMoon.yearX,e.firstNewMoon.year=this.firstNewMoon.year,e.firstNewMoon.month=this.firstNewMoon.month,e.firstNewMoon.day=this.firstNewMoon.day,e.color=this.color,e.cycleDayAdjust=this.cycleDayAdjust,e}toConfig(){return{id:this.id,name:this.name,cycleLength:this.cycleLength,firstNewMoon:{yearReset:this.firstNewMoon.yearReset,yearX:this.firstNewMoon.yearX,year:this.firstNewMoon.year,month:this.firstNewMoon.month,day:this.firstNewMoon.day},phases:this.phases.map((e=>({name:e.name,length:e.length,icon:e.icon,singleDay:e.singleDay}))),color:this.color,cycleDayAdjust:this.cycleDayAdjust}}toTemplate(e){return{...super.toTemplate(),name:this.name,cycleLength:this.cycleLength,firstNewMoon:this.firstNewMoon,phases:this.phases,color:this.color,cycleDayAdjust:this.cycleDayAdjust,firstNewMoonDateSelectorId:`sc_first_new_moon_date_${this.id}`,firstNewMoonSelectedDate:{year:0,month:this.firstNewMoon.month,day:this.firstNewMoon.day,hour:0,minute:0,seconds:0}}}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.name=e.name,this.cycleLength=e.cycleLength,this.phases=e.phases,this.firstNewMoon={yearReset:e.firstNewMoon.yearReset,yearX:e.firstNewMoon.yearX,year:e.firstNewMoon.year,month:e.firstNewMoon.month,day:e.firstNewMoon.day},this.color=e.color,this.cycleDayAdjust=e.cycleDayAdjust)}updatePhaseLength(){let e=0,t=0;for(let a=0;a<this.phases.length;a++)this.phases[a].singleDay?t++:e++;const a=Number(((this.cycleLength-t)/e).toPrecision(6));this.phases.forEach((e=>{e.singleDay?e.length=1:e.length=a}))}getDateMoonPhase(e,t,a,s){let n=e.dateToDays(this.firstNewMoon.year,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0),i=0;if(this.firstNewMoon.yearReset===y.LeapYear){let a=e.year.leapYearRule.previousLeapYear(t);null!==a&&(n=e.dateToDays(a,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0),t!==a&&(i+=e.year.leapYearRule.fraction(t)))}else if(this.firstNewMoon.yearReset===y.XYears){const a=t%this.firstNewMoon.yearX;if(0!==a){let s=t-a;n=e.dateToDays(s,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0),i+=a/this.firstNewMoon.yearX}}const o=(e.dateToDays(t,a,s,!0,!0)-n+i)/this.cycleLength;let r=(o-Math.floor(o))*this.cycleLength+this.cycleDayAdjust,c=0,l=null;for(let e=0;e<this.phases.length;e++){const t=c+this.phases[e].length;if(r>=c&&r<t){l=this.phases[e];break}c=t}return null!==l?l:this.phases[0]}getMoonPhase(e,t="current",a=0){let s="current"===(t=t.toLowerCase())?e.year.numericRepresentation:"selected"===t?e.year.selectedYear:e.year.visibleYear;const n=e.getMonthIndex(t);if(n>-1){const i="visible"!==t?e.months[n].getDayIndex(t):a;return this.getDateMoonPhase(e,s,n,i)}return this.phases[0]}}var Le=a(162);class Oe{static async setToPredefined(e,a,s=!0){let n=!1,i=await fetch(getRoute(`modules/${t}/predefined-calendars/${a}.json`));const o=await i.json();if(o&&o.calendar){const i=e.id.replace("_temp","");if(delete o.calendar.name,a===c.Gregorian){const e=new Date;o.calendar.currentDate.year=e.getFullYear(),o.calendar.currentDate.month=e.getMonth(),o.calendar.currentDate.day=e.getDate()-1,o.calendar.year.numericRepresentation=e.getFullYear()}e.loadFromSettings(o.calendar);const r=G.getNotes(i);for(let e=0;e<r.length;e++)if(r[e].fromPredefined){const t=game.journal?.get(r[e].entryId);t&&(G.removeNoteStub(t),await t.delete())}if(s&&o.notes){const e={};game.users?.forEach((t=>e[t.id]=game.user?.id===t.id?3:2));for(let a=0;a<o.notes.length;a++){const s=o.notes[a];s.flags[t].noteData.calendarId=i,s.flags[t].noteData.fromPredefined=!0,s.folder=G.noteDirectory?.id,s.permission=e,await JournalEntry.create(s,{keepId:!1})}}n=!0}return n}}class Ae{constructor(e,t){this.showCalendarYear=!0,this.addTime=!1,this.timeDelimiter="-",this.allowDateRangeSelection=!1,this.allowTimeRangeSelection=!0,this.secondDaySelect=!1,this.onDateSelect=null,this.position=T.Auto,this.calendar=Y.getActiveCalendar(),this.editYear=!1,this.useCloneCalendars=!1,this.id=e,this.calendarId=`${this.id}_calendar`,this.timeSelectorId=`${this.id}_time_selector`,this.showDateSelector=!0,this.showTimeSelector=!1,this.selectedDate={visible:{year:0,month:1,day:1,hour:0,minute:0,seconds:0},start:{year:0,month:1,day:1,hour:0,minute:0,seconds:0},end:{year:0,month:1,day:1,hour:0,minute:0,seconds:0},allDay:!0},this.applyOptions(t),void 0===t.selectedEndDate&&(this.selectedDate.end={year:this.selectedDate.start.year,month:this.selectedDate.start.month,day:this.selectedDate.start.day,hour:this.selectedDate.start.hour,minute:this.selectedDate.start.minute,seconds:this.selectedDate.start.seconds}),this.selectedDate.allDay||(this.addTime=!0)}applyOptions(e){void 0!==e.calendar&&(this.calendar=e.calendar),void 0!==e.showDateSelector&&(this.showDateSelector=e.showDateSelector),void 0!==e.showTimeSelector&&(this.showTimeSelector=e.showTimeSelector),void 0!==e.showCalendarYear&&(this.showCalendarYear=e.showCalendarYear),e.onDateSelect&&(this.onDateSelect=e.onDateSelect),e.position&&(this.position=e.position),void 0!==e.allowDateRangeSelection&&(this.allowDateRangeSelection=e.allowDateRangeSelection),void 0!==e.allowTimeRangeSelection&&(this.allowTimeRangeSelection=e.allowTimeRangeSelection),void 0!==e.editYear&&(this.editYear=e.editYear),void 0!==e.timeDelimiter&&(this.timeDelimiter=e.timeDelimiter),void 0!==e.selectedStartDate&&(this.selectedDate.start={year:e.selectedStartDate.year,month:e.selectedStartDate.month,day:e.selectedStartDate.day,hour:e.selectedStartDate.hour,minute:e.selectedStartDate.minute,seconds:e.selectedStartDate.seconds},this.selectedDate.visible={year:this.selectedDate.start.year,month:this.selectedDate.start.month,day:this.selectedDate.start.day,hour:this.selectedDate.start.hour,minute:this.selectedDate.start.minute,seconds:this.selectedDate.start.seconds}),void 0!==e.selectedEndDate&&(this.selectedDate.end={year:e.selectedEndDate.year,month:e.selectedEndDate.month,day:e.selectedEndDate.day,hour:e.selectedEndDate.hour,minute:e.selectedEndDate.minute,seconds:e.selectedEndDate.seconds}),void 0!==e.timeSelected?this.selectedDate.allDay=!e.timeSelected:this.selectedDate.allDay=!this.showTimeSelector,e.useCloneCalendars&&(this.useCloneCalendars=e.useCloneCalendars)}build(e=!0,t=!0){let a,s=`<div id="${this.id}" class="fsc-ua">`,n="",i="";this.showDateSelector&&(n=me.CalendarFull.Render(this.calendar,{id:this.calendarId,allowChangeMonth:!0,allowSelectDateRange:this.allowDateRangeSelection,cssClasses:"fsc-va",colorToMatchSeason:!1,editYear:this.editYear,showCurrentDate:!1,showMoonPhases:!1,showNoteCount:!1,showSeasonName:!1,showYear:this.showCalendarYear,date:{month:this.selectedDate.visible.month,year:this.selectedDate.visible.year,day:0},theme:"none",selectedDates:{start:{year:this.selectedDate.start.year,month:this.selectedDate.start.month,day:this.selectedDate.start.day},end:{year:this.selectedDate.end.year,month:this.selectedDate.end.month,day:this.selectedDate.end.day}}})),this.showTimeSelector&&(i='<div class="fsc-wa">',this.addTime?(i+=me.TimeSelector.Render(this.calendar,{id:this.timeSelectorId,allowTimeRange:this.allowTimeRangeSelection,disableSelfUpdate:!0,selectedTime:{start:{hour:this.selectedDate.start.hour,minute:this.selectedDate.start.minute,seconds:this.selectedDate.start.seconds},end:{hour:this.selectedDate.end.hour,minute:this.selectedDate.end.minute,seconds:this.selectedDate.end.seconds}},timeDelimiter:this.timeDelimiter,useCalendarClones:this.useCloneCalendars}),this.showDateSelector&&(i+=`<div class="fsc-xa"><button class="fsc-ya fsc-za"><i class="fa fa-times"></i> ${q.Localize("FSC.RemoveTime")}</button></div>`)):i+=`<div class="fsc-_a"><button class="fsc-ya fsc-ab"><i class="fa fa-clock"></i> ${q.Localize("FSC.Notes.DateTime.AllDay")}</button></div>`,i+="</div>");return a=`<input class="fsc-bb" value="${K(this.calendar,this.selectedDate.start,this.selectedDate.end,this.selectedDate.allDay,this.showTimeSelector&&!this.showDateSelector,this.showCalendarYear,this.timeDelimiter)}" tabindex="0" type="text" readonly="readonly"><div class="fsc-cb${this.showTimeSelector&&!this.showDateSelector?" fsc-db":""}" style="display:${e?"none":"block"};">${n}${i}</div>`,t&&(a=`${s}${a}</div>`),a}setPosition(e){if(e){e.classList.remove(T.LeftUp),e.classList.remove(T.LeftDown),e.classList.remove(T.RightUp),e.classList.remove(T.RightDown);let t=this.position;if(this.position===T.Auto){const a=e.closest(".window-app");if(a){let s=e.getBoundingClientRect();const n=a.getBoundingClientRect();t=s.right>n.right?"right-":"left-",s.bottom>n.bottom&&s.top-s.height>n.top?t+="up":t+="down"}}e.classList.add(t)}}update(e=!1){const t=this.build(e,!1),a=document.querySelector(`#${this.id}`);a&&(a.innerHTML=t,this.activateListeners(a,!0,!0,!1),a.style.display="block",this.setPosition(a.querySelector(".fsc-cb")))}activateListeners(e=null,t=!0,a=!0,s=!0){if(e||(e=document.querySelector(`#${this.id}`)),e){if(s&&document.addEventListener("click",this.hideCalendar.bind(this,e)),t&&a){const t=e.querySelector(".fsc-bb");t&&t.addEventListener("click",this.toggleCalendar.bind(this,e))}if(t&&this.showDateSelector&&me.CalendarFull.ActivateListeners(this.calendarId,this.changeMonthClick.bind(this),this.dayClick.bind(this),this.changeYear.bind(this)),this.showDateSelector){const t=e.querySelector(".fsc-va");t&&t.addEventListener("click",this.calendarClick.bind(this))}if(a&&this.showTimeSelector&&me.TimeSelector.ActivateListeners(this.timeSelectorId,this.timeChange.bind(this)),this.showTimeSelector){const t=e.querySelector(".fsc-_a button");t&&t.addEventListener("click",this.addTimeClick.bind(this));const a=e.querySelector(".fsc-xa button");a&&a.addEventListener("click",this.removeTimeClick.bind(this))}}}callOnDateSelect(){if(this.onDateSelect){const e={startDate:{year:this.selectedDate.start.year,month:this.selectedDate.start.month,day:this.selectedDate.start.day,hour:this.selectedDate.start.hour,minute:this.selectedDate.start.minute},endDate:{year:this.selectedDate.end.year,month:this.selectedDate.end.month,day:this.selectedDate.end.day,hour:this.selectedDate.end.hour,minute:this.selectedDate.end.minute},timeSelected:!this.selectedDate.allDay};this.onDateSelect(e)}}toggleCalendar(e,t){t.stopPropagation();const a=e.querySelector(".fsc-cb");a&&("none"===a.style.display?(a.style.display="block",this.setPosition(a)):a.style.display="none")}hideCalendar(e){this.secondDaySelect=!1;const t=e.querySelector(".fsc-cb");t&&(t.offsetWidth||t.offsetHeight||t.getClientRects().length)&&(t.style.display="none",this.callOnDateSelect())}calendarClick(e){e.stopPropagation(),me.TimeSelector.HideTimeDropdown(this.timeSelectorId);const t=document.getElementById(this.id);if(t){const e=t.getElementsByClassName("fsc-eb");for(let t=0;t<e.length;t++)e[t].classList.add("hide")}}dayClick(e){if(e.selectedDates){let t=!0;this.secondDaySelect?(this.selectedDate.start.year=e.selectedDates.start.year,this.selectedDate.start.month=e.selectedDates.start.month,this.selectedDate.start.day=e.selectedDates.start.day||0,this.selectedDate.end.year=e.selectedDates.end.year,this.selectedDate.end.month=e.selectedDates.end.month,this.selectedDate.end.day=e.selectedDates.end.day||0):(this.selectedDate.start.year=e.selectedDates.start.year,this.selectedDate.start.month=e.selectedDates.start.month,this.selectedDate.start.day=e.selectedDates.start.day||0,this.selectedDate.end.year=e.selectedDates.start.year,this.selectedDate.end.month=e.selectedDates.start.month,this.selectedDate.end.day=e.selectedDates.start.day||0,this.secondDaySelect=!0,t=!this.allowDateRangeSelection),t?(this.secondDaySelect=!1,this.update(t),this.callOnDateSelect()):this.showTimeSelector&&me.TimeSelector.HideTimeDropdown(this.timeSelectorId)}}changeMonthClick(e,t){t.date&&(this.selectedDate.visible.year=t.date.year,this.selectedDate.visible.month=t.date.month),this.activateListeners(null,!1,!1),this.showTimeSelector&&me.TimeSelector.HideTimeDropdown(this.timeSelectorId)}changeYear(e){e.date&&(this.selectedDate.visible.year=e.date.year),this.activateListeners(null,!1,!1),this.showTimeSelector&&me.TimeSelector.HideTimeDropdown(this.timeSelectorId)}addTimeClick(e){e.stopPropagation(),this.addTime=!0,this.selectedDate.allDay=!1,this.selectedDate.start.hour=0,this.selectedDate.start.minute=0,this.selectedDate.start.seconds=0,this.selectedDate.end.hour=0,this.selectedDate.end.minute=0,this.selectedDate.end.seconds=0,this.update()}removeTimeClick(e){e.stopPropagation(),this.addTime=!1,this.selectedDate.allDay=!0,this.selectedDate.start.hour=0,this.selectedDate.start.minute=0,this.selectedDate.start.seconds=0,this.selectedDate.end.hour=0,this.selectedDate.end.minute=0,this.selectedDate.end.seconds=0,this.update()}timeChange(e){e.selectedTime&&(J(this.selectedDate.start,this.selectedDate.end)&&e.selectedTime.end.hour<=e.selectedTime.start.hour&&(e.selectedTime.end.hour=e.selectedTime.start.hour,e.selectedTime.end.minute<e.selectedTime.start.minute&&(e.selectedTime.end.minute=e.selectedTime.start.minute)),this.selectedDate.start.hour=e.selectedTime.start.hour,this.selectedDate.start.minute=e.selectedTime.start.minute,this.selectedDate.end.hour=e.selectedTime.end.hour,this.selectedDate.end.minute=e.selectedTime.end.minute,this.update(),this.showTimeSelector&&!this.showDateSelector&&this.callOnDateSelect())}}class Re{static GetSelector(e,t){if(this.Selectors.hasOwnProperty(e))return this.Selectors[e].applyOptions(t),this.Selectors[e];{const a=new Ae(e,t);return this.Selectors[e]=a,a}}static RemoveSelector(e){this.Selectors.hasOwnProperty(e)&&delete this.Selectors[e]}static ActivateSelector(e){this.Selectors.hasOwnProperty(e)&&this.Selectors[e].activateListeners()}}Re.Selectors={};class Fe extends ve{constructor(){super(),this.viewCalendar={player:!0,trustedPlayer:!0,assistantGameMaster:!0,users:void 0},this.addNotes={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},this.reorderNotes={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},this.changeDateTime={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},this.changeActiveCalendar={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0}}static clonePermissions(e){return{player:e.player,trustedPlayer:e.trustedPlayer,assistantGameMaster:e.assistantGameMaster,users:e.users}}clone(){const e=new Fe;return e.id=this.id,e.viewCalendar=Fe.clonePermissions(this.viewCalendar),e.addNotes=Fe.clonePermissions(this.addNotes),e.reorderNotes=Fe.clonePermissions(this.reorderNotes),e.changeDateTime=Fe.clonePermissions(this.changeDateTime),e.changeActiveCalendar=Fe.clonePermissions(this.changeActiveCalendar),e}toTemplate(){return{...super.toTemplate(),viewCalendar:this.viewCalendar,addNotes:this.addNotes,reorderNotes:this.reorderNotes,changeDateTime:this.changeDateTime,changeActiveCalendar:this.changeActiveCalendar}}toConfig(){return{id:this.id,addNotes:this.addNotes,changeDateTime:this.changeDateTime,reorderNotes:this.reorderNotes,viewCalendar:this.viewCalendar,changeActiveCalendar:this.changeActiveCalendar}}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("viewCalendar")&&this.validateUserPermissionMatrix(e.viewCalendar)&&(this.viewCalendar=e.viewCalendar),e.hasOwnProperty("addNotes")&&this.validateUserPermissionMatrix(e.addNotes)&&(this.addNotes=e.addNotes),e.hasOwnProperty("changeDateTime")&&this.validateUserPermissionMatrix(e.changeDateTime)&&(this.changeDateTime=e.changeDateTime),e.hasOwnProperty("reorderNotes")&&this.validateUserPermissionMatrix(e.reorderNotes)&&(this.reorderNotes=e.reorderNotes),e.hasOwnProperty("changeActiveCalendar")&&this.validateUserPermissionMatrix(e.changeActiveCalendar)&&(this.changeActiveCalendar=e.changeActiveCalendar))}validateUserPermissionMatrix(e){return!!(e&&F(e)&&e.hasOwnProperty("player")&&e.hasOwnProperty("trustedPlayer")&&e.hasOwnProperty("assistantGameMaster"))}}function je(e,t,a=document){const s=a.querySelector(e);return s?s.value:t}function Pe(e,t,a=!1,s=document){const n=s.querySelector(e);if(n){const e=a?parseFloat(n.value):parseInt(n.value);if(!isNaN(e))return e}return t}function Ye(e,t,a=document){const s=a.querySelector(e);return s?s.checked:t}function xe(e,t=document){return Array.from(t.querySelectorAll(`input[name=${e}]:checked`)).map((e=>e.value))}class Ee extends FormApplication{constructor(){super({}),this.appWindow=null,this.calendars=[],this.predefindCalendars=[],this.globalConfiguration={id:"",version:"",calendarsSameTimestamp:!1,combatPauseRule:o.Active,permissions:new Fe,secondsInCombatRound:6,syncCalendars:!1,showNotesFolder:!1},this.clientSettings={id:"",theme:i.dark,openOnLoad:!0,openCompact:!1,rememberPosition:!0,appPosition:{}},this.uiElementStates={dateFormatExample:"",dateFormatTableExpanded:!1,monthYearFormatExample:"",qsNextClicked:!1,qsAddNotes:!0,selectedPredefinedCalendar:"",timeFormatExample:""}}render(e,t){return isObjectEmpty(this.object)?void E.initializeAndShowDialog().catch(A.error):((t=t||{}).classes=["simple-calendar","fsc-fb",q.GetStringSettings(n.Theme)],super.render(e,t))}async initializeAndShowDialog(){if(this.calendars=Y.cloneCalendars(),this.object=this.calendars[0],$.load(),this.globalConfiguration.permissions=$.globalConfiguration.permissions.clone(),this.globalConfiguration.secondsInCombatRound=$.globalConfiguration.secondsInCombatRound,this.globalConfiguration.calendarsSameTimestamp=$.globalConfiguration.calendarsSameTimestamp,this.globalConfiguration.syncCalendars=$.globalConfiguration.syncCalendars,this.globalConfiguration.showNotesFolder=$.globalConfiguration.showNotesFolder,this.globalConfiguration.combatPauseRule=$.globalConfiguration.combatPauseRule,this.clientSettings=P({},$.clientSettings),this._tabs[0].active="globalSettings",0===this.predefindCalendars.length)try{const e=await fetch(getRoute(`modules/${t}/predefined-calendars/calendar-list.json`));this.predefindCalendars=await e.json()}catch(e){A.error(e),this.predefindCalendars=[]}this.rendered?this.bringToTop():this.showApp()}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/configuration.html",e.title="FSC.Configuration.Title",e.id=this.appWindowId,e.classes=["simple-calendar","fsc-fb"],e.resizable=!0,e.tabs=[{navSelector:".tabs",contentSelector:"form",initial:"yearSettings"}],e.height=700,e.width=1005,e.scrollY=[".fsc-gb",".fsc-hb"],e}showApp(){this.render(!0)}closeApp(){this.close().catch(A.error)}close(e){return Y.clearClones(),this.object.seasons.forEach((e=>{Re.RemoveSelector(`sc_season_start_date_${e.id}`),Re.RemoveSelector(`sc_season_sunrise_time_${e.id}`)})),this.appWindow=null,super.close(e)}updateApp(){this.render(!1)}getData(e){const t=this.object.getCurrentDate();this.uiElementStates.dateFormatExample=V({year:t.year,month:t.month,day:t.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.date,this.object),this.uiElementStates.timeFormatExample=V({year:t.year,month:t.month,day:t.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.time,this.object),this.uiElementStates.monthYearFormatExample=V({year:t.year,month:t.month,day:t.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.monthYear,this.object);let a={...super.getData(e),activeCalendarId:this.object.id,calendars:this.calendars,clientSettings:{openOnLoad:this.clientSettings.openOnLoad,openInCompact:this.clientSettings.openCompact,rememberPos:this.clientSettings.rememberPosition,theme:this.clientSettings.theme,themes:{dark:"FSC.Configuration.Theme.Dark",light:"FSC.Configuration.Theme.Light",classic:"FSC.Configuration.Theme.Classic"}},combatPauseRules:{active:"FSC.Configuration.CombatPauseRule.Active",current:"FSC.Configuration.CombatPauseRule.Current"},currentYear:this.object.year,gameSystem:this.object.gameSystem,generalSettings:this.object.generalSettings,globalConfiguration:this.globalConfiguration,isGM:q.IsGm(),leapYearRule:this.object.year.leapYearRule,leapYearRules:{none:"FSC.Configuration.LeapYear.Rules.None",gregorian:"FSC.Configuration.LeapYear.Rules.Gregorian",custom:"FSC.Configuration.LeapYear.Rules.Custom"},months:this.object.months.map((e=>e.toTemplate())),monthStartingWeekdays:{},moons:this.object.moons.map((e=>e.toTemplate(this.object))),moonIcons:{},moonYearReset:{none:"FSC.Configuration.Moon.YearResetNo","leap-year":"FSC.Configuration.Moon.YearResetLeap","x-years":"FSC.Configuration.Moon.YearResetX"},noteCategories:[],predefined:this.predefindCalendars,qsCalDate:{year:1,month:0,day:0,hour:0,minute:0,allDay:!0},seasonColors:[{value:"#ffffff",display:q.Localize("FSC.Configuration.Season.ColorWhite")},{value:"#46B946",display:q.Localize("FSC.Configuration.Season.ColorSpring")},{value:"#E0C40B",display:q.Localize("FSC.Configuration.Season.ColorSummer")},{value:"#FF8E47",display:q.Localize("FSC.Configuration.Season.ColorFall")},{value:"#479DFF",display:q.Localize("FSC.Configuration.Season.ColorWinter")}],seasonIcons:{},seasons:this.object.seasons.map((e=>e.toTemplate())),showLeapYearCustomMod:this.object.year.leapYearRule.rule===h.Custom,showLeapYearMonths:this.object.year.leapYearRule.rule!==h.None,time:this.object.time,timeTrackers:{none:"FSC.Configuration.General.None",self:"FSC.Configuration.General.Self","third-party":"FSC.Configuration.General.ThirdParty",mixed:"FSC.Configuration.General.Mixed"},uiElementStates:this.uiElementStates,weekdays:this.object.weekdays.map((e=>e.toTemplate())),yearNameBehaviourOptions:{default:"Default",repeat:"PLAYLIST.SoundRepeat",random:"FSC.Random"}};a.seasonIcons[f.None]=q.Localize("FSC.Configuration.LeapYear.Rules.None"),a.seasonIcons[f.Spring]=q.Localize("FSC.Configuration.Season.ColorSpring"),a.seasonIcons[f.Summer]=q.Localize("FSC.Configuration.Season.ColorSummer"),a.seasonIcons[f.Fall]=q.Localize("FSC.Configuration.Season.ColorFall"),a.seasonIcons[f.Winter]=q.Localize("FSC.Configuration.Season.ColorWinter"),a.seasonIcons[f.Sunrise]=q.Localize("FSC.Dawn"),a.seasonIcons[f.Sunset]=q.Localize("FSC.Dusk"),a.moonIcons[f.NewMoon]=q.Localize("FSC.Moon.Phase.New"),a.moonIcons[f.WaxingCrescent]=q.Localize("FSC.Moon.Phase.WaxingCrescent"),a.moonIcons[f.FirstQuarter]=q.Localize("FSC.Moon.Phase.FirstQuarter"),a.moonIcons[f.WaxingGibbous]=q.Localize("FSC.Moon.Phase.WaxingGibbous"),a.moonIcons[f.Full]=q.Localize("FSC.Moon.Phase.Full"),a.moonIcons[f.WaningGibbous]=q.Localize("FSC.Moon.Phase.WaningGibbous"),a.moonIcons[f.LastQuarter]=q.Localize("FSC.Moon.Phase.LastQuarter"),a.moonIcons[f.WaningCrescent]=q.Localize("FSC.Moon.Phase.WaningCrescent"),a.monthStartingWeekdays.null=q.Localize("Default");for(let e=0;e<this.object.weekdays.length;e++)a.monthStartingWeekdays[this.object.weekdays[e].numericRepresentation.toString()]=this.object.weekdays[e].name;return a.qsCalDate.year=t.year,a.qsCalDate.month=t.month,a.qsCalDate.day=t.day,a.noteCategories=this.object.noteCategories,a}_updateObject(e,t){return Promise.resolve(void 0)}activateListeners(e){super.activateListeners(e),this.object.seasons.forEach((e=>{Re.GetSelector(`sc_season_start_date_${e.id}`,{onDateSelect:this.dateSelectorChange.bind(this,e.id,M.seasonStartingDate)}).activateListeners(),Re.GetSelector(`sc_season_sunrise_time_${e.id}`,{onDateSelect:this.dateSelectorChange.bind(this,e.id,M.seasonSunriseSunsetTime)}).activateListeners()})),this.object.moons.forEach((e=>{Re.GetSelector(`sc_first_new_moon_date_${e.id}`,{onDateSelect:this.dateSelectorChange.bind(this,e.id,M.moonFirstNewMoonDate)}).activateListeners()})),this.appWindow=document.getElementById(Ee.appWindowId),this.appWindow&&(Re.ActivateSelector("quick-setup-predefined-calendar"),this.appWindow.addEventListener("click",this.toggleCalendarSelector.bind(this,!0)),this.appWindow.querySelector(".tabs .fsc-ib .fsc-jb")?.addEventListener("click",this.toggleCalendarSelector.bind(this,!1)),this.appWindow.querySelectorAll(".tabs .fsc-ib ul li[data-calendar]").forEach((e=>{e.addEventListener("click",this.calendarClick.bind(this))})),this.appWindow.querySelectorAll(".tabs .fsc-ib ul li[data-calendar] .fsc-ya").forEach((e=>{e.addEventListener("click",this.removeCalendarClick.bind(this))})),this.appWindow.querySelector(".fsc-gb .fsc-kb .fsc-lb")?.addEventListener("click",this.addNewCalendar.bind(this)),this.appWindow.querySelectorAll(".fsc-mb .fsc-nb .fsc-ob").forEach((e=>{e.addEventListener("click",this.predefinedCalendarClick.bind(this))})),this.appWindow.querySelector(".fsc-mb .fsc-pb .fsc-qb")?.addEventListener("click",this.quickSetupNextClick.bind(this)),this.appWindow.querySelector(".fsc-mb .fsc-pb .fsc-rb")?.addEventListener("click",this.quickSetupBackClick.bind(this)),this.appWindow.querySelector(".fsc-mb .fsc-pb .fsc-sb")?.addEventListener("click",this.quickSetupSaveClick.bind(this)),this.appWindow.querySelectorAll(".fsc-tb").forEach((e=>{e.addEventListener("click",this.toggleMonthShowAdvanced.bind(this))})),this.appWindow.querySelectorAll("input, select").forEach((e=>{e.addEventListener("change",this.inputChange.bind(this)),e.addEventListener("keyup",this.inputChange.bind(this))})),this.appWindow.querySelector(".fsc-ub")?.addEventListener("click",this.dateFormatTableClick.bind(this)),this.appWindow.querySelectorAll(".fsc-vb .fsc-lb").forEach((e=>{e.addEventListener("click",this.addToTable.bind(this))})),this.appWindow.querySelectorAll(".fsc-ya.fsc-za").forEach((e=>{e.addEventListener("click",this.removeFromTable.bind(this))})),this.appWindow.querySelector("#exportCalendar")?.addEventListener("click",this.exportCalendar.bind(this)),this.appWindow.querySelector("#scImportCalendarPicker")?.addEventListener("change",this.importCalendarFileChange.bind(this)),this.appWindow.querySelector("#scSave")?.addEventListener("click",this.saveClick.bind(this,!0)))}inputChange(){this.writeInputValuesToObjects(),this.updateUIFromObject()}toggleCalendarSelector(e=!1){if(this.appWindow){const t=this.appWindow.querySelector(".tabs .fsc-ib ul");t&&ie(t,500,e)}}calendarClick(e){const t=e.currentTarget;if(t){const e=t.getAttribute("data-calendar");if(e&&e!==this.object.id){const t=this.calendars.find((t=>t.id===e));t&&(this.object=t,this._tabs[0].active="generalSettings",this.updateApp())}}}removeCalendarClick(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget;if(t){const e=t.getAttribute("data-calendar");if(e){const t=this.calendars.find((t=>t.id===e));t&&this.confirmationDialog("remove-calendar","remove-calendar",{id:t.id,name:t.name})}}}removeCalendarConfirm(e){e.id&&(Y.removeCalendar(e.id),this.calendars=Y.getAllCalendars(!0),this.object=this.calendars[0],this.updateApp())}async addNewCalendar(e){e.preventDefault();const t=document.getElementById("scAddCalendarName");if(t&&t.value){const e=Y.addTempCalendar(t.value);await Oe.setToPredefined(e,c.Gregorian),this.calendars.push(e),this.object=e,this._tabs[0].active="quickSetup",this.updateApp()}}predefinedCalendarClick(e){const t=e.target?.closest(".fsc-ob");if(t&&this.appWindow){const e=t.classList.contains("fsc-p");this.appWindow.querySelectorAll(".fsc-mb .fsc-nb .fsc-ob").forEach((e=>{e.classList.remove("fsc-p")}));const a=this.appWindow.querySelector(".fsc-mb .fsc-pb .fsc-qb");if(e)this.uiElementStates.selectedPredefinedCalendar="",a&&(a.style.display="none");else{t.classList.add("fsc-p");const e=t.getAttribute("data-calendar");e&&(this.uiElementStates.selectedPredefinedCalendar=e,a&&(a.style.display="block"))}}}quickSetupNextClick(e){e.preventDefault(),this.confirmationDialog("overwrite","predefined",{name:this.object.name})}async quickSetupNextConfirm(){this.uiElementStates.qsNextClicked=!this.uiElementStates.qsNextClicked,await Oe.setToPredefined(this.object,this.uiElementStates.selectedPredefinedCalendar,this.uiElementStates.qsAddNotes),this.updateApp()}quickSetupBackClick(e){if(e.preventDefault(),this.uiElementStates.qsNextClicked=!this.uiElementStates.qsNextClicked,this.appWindow){const e=this.appWindow.querySelector(".fsc-mb .fsc-wb"),t=this.appWindow.querySelector(".fsc-mb .fsc-xb");e&&t&&(ie(e,500),ie(t,500))}}quickSetupSaveClick(e){e.preventDefault(),this.uiElementStates.selectedPredefinedCalendar="",this.uiElementStates.qsNextClicked=!1,this.uiElementStates.qsAddNotes=!0;const t=Re.GetSelector("quick-setup-predefined-calendar",{});this.object.year.numericRepresentation=t.selectedDate.start.year,this.object.year.visibleYear=t.selectedDate.start.year,this.object.year.selectedYear=t.selectedDate.start.year,this.object.updateMonth(t.selectedDate.start.month,"current",!0,t.selectedDate.start.day),this._tabs[0].active="generalSettings",this.save(!1,!1).catch(A.error)}toggleMonthShowAdvanced(e){e.preventDefault();const t=e.currentTarget;if(t){const e=t.closest(".fsc-yb");if(e){const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.months.length&&(this.object.months[t].showAdvanced=!this.object.months[t].showAdvanced,this.updateUIFromObject())}}}writeInputValuesToObjects(){this.appWindow&&(this.globalConfiguration.secondsInCombatRound=Pe("#scSecondsInCombatRound",6,!1,this.appWindow),this.globalConfiguration.combatPauseRule=je("#scCombatPauseClockRule",o.Active,this.appWindow),this.globalConfiguration.calendarsSameTimestamp=Ye("#scCalendarsSameTimestamp",!1,this.appWindow),this.globalConfiguration.syncCalendars=Ye("#scSyncCalendars",!1,this.appWindow),this.globalConfiguration.showNotesFolder=Ye("#scShowNoteFolder",!1,this.appWindow),this.clientSettings.theme=je("#scTheme",i.dark,this.appWindow),this.clientSettings.openOnLoad=Ye("#scOpenOnLoad",!0,this.appWindow),this.clientSettings.openCompact=Ye("#scOpenInCompact",!1,this.appWindow),this.clientSettings.rememberPosition=Ye("#scRememberPos",!0,this.appWindow),this.globalConfiguration.permissions.viewCalendar.player=Ye("#scCalendarVisibleP",!0,this.appWindow),this.globalConfiguration.permissions.viewCalendar.trustedPlayer=Ye("#scCalendarVisibleTP",!0,this.appWindow),this.globalConfiguration.permissions.viewCalendar.assistantGameMaster=Ye("#scCalendarVisibleAGM",!0,this.appWindow),this.globalConfiguration.permissions.addNotes.player=Ye("#scAddNotesP",!1,this.appWindow),this.globalConfiguration.permissions.addNotes.trustedPlayer=Ye("#scAddNotesTP",!1,this.appWindow),this.globalConfiguration.permissions.addNotes.assistantGameMaster=Ye("#scAddNotesAGM",!1,this.appWindow),this.globalConfiguration.permissions.changeDateTime.player=Ye("#scChangeDateTimeP",!1,this.appWindow),this.globalConfiguration.permissions.changeDateTime.trustedPlayer=Ye("#scChangeDateTimeTP",!1,this.appWindow),this.globalConfiguration.permissions.changeDateTime.assistantGameMaster=Ye("#scChangeDateTimeAGM",!1,this.appWindow),this.globalConfiguration.permissions.reorderNotes.player=Ye("#scReorderNotesP",!1,this.appWindow),this.globalConfiguration.permissions.reorderNotes.trustedPlayer=Ye("#scReorderNotesTP",!1,this.appWindow),this.globalConfiguration.permissions.reorderNotes.assistantGameMaster=Ye("#scReorderNotesAGM",!1,this.appWindow),this.globalConfiguration.permissions.changeActiveCalendar.player=Ye("#scChangeActiveCalP",!1,this.appWindow),this.globalConfiguration.permissions.changeActiveCalendar.trustedPlayer=Ye("#scChangeActiveCalTP",!1,this.appWindow),this.globalConfiguration.permissions.changeActiveCalendar.assistantGameMaster=Ye("#scChangeActiveCalAGM",!1,this.appWindow),this.uiElementStates.qsAddNotes=Ye("#scQSAddNotes",!0,this.appWindow),this.object.name=je("#scCalendarName","New Calendar",this.appWindow),this.object.generalSettings.gameWorldTimeIntegration=je("#scGameWorldTime",p.Mixed,this.appWindow),this.object.generalSettings.pf2eSync=Ye("#scPF2ESync",!0,this.appWindow),this.object.generalSettings.dateFormat.date=je("#scDateFormatsDate","MMMM DD, YYYY",this.appWindow),this.object.generalSettings.dateFormat.time=je("#scDateFormatsTime","HH:mm:ss",this.appWindow),this.object.generalSettings.dateFormat.monthYear=je("#scDateFormatsMonthYear","MMMM YAYYYYYZ",this.appWindow),this.object.year.numericRepresentation=Pe("#scCurrentYear",0,!1,this.appWindow),this.object.year.prefix=je("#scYearPreFix","",this.appWindow),this.object.year.postfix=je("#scYearPostFix","",this.appWindow),this.object.year.yearZero=Pe("#scYearZero",0,!1,this.appWindow),this.object.year.yearNamingRule=je("#scYearNameBehaviour",m.Default,this.appWindow),this.object.year.yearNamesStart=Pe("#scYearNamesStart",0,!1,this.appWindow),this.appWindow.querySelectorAll(".fsc-zb .fsc-_b>.fsc-yb:not(.fsc-ac)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.year.yearNames.length&&(this.object.year.yearNames[t]=je(".fsc-bc","New Named Year",e))})),this.appWindow.querySelectorAll(".fsc-cc .fsc-dc>.fsc-yb:not(.fsc-ac)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");if(!isNaN(t)&&t>=0&&t<this.object.months.length){const a=je(".fsc-ec","New Month",e);a!==this.object.months[t].name?this.object.months[t].abbreviation=a.substring(0,3):this.object.months[t].abbreviation=je(".fsc-fc","New Month",e),this.object.months[t].name=a;const s=Pe(".fsc-gc",1,!1,e);s!==this.object.months[t].numberOfDays&&(this.object.months[t].numberOfDays=s,this.object.year.leapYearRule.rule===h.None&&(this.object.months[t].numberOfLeapYearDays=s),this.updateMonthDays(this.object.months[t]));const n=Ye(".fsc-hc",!1,e);n!==this.object.months[t].intercalary&&(this.object.months[t].intercalary=n,this.rebaseMonthNumbers());const i=Ye(".fsc-ic",!1,e);i!==this.object.months[t].intercalaryInclude&&(this.object.months[t].intercalaryInclude=i,this.rebaseMonthNumbers()),this.object.months[t].numericRepresentationOffset=Pe(".fsc-jc",0,!1,e),this.object.months[t].startingWeekday=Pe(".fsc-kc",null,!1,e)}})),this.object.year.showWeekdayHeadings=Ye("#scShowWeekdayHeaders",!0,this.appWindow),this.object.year.firstWeekday=Pe("#scWeekdayFirstDay",0,!1,this.appWindow),this.appWindow.querySelectorAll(".fsc-lc .fsc-k>.fsc-yb:not(.fsc-ac)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");if(!isNaN(t)&&t>=0&&t<this.object.weekdays.length){const a=je(".fsc-mc","New Weekday",e);a!==this.object.weekdays[t].name?(this.object.weekdays[t].name=a,this.object.weekdays[t].abbreviation=a.substring(0,2)):this.object.weekdays[t].abbreviation=je(".fsc-nc","New",e)}})),this.object.year.leapYearRule.rule=je("#scLeapYearRule","none",this.appWindow),this.object.year.leapYearRule.customMod=Pe("#scLeapYearCustomMod",0,!1,this.appWindow),this.appWindow.querySelectorAll(".fsc-oc .fsc-dc>.fsc-yb:not(.fsc-ac)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");if(!isNaN(t)&&t>=0&&t<this.object.months.length){const a=Pe(".fsc-pc",0,!1,e);a!==this.object.months[t].numberOfLeapYearDays&&(this.object.months[t].numberOfLeapYearDays=a,this.updateMonthDays(this.object.months[t]))}})),this.appWindow.querySelectorAll(".fsc-qc .fsc-rc>.fsc-yb:not(.fsc-ac)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.seasons.length&&(this.object.seasons[t].name=je(".fsc-sc","New Season",e),this.object.seasons[t].icon=je(".fsc-tc",f.None,e),this.object.seasons[t].color=je(".fsc-uc","#FFFFFF",e))})),this.appWindow.querySelectorAll(".fsc-vc .fsc-v>.fsc-yb:not(.fsc-ac)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.moons.length&&(this.object.moons[t].name=je(".fsc-wc","New Moon",e),this.object.moons[t].cycleLength=Pe(".fsc-xc",29.53059,!0,e),this.object.moons[t].cycleDayAdjust=Pe(".fsc-yc",0,!0,e),this.object.moons[t].color=je(".fsc-zc","#FFFFFF",e),this.object.moons[t].firstNewMoon.yearReset=je(".fsc-_c","none",e),this.object.moons[t].firstNewMoon.year=Pe(".fsc-ad",0,!1,e),this.object.moons[t].firstNewMoon.yearX=Pe(".fsc-bd",0,!1,e),e.querySelectorAll(".fsc-cd>.fsc-yb:not(.fsc-ac)").forEach((e=>{const a=parseInt(e.getAttribute("data-index")||"");!isNaN(a)&&a>=0&&a<this.object.moons[t].phases.length&&(this.object.moons[t].phases[a].name=je(".fsc-dd","New Phase",e),this.object.moons[t].phases[a].singleDay=Ye(".fsc-ed",!1,e),this.object.moons[t].phases[a].icon=je(".fsc-fd","new",e))})),this.object.moons[t].updatePhaseLength())})),this.object.time.hoursInDay=Pe("#scHoursInDay",24,!1,this.appWindow),this.object.time.minutesInHour=Pe("#scMinutesInHour",60,!1,this.appWindow),this.object.time.secondsInMinute=Pe("#scSecondsInMinute",60,!1,this.appWindow),this.object.generalSettings.showClock=Ye("#scShowClock",!0,this.appWindow),this.object.time.gameTimeRatio=Pe("#scGameTimeRatio",1,!0,this.appWindow),this.object.time.updateFrequency=Pe("#scTimeUpdateFrequency",1,!1,this.appWindow),this.object.time.unifyGameAndClockPause=Ye("#scUnifyClockWithFoundryPause",!1,this.appWindow),this.object.generalSettings.noteDefaultVisibility=Ye("#scDefaultPlayerVisibility",!0,this.appWindow),this.object.generalSettings.postNoteRemindersOnFoundryLoad=Ye("#scPostNoteRemindersOnFoundryLoad",!0,this.appWindow),this.appWindow.querySelectorAll(".fsc-gd .fsc-hd .fsc-yb:not(.fsc-ac)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.noteCategories.length&&(this.object.noteCategories[t].name=je(".fsc-id","New Category",e),this.object.noteCategories[t].color=je(".fsc-jd","New Category",e),this.object.noteCategories[t].textColor=se(this.object.noteCategories[t].color))})))}updateUIFromObject(){if(this.appWindow){const e=this.object.getCurrentDate();this.uiElementStates.dateFormatExample=V({year:e.year,month:e.month,day:e.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.date,this.object),this.uiElementStates.timeFormatExample=V({year:e.year,month:e.month,day:e.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.time,this.object),this.uiElementStates.monthYearFormatExample=V({year:e.year,month:e.month,day:e.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.monthYear,this.object);let t=this.appWindow.querySelector("#scDateFormatsDate")?.closest(".form-group")?.querySelector(".fsc-kd");t&&(t.innerHTML=`<strong>${q.Localize("FSC.Example")}</strong>: ${this.uiElementStates.dateFormatExample}`),t=this.appWindow.querySelector("#scDateFormatsTime")?.closest(".form-group")?.querySelector(".fsc-kd"),t&&(t.innerHTML=`<strong>${q.Localize("FSC.Example")}</strong>: ${this.uiElementStates.timeFormatExample}`),t=this.appWindow.querySelector("#scDateFormatsMonthYear")?.closest(".form-group")?.querySelector(".fsc-kd"),t&&(t.innerHTML=`<strong>${q.Localize("FSC.Example")}</strong>: ${this.uiElementStates.monthYearFormatExample}`),re("#scYearNamesStart",this.object.year.yearNamingRule!==m.Random);for(let e=0;e<this.object.months.length;e++){const t=this.appWindow.querySelector(`.fsc-cc .fsc-dc>.fsc-yb[data-index="${e}"]`);if(t){const a=t.querySelector(".fsc-tb"),s=t.querySelector(".fsc-ld");a&&s&&((s.classList.contains("fsc-c")&&this.object.months[e].showAdvanced||s.classList.contains("fsc-b")&&!this.object.months[e].showAdvanced)&&ie(s,400),this.object.months[e].showAdvanced?(a.classList.remove("fa-chevron-down"),a.classList.add("fa-chevron-up"),a.innerHTML=`<span>${q.Localize("FSC.HideAdvanced")}</span>`):(a.classList.add("fa-chevron-down"),a.classList.remove("fa-chevron-up"),a.innerHTML=`<span>${q.Localize("FSC.ShowAdvanced")}</span>`)),re(".fsc-ic",this.object.months[e].intercalary,t);const n=t.querySelector(".fsc-md");n&&(n.innerText=this.object.months[e].numericRepresentation<0?"IC":this.object.months[e].numericRepresentation.toString())}}re("#scLeapYearCustomMod",this.object.year.leapYearRule.rule===h.Custom);let a=this.appWindow.querySelector("#scLeapYearMonthList");a&&(a.classList.contains("fsc-c")&&this.object.year.leapYearRule.rule!==h.None||a.classList.contains("fsc-b")&&this.object.year.leapYearRule.rule===h.None?ie(a,400):this.object.year.leapYearRule.rule!==h.None?(a.classList.remove("fsc-c"),a.classList.add("fsc-b")):(a.classList.add("fsc-c"),a.classList.remove("fsc-b")));for(let e=0;e<this.object.moons.length;e++){const t=this.appWindow.querySelector(`.fsc-vc .fsc-v>.fsc-yb[data-index="${e}"]`);if(t){re(".fsc-ad",this.object.moons[e].firstNewMoon.yearReset===y.None,t),re(".fsc-bd",this.object.moons[e].firstNewMoon.yearReset===y.XYears,t);for(let a=0;a<this.object.moons[e].phases.length;a++){const s=t.querySelector(`.fsc-cd>.fsc-yb[data-index="${a}"] .fsc-nd`);s&&(s.innerText=`${this.object.moons[e].phases[a].length} ${q.Localize("FSC.Days")}`)}}}}}dateFormatTableClick(){if(this.uiElementStates.dateFormatTableExpanded=!this.uiElementStates.dateFormatTableExpanded,this.appWindow){const e=this.appWindow.querySelector(".fsc-od .fsc-pd .fsc-qd");e&&(e.style.display=this.uiElementStates.dateFormatTableExpanded?"block":"none");const t=this.appWindow.querySelector(".fsc-od .fsc-pd .fsc-ub .fa");t&&(t.className="fa "+(this.uiElementStates.dateFormatTableExpanded?"fa-chevron-up":"fa-chevron-down"))}}rebaseMonthNumbers(){let e=0,t=0;for(let a=0;a<this.object.months.length;a++){const s=this.object.months[a];s.intercalary?(t++,s.numericRepresentation=-1*t):(s.numericRepresentation=e+1,e=s.numericRepresentation)}}addToTable(e){e.preventDefault();const t=e.currentTarget;if(t){switch(t.getAttribute("data-type")){case"month":const t=this.object.months.length+1;this.object.months.push(new Me("New Month",t,0,30)),this.rebaseMonthNumbers();break;case"weekday":const a=this.object.weekdays.length+1;this.object.weekdays.push(new Te(a,"New Weekday"));break;case"season":this.object.seasons.push(new Ne("New Season",1,1));break;case"moon":const s=new Ie("Moon",29.53059);s.firstNewMoon={yearReset:y.None,yearX:0,year:0,month:1,day:1};const n=Number(((s.cycleLength-4)/4).toPrecision(5));s.phases=[{name:q.Localize("FSC.Moon.Phase.New"),length:1,icon:f.NewMoon,singleDay:!0},{name:q.Localize("FSC.Moon.Phase.WaxingCrescent"),length:n,icon:f.WaxingCrescent,singleDay:!1},{name:q.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:f.FirstQuarter,singleDay:!0},{name:q.Localize("FSC.Moon.Phase.WaxingGibbous"),length:n,icon:f.WaxingGibbous,singleDay:!1},{name:q.Localize("FSC.Moon.Phase.Full"),length:1,icon:f.Full,singleDay:!0},{name:q.Localize("FSC.Moon.Phase.WaningGibbous"),length:n,icon:f.WaningGibbous,singleDay:!1},{name:q.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:f.LastQuarter,singleDay:!0},{name:q.Localize("FSC.Moon.Phase.WaningCrescent"),length:n,icon:f.WaningCrescent,singleDay:!1}],this.object.moons.push(s);break;case"moon-phase":const i=e.currentTarget.getAttribute("data-moon-index");if(i){const e=parseInt(i);!isNaN(e)&&e<this.object.moons.length&&(this.object.moons[e].phases.push({name:"Phase",length:1,icon:f.NewMoon,singleDay:!1}),this.object.moons[e].updatePhaseLength())}break;case"year-name":this.object.year.yearNames.push("New Named Year");break;case"note-category":this.object.noteCategories.push({id:U(),name:"New Category",color:"#b13737 ",textColor:"#ffffff"})}this.updateApp()}}removeFromTable(e){e.preventDefault();const t=e.currentTarget;if(t){const a=t.getAttribute("data-type"),s=t.closest(".fsc-yb"),n=t.getAttribute("data-index");if(s&&!n){const e=s.getAttribute("data-index");if(e){const s=parseInt(e);if(!isNaN(s)){switch(a){case"month":if(s<this.object.months.length){this.object.months.splice(s,1),0===this.object.months.length&&this.object.months.push(new Me("New Month",1,0,30));for(let e=0;e<this.object.months.length;e++)this.object.months[e].numericRepresentation=e+1;this.rebaseMonthNumbers()}break;case"weekday":if(s<this.object.weekdays.length){this.object.weekdays.splice(s,1);for(let e=0;e<this.object.weekdays.length;e++)this.object.weekdays[e].numericRepresentation=e+1}break;case"season":s<this.object.seasons.length&&this.object.seasons.splice(s,1);break;case"moon":s<this.object.moons.length&&this.object.moons.splice(s,1);break;case"moon-phase":const e=t.getAttribute("data-moon-index");if(e){const t=parseInt(e);!isNaN(t)&&t<this.object.moons.length&&s<this.object.moons[t].phases.length&&(this.object.moons[t].phases.splice(s,1),this.object.moons[t].updatePhaseLength())}break;case"year-name":s<this.object.year.yearNames.length&&this.object.year.yearNames.splice(s,1);break;case"note-category":s<this.object.noteCategories.length&&this.object.noteCategories.splice(s,1)}this.updateApp()}}}else if(n&&"all"===n){switch(a){case"month":this.object.months=[new Me("New Month",1,0,30)];break;case"weekday":this.object.weekdays=[];break;case"season":this.object.seasons=[];break;case"moon":this.object.moons=[];break;case"moon-phase":const t=e.currentTarget.getAttribute("data-moon-index");if(t){const e=parseInt(t);!isNaN(e)&&e<this.object.moons.length&&(this.object.moons[e].phases=[])}break;case"year-name":this.object.year.yearNames=[];break;case"note-category":this.object.noteCategories=[]}this.updateApp()}}}dateSelectorChange(e,t,a){if(t===M.seasonStartingDate){const t=this.object.seasons.find((t=>t.id===e));if(t){const e=!a.startDate.month||a.startDate.month<0?0:a.startDate.month,s=!a.startDate.day||a.startDate.day<0?0:a.startDate.day;t.startingMonth=e,t.startingDay=s}}else if(t===M.seasonSunriseSunsetTime){const t=this.object.seasons.find((t=>t.id===e));if(t){const e=Y.getActiveCalendar();t.sunriseTime=(a.startDate.hour||0)*e.time.minutesInHour*e.time.secondsInMinute+(a.startDate.minute||0)*e.time.secondsInMinute,t.sunsetTime=(a.endDate.hour||0)*e.time.minutesInHour*e.time.secondsInMinute+(a.endDate.minute||0)*e.time.secondsInMinute}}else if(t===M.moonFirstNewMoonDate){const t=this.object.moons.find((t=>t.id===e));t&&(t.firstNewMoon.month=!a.startDate.month||a.startDate.month<0?0:a.startDate.month,t.firstNewMoon.day=!a.startDate.day||a.startDate.day<0?0:a.startDate.day)}}updateMonthDays(e){e.numberOfDays<0&&(e.numberOfDays=0),e.numberOfLeapYearDays<0&&(e.numberOfLeapYearDays=e.numberOfDays);const t=e.numberOfLeapYearDays>e.numberOfDays?e.numberOfLeapYearDays:e.numberOfDays,a=e.getDay();let s=null;a&&(s=a.numericRepresentation>=e.numberOfDays?1:a.numericRepresentation),e.days=[],e.populateDays(t,s)}confirmationDialog(e,t,a){let s="",n="";"overwrite"===e?(s=q.Localize("FSC.ApplyPredefined"),n=q.Localize("FSC.ApplyPredefinedText").replace("${CAL_NAME}",a.name)):"remove-calendar"===e&&(s=q.Localize("FSC.RemoveCalendar"),n=q.Localize("FSC.RemoveCalendarConfirmText").replace("${CAL_NAME}",a.name));new Dialog({title:s,content:n,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:q.Localize("FSC.Confirm"),callback:this.confirmationDialogYes.bind(this,t,a)},no:{icon:'<i class="fas fa-times"></i>',label:q.Localize("FSC.Cancel")}},default:"no"}).render(!0)}async confirmationDialogYes(e,t){"predefined"===e?this.quickSetupNextConfirm():"remove-calendar"===e&&this.removeCalendarConfirm(t)}async saveClick(e,t){t.preventDefault(),await this.save(e)}async save(e,t=!0){t&&this.writeInputValuesToObjects(),Y.mergeClonedCalendars(),$.save(this.globalConfiguration,this.clientSettings),await Y.getActiveCalendar().syncTime(!0),e?this.closeApp():(this.calendars=Y.cloneCalendars(),this.object=this.calendars[0],this.updateApp())}exportCalendar(e){e.preventDefault();const a={};this.appWindow?.querySelectorAll(".fsc-rd .fsc-sd input").forEach((e=>{const t=e.getAttribute("data-id");t&&(a[t]=e.checked)}));const s={exportVersion:2,globalConfig:a.global?{secondsInCombatRound:this.globalConfiguration.secondsInCombatRound,calendarsSameTimestamp:this.globalConfiguration.calendarsSameTimestamp,syncCalendars:this.globalConfiguration.syncCalendars,showNotesFolder:this.globalConfiguration.showNotesFolder}:{},permissions:a.permissions?this.globalConfiguration.permissions.toConfig():{},calendars:[],notes:{}};for(let e=0;e<this.calendars.length;e++){const n=this.calendars[e].toConfig(),i=n.id.replace("_temp","");a[`${n.id}-notes`]&&(s.notes[i]=[],game.journal?.forEach((e=>{const a=e.getFlag(t,"noteData");a&&a.calendarId&&a.calendarId===i&&s.notes[i].push(e.toObject())}))),a[n.id]&&(n.id=i,s.calendars.push(n))}(0,Le.saveAs)(new Blob([JSON.stringify(s)],{type:"application/json"}),"simple-calendar-export.json")}importCalendarFileChange(e){const t=e.target;if(t&&t.files&&t.files.length&&"application/json"===t.files[0].type){this.appWindow?.querySelector(".fsc-rd .fsc-td")?.classList.remove("fsc-oa");const e=new FileReader;e.onprogress=this.importCalendarProgress.bind(this),e.onload=this.importCalendarRead.bind(this),e.readAsText(t.files[0])}}importCalendarProgress(e){const t=this.appWindow?.querySelector(".fsc-rd .fsc-td .fsc-ud");t&&(t.style.width=e.loaded/e.total*100+"%")}importCalendarRead(e){this.importCalendarProgress(e),this.appWindow?.querySelector(".fsc-rd .fsc-td")?.classList.add("fsc-oa");const t=e.target;if(t&&t.result&&this.appWindow){const e=this.appWindow.querySelector(".fsc-rd .fsc-vd .fsc-wd");if(e){let a=`<p>${q.Localize("FSC.Configuration.ImportExport.ImportDetailsText")}</p><ul class="fsc-sd">`;const s=JSON.parse(t.result.toString());if(!s.hasOwnProperty("exportVersion")){if(s.calendars=[{id:"default",name:"Default"}],s.globalConfig={},s.hasOwnProperty("generalSettings")&&(s.generalSettings.hasOwnProperty("permissions")&&(s.permissions=s.permissions||{},s.permissions.viewCalendar=s.generalSettings.permissions.viewCalendar,s.permissions.addNotes=s.generalSettings.permissions.addNotes,s.permissions.reorderNotes=s.generalSettings.permissions.reorderNotes,s.permissions.changeDateTime=s.generalSettings.permissions.changeDateTime,delete s.generalSettings.permissions),s.calendars[0].general=s.generalSettings,delete s.generalSettings),s.hasOwnProperty("currentDate")&&(s.currentDate.day--,s.currentDate.month--,s.calendars[0].currentDate=s.currentDate,delete s.currentDate),s.hasOwnProperty("leapYearSettings")&&(s.calendars[0].leapYear=s.leapYearSettings,delete s.leapYearSettings),s.hasOwnProperty("monthSettings")&&(s.calendars[0].months=s.monthSettings,delete s.monthSettings),s.hasOwnProperty("moonSettings")){for(let e=0;e<s.moonSettings.length;e++)s.moonSettings[e].firstNewMoon.month--,s.moonSettings[e].firstNewMoon.day--;s.calendars[0].moons=s.moonSettings,delete s.moonSettings}if(s.hasOwnProperty("noteCategories")&&(s.calendars[0].noteCategories=s.noteCategories,delete s.noteCategories),s.hasOwnProperty("seasonSettings")){for(let e=0;e<s.seasonSettings.length;e++)s.seasonSettings[e].startingMonth--,s.seasonSettings[e].startingDay--;s.calendars[0].seasons=s.seasonSettings,delete s.seasonSettings}s.hasOwnProperty("timeSettings")&&(s.globalConfig.secondsInCombatRound=s.timeSettings.secondsInCombatRound,delete s.timeSettings.secondsInCombatRound,s.calendars[0].time=s.timeSettings,delete s.timeSettings),s.hasOwnProperty("weekdaySettings")&&(s.calendars[0].weekdays=s.weekdaySettings,delete s.weekdaySettings),s.hasOwnProperty("yearSettings")&&(s.calendars[0].year=s.yearSettings,delete s.yearSettings)}if(s.hasOwnProperty("globalConfig")&&!isObjectEmpty(s.globalConfig)&&(a+=`<li><label><input type="checkbox" data-id="global" checked /><span class="fa fa-cog"></span>&nbsp;${q.Localize("FSC.Configuration.Global.Title")}</label></li>`),s.hasOwnProperty("permissions")&&!isObjectEmpty(s.permissions)&&(a+=`<li><label><input type="checkbox" data-id="permissions" checked /><span class="fa fa-key"></span>&nbsp;${q.Localize("Permissions")}</label></li>`),s.hasOwnProperty("calendars")&&s.calendars.length)for(let e=0;e<s.calendars.length;e++){a+=`<li><label><input type="checkbox" data-id="${s.calendars[e].id}" checked /><strong><span class="fa fa-calendar"></span> ${s.calendars[e].name}</strong>: ${q.Localize("FSC.CalendarConfiguration")}</label><label>${q.Localize("FSC.ImportInto")}:&nbsp;<select data-for-cal="${s.calendars[e].id}">`;const t=this.calendars.findIndex((t=>0===t.id.indexOf(s.calendars[e].id)));a+=`<option value="new" ${-1===t?"selected":""}>${q.Localize("FSC.NewCalendar")}</option>`;for(let e=0;e<this.calendars.length;e++)a+=`<option value="${this.calendars[e].id}" ${t===e?"selected":""}>${this.calendars[e].name}</option>`;a+="</select></label></li>",s.hasOwnProperty("notes")&&s.notes.hasOwnProperty(s.calendars[e].id)&&(a+=`<li><label><input type="checkbox" data-id="${s.calendars[e].id}-notes" checked /><strong><span class="fa fa-sticky-note"></span> ${s.calendars[e].name}</strong>: ${q.Localize("FSC.CalendarNotes")}</label></label></li>`)}a+=`</ul><button class="fsc-ya fsc-lb" id="importCalendar"><i class="fa fa-file-import"></i> ${q.Localize("FSC.Import")}</button>`,e.innerHTML=a,e.querySelector("#importCalendar")?.addEventListener("click",this.importCalendarSave.bind(this,s))}}}async importCalendarSave(e,a){if(a.preventDefault(),this.appWindow){if(e.hasOwnProperty("globalConfig")&&!isObjectEmpty(e.globalConfig)&&Ye('.fsc-rd .fsc-vd .fsc-wd input[data-id="global"]',!0,this.appWindow)&&(this.globalConfiguration.secondsInCombatRound=e.globalConfig.secondsInCombatRound,this.globalConfiguration.calendarsSameTimestamp=e.globalConfig.calendarsSameTimestamp,this.globalConfiguration.syncCalendars=e.globalConfig.syncCalendars,this.globalConfiguration.showNotesFolder=e.globalConfig.showNotesFolder),e.hasOwnProperty("permissions")&&!isObjectEmpty(e.permissions)&&Ye('.fsc-rd .fsc-vd .fsc-wd input[data-id="permissions"]',!0,this.appWindow)&&this.globalConfiguration.permissions.loadFromSettings(e.permissions),e.hasOwnProperty("calendars")&&e.calendars.length){await G.createJournalDirectory();for(let a=0;a<e.calendars.length;a++){const s=e.calendars[a].id;let n="";if(Ye(`.fsc-rd .fsc-vd .fsc-wd input[data-id="${e.calendars[a].id}"]`,!0,this.appWindow)){const t=je(`.fsc-rd .fsc-vd .fsc-wd select[data-for-cal="${e.calendars[a].id}"]`,"new",this.appWindow),s=this.calendars.find((e=>e.id===t));if(delete e.calendars[a].id,s)s.loadFromSettings(e.calendars[a]);else{const t=Y.addTempCalendar(e.calendars[a].name);t.loadFromSettings(e.calendars[a]),n=t.id}}if(e.hasOwnProperty("notes")&&e.notes.hasOwnProperty(s)&&Ye(`.fsc-rd .fsc-vd .fsc-wd input[data-id="${s}-notes"]`,!0,this.appWindow)){const a=je(`.fsc-rd .fsc-vd .fsc-wd select[data-for-cal="${s}"]`,"new",this.appWindow),i=this.calendars.find((e=>e.id===a)),o=(n||i?.id||s).replace("_temp","");for(let a=0;a<e.notes[s].length;a++){const n=e.notes[s][a];let i=!(n.flags[t].noteData.calendarId===o);if(n.flags[t].noteData.calendarId=o,n.folder=G.noteDirectory?.id,i||!game.journal?.has(n._id)){const e=await JournalEntry.create(n,{keepId:!i});e&&G.addNoteStub(e,o)}else game.journal?.get(n._id)?.update(n)}}}}this._tabs[0].active="generalSettings",this.save(!1,!1).catch(A.error)}}}function We(e,t){return null!==e&&!!(e.isGM||t.player&&e.hasRole(1)||t.trustedPlayer&&e.hasRole(2)||t.assistantGameMaster&&e.hasRole(3)||t.users&&t.users.includes(e.id?e.id:""))}Ee.appWindowId="fsc-xd";class $e extends Application{constructor(){super(),this.clockClass="stopped",this.uiElementStates={"fsc-sd":!1,"fsc-yd":!1,"fsc-zd":!1,compactView:!1,dateTimeUnitOpen:!1,dateTimeUnit:N.Day,dateTimeUnitText:"FSC.Day",searchOptionsOpen:!1,calendarListOpen:!1,primaryCheckRunning:!0},this.search={term:"",results:[],options:{fields:{date:!0,title:!0,details:!0,author:!0,categories:!0}}}}get activeCalendar(){return Y.getActiveCalendar()}get visibleCalendar(){return Y.getVisibleCalendar()}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/main.html",e.title="FSC.Title",e.classes=["simple-calendar"],e.id=this.appWindowId,e.resizable=!1,e}getData(e){let t=!1,a=!1,s=!1,n=We(game.user,$.globalConfiguration.permissions.changeDateTime),i="",o={dateDisplay:"",currentSeasonName:"",currentSeasonIcon:"",selectedDayMoons:[]},r={calendarList:[],search:this.search,showChangeCalendarControls:!1};if(this.activeCalendar.id===this.visibleCalendar.id){a=this.activeCalendar.generalSettings.gameWorldTimeIntegration!==p.ThirdParty,s=this.activeCalendar.generalSettings.showClock&&this.activeCalendar.generalSettings.gameWorldTimeIntegration!==p.ThirdParty;const e=this.visibleCalendar.getMonthAndDayIndex("selected");void 0!==e.month&&void 0!==e.day&&(this.visibleCalendar.months[e.month].days[e.day].current||(t=We(game.user,$.globalConfiguration.permissions.changeDateTime)))}else n&&(i=q.Localize("FSC.ViewingDifferentCalendar"));if(this.uiElementStates.compactView){const e=this.visibleCalendar.getCurrentSeason();if(o.currentSeasonName=e.name,o.currentSeasonIcon=ne(e.icon,e.color,e.color),this.visibleCalendar.moons.length)for(let e=0;e<this.visibleCalendar.moons.length;e++){const t=this.visibleCalendar.moons[e].getMoonPhase(this.visibleCalendar,"current");o.selectedDayMoons.push({name:this.visibleCalendar.moons[e].name,color:this.visibleCalendar.moons[e].color,phase:t,iconSVG:ne(t.icon,"#000000",this.visibleCalendar.moons[e].color)})}}else r.showChangeCalendarControls=We(game.user,$.globalConfiguration.permissions.changeActiveCalendar),r.calendarList=Y.getAllCalendars().map((e=>{const t=e.getCurrentDate(),a=e.time.getCurrentTime();return{id:e.id,name:e.name,date:V({year:t.year,month:t.month,day:t.day,hour:0,minute:0,seconds:0},e.generalSettings.dateFormat.date,e),time:e.generalSettings.showClock?V({year:0,month:1,day:1,hour:a.hour,minute:a.minute,seconds:a.seconds},e.generalSettings.dateFormat.time,e):"",clockRunning:e.timeKeeper.getStatus()===w.Started}}));return{compactViewDisplay:o,mainViewDisplay:r,addNotes:We(game.user,$.globalConfiguration.permissions.addNotes),activeCalendarId:this.activeCalendar.id,calendar:this.visibleCalendar.toTemplate(),changeDateTime:n,clockClass:this.clockClass,isGM:q.IsGm(),isPrimary:$.primary,message:i,uiElementStates:this.uiElementStates,reorderNotes:We(game.user,$.globalConfiguration.permissions.reorderNotes),showClock:this.visibleCalendar.generalSettings.showClock,showDateControls:a,showSetCurrentDate:t,showTimeControls:s}}showApp(){if(We(game.user,$.globalConfiguration.permissions.viewCalendar)){this.visibleCalendar.timeKeeper.getStatus(),w.Started,this.uiElementStates.compactView=q.GetBooleanSettings(n.OpenCompact);const e={};if(q.GetBooleanSettings(n.RememberPosition)){const t=q.GetObjectSettings(n.AppPosition);t.top&&(e.top=t.top),t.left&&(e.left=t.left)}e.classes=["simple-calendar",q.GetStringSettings(n.Theme)],this.render(!0,e)}}async minimize(){this.uiElementStates.compactView=!this.uiElementStates.compactView,this.visibleCalendar.resetMonths("selected"),this.hideDrawers(),this.setWidthHeight(),this.render(!0)}async maximize(){this.uiElementStates.compactView=!1,this.hideDrawers(),this.setWidthHeight(),this.render(!0)}setWidthHeight(){let e=0,t=0;const a=document.querySelector(`#${$e.appWindowId}`);if(a){const s=a.querySelector(".window-header");s&&(t+=s.offsetHeight);const n=a.querySelector(".fsc-_d");if(n)if(this.uiElementStates.compactView)t+=28,t+=8,e=300;else{n.querySelectorAll(".fsc-ae").forEach(((e,a)=>{t+=e.offsetHeight}));const a=n.querySelector(".fsc-e .fsc-g .fsc-h"),s=n.querySelector(".fsc-e .fsc-m .fsc-n"),i=n.querySelector(".fsc-be .fsc-ra"),o=n.querySelector(".fsc-d");let r=0,c=0,l=0,d=0;o&&(d=o.offsetWidth,d+=16),a&&(Array.from(a.children).forEach((e=>{r+=e.offsetWidth})),r+=20),s&&(c=s.offsetWidth),i&&(Array.from(i.children).forEach((e=>{l+=e.offsetWidth})),l+=8),e=Math.max(r,c,l,d),e+=10,e+=70,e+=16,t+=16}this.setPosition({width:e,height:t})}}ensureCurrentDateIsVisible(){const e=document.querySelector(`#${this.id} .fsc-e`),t=e?.offsetHeight;if(e&&t&&t>=500){const a=e.querySelector(".fsc-o.fsc-t"),s=e.querySelector(".fsc-o.fsc-p");let n=null;if(s?n=s:a&&(n=a),null!==n){const a=e.getBoundingClientRect(),s=n.getBoundingClientRect();s.top>=a.top&&s.left>=a.left&&s.bottom<=a.bottom&&s.right<=a.right||(e.scrollTop=s.top-a.top-t/2)}}}appDragMove(e){this._onDragMouseMove(e)}appDragEnd(e){this._onDragMouseUp(e);const t=document.getElementById($e.appWindowId);if(t){const e={};e.top=parseFloat(t.style.top),e.left=parseFloat(t.style.left),q.SaveObjectSetting(n.AppPosition,e,!1).catch(A.error)}}activateListeners(){this.setWidthHeight(),this.ensureCurrentDateIsVisible();const e=document.getElementById($e.appWindowId);if(e){const t=e.querySelector("header");if(t){const a=new Draggable(this,jQuery(e),t,this.options.resizable);a.handlers.dragMove=["mousemove",this.appDragMove.bind(a),!1],a.handlers.dragUp=["mouseup",this.appDragEnd.bind(a),!1]}e.addEventListener("click",this.toggleUnitSelector.bind(this,!0)),this.uiElementStates.compactView?e.classList.add("fsc-ce"):(e.classList.remove("fsc-ce"),me.CalendarFull.ActivateListeners(`sc_${this.visibleCalendar.id}_calendar`,this.changeMonth.bind(this),this.dayClick.bind(this))),me.Clock.ActivateListeners(`sc_${this.visibleCalendar.id}_clock`),e.querySelector(".fsc-de .fsc-ee")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-sd")),e.querySelector(".fsc-de .fsc-fe")?.addEventListener("click",this.configurationClick.bind(this)),e.querySelector(".fsc-de .fsc-ge")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-zd")),e.querySelector(".fsc-de .fsc-he")?.addEventListener("click",this.addNote.bind(this)),e.querySelector(".fsc-de .fsc-ie")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-yd")),e.querySelector(".fsc-de .fsc-je")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-yd")),e.querySelector(".fsc-de .fsc-ke")?.addEventListener("click",this.todayClick.bind(this)),e.querySelector(".fsc-de .fsc-le")?.addEventListener("click",this.dateControlApply.bind(this)),e.querySelector(".fsc-me")?.addEventListener("click",this.startTime.bind(this)),e.querySelector(".fsc-ne")?.addEventListener("click",this.stopTime.bind(this));const a=e.querySelectorAll(".fsc-sd .fsc-oe .fsc-pe .fsc-lb");a.length&&a.forEach((e=>{e.addEventListener("click",this.changeCalendar.bind(this,!1))})),e.querySelectorAll(".fsc-sd .fsc-oe").forEach((e=>{e.addEventListener("click",this.changeCalendar.bind(this,!0))})),e.querySelectorAll(".fsc-yd .fsc-qe").forEach((e=>{e.addEventListener("click",this.viewNote.bind(this)),e.addEventListener("drag",this.noteDrag.bind(this)),e.addEventListener("dragend",this.noteDragEnd.bind(this))})),e.querySelectorAll(".fsc-zd .fsc-yd .fsc-qe").forEach((e=>{e.addEventListener("click",this.viewNote.bind(this))})),e.querySelector(".fsc-zd .fsc-re .fa-search")?.addEventListener("click",this.searchClick.bind(this)),e.querySelector(".fsc-zd .fsc-re .fa-times")?.addEventListener("click",this.searchClearClick.bind(this)),e.querySelector(".fsc-zd .fsc-re input")?.addEventListener("keyup",this.searchBoxChange.bind(this)),e.querySelector(".fsc-zd .fsc-se")?.addEventListener("click",this.searchOptionsToggle.bind(this,!1)),e.querySelectorAll(".fsc-zd .fsc-te input").forEach((e=>{e.addEventListener("change",this.searchOptionsFieldsChange.bind(this))})),e.querySelectorAll(".fsc-ue .fsc-ve").forEach((e=>{e.addEventListener("click",this.toggleUnitSelector.bind(this,!1))})),e.querySelectorAll(".fsc-ue .fsc-we li").forEach((e=>{e.addEventListener("click",this.changeUnit.bind(this))})),e.querySelectorAll(".fsc-xe .fsc-ya").forEach((e=>{e.addEventListener("click",this.timeUnitClick.bind(this))}))}}toggleDrawer(e){this.hideDrawers(e),this.searchOptionsToggle(!0);const t=document.querySelector(`.${e}`);if(t){const a=e.toLowerCase();this.uiElementStates[a]=ie(t,500,!1)}}hideDrawers(e=""){document.querySelectorAll(".fsc-ye").forEach((t=>{if(!t.classList.contains(e)){ie(t,500,!0);const e=t.classList[1].toLowerCase();this.uiElementStates[e]=!1}}))}toggleUnitSelector(e=!1){let t=document.querySelector(".fsc-_d .fsc-we");t&&(this.uiElementStates.dateTimeUnitOpen=ie(t,500,e))}changeUnit(e){const t=e.currentTarget.getAttribute("data-unit");if(t){let e=!1;"year"===t?(this.uiElementStates.dateTimeUnit=N.Year,this.uiElementStates.dateTimeUnitText="FSC.Year",e=!0):"month"===t?(this.uiElementStates.dateTimeUnit=N.Month,this.uiElementStates.dateTimeUnitText="FSC.Month",e=!0):"day"===t?(this.uiElementStates.dateTimeUnit=N.Day,this.uiElementStates.dateTimeUnitText="FSC.Day",e=!0):"hour"===t?(this.uiElementStates.dateTimeUnit=N.Hour,this.uiElementStates.dateTimeUnitText="FSC.Hour",e=!0):"minute"===t?(this.uiElementStates.dateTimeUnit=N.Minute,this.uiElementStates.dateTimeUnitText="FSC.Minute",e=!0):"round"===t?(this.uiElementStates.dateTimeUnit=N.Round,this.uiElementStates.dateTimeUnitText="FSC.Round",e=!0):"seconds"===t&&(this.uiElementStates.dateTimeUnit=N.Second,this.uiElementStates.dateTimeUnitText="FSC.Second",e=!0),e&&this.updateApp()}}changeCalendar(e,t){const a=t.currentTarget;if(a){const t=a.closest(".fsc-oe");if(t){const a=t.getAttribute("data-calid");if(a)if(e||this.activeCalendar.id===a)e&&this.visibleCalendar.id!==a&&Y.setVisibleCalendar(a);else if(q.IsGm()&&$.primary)Y.setActiveCalendar(a);else if(game.users?.find((e=>e.isGM&&e.active))){const e={calendarId:a};O.emit({type:u.setActiveCalendar,data:e}).catch(A.error)}else q.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}}}changeMonth(e,t){this.toggleUnitSelector(!0),this.visibleCalendar.changeMonth(e===v.previous?-1:1),this.setWidthHeight()}dayClick(e){if(this.toggleUnitSelector(!0),e.selectedDates&&e.selectedDates.start.day>=0&&e.selectedDates.start.month>=0&&e.selectedDates.start.month<this.visibleCalendar.months.length){const t=e.selectedDates.start.day;let a=!1;const s=this.visibleCalendar.getMonth("selected");if(s){a=s.getDayIndex("selected")===t&&this.visibleCalendar.year.selectedYear===e.selectedDates.start.year}if(this.visibleCalendar.resetMonths("selected"),!a){const a=this.visibleCalendar.months[e.selectedDates.start.month];t>-1&&(a.selected=!0,a.days[t].selected=!0,this.visibleCalendar.year.selectedYear=this.visibleCalendar.year.visibleYear)}this.updateApp()}}todayClick(e){this.visibleCalendar.resetMonths("selected"),this.visibleCalendar.resetMonths("visible");const t=this.visibleCalendar.getMonth();if(t){const e=t.getDay();e&&(this.visibleCalendar.year.selectedYear=this.visibleCalendar.year.numericRepresentation,this.visibleCalendar.year.visibleYear=this.visibleCalendar.year.numericRepresentation,t.visible=!0,t.selected=!0,e.selected=!0,this.updateApp())}}timeUnitClick(e){e.stopPropagation();const t=e.currentTarget,a=t.getAttribute("data-type"),s=t.getAttribute("data-amount");if(a&&s){const e=parseInt(s);if(!isNaN(e)){const t={};if("round"===a?t.seconds=e*$.globalConfiguration.secondsInCombatRound:"seconds"!==a&&"minute"!==a&&"hour"!==a&&"day"!==a&&"month"!==a&&"year"!==a||(t[a]=e),q.IsGm()&&$.primary)this.activeCalendar.changeDateTime(t,{updateMonth:!1,showWarning:!0});else if(game.users?.find((e=>e.isGM&&e.active))){const e={type:g.changeDateTime,interval:t};O.emit({type:u.dateTimeChange,data:e}).catch(A.error)}else q.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}}else if(a&&("sunrise"===a||"midday"===a||"sunset"===a||"midnight"===a))if(q.IsGm()&&$.primary)ae(a,this.activeCalendar).catch(A.error);else if(game.users?.find((e=>e.isGM&&e.active))){const e={type:g.advanceTimeToPreset,interval:{},presetTimeOfDay:a};O.emit({type:u.dateTimeChange,data:e}).catch(A.error)}else q.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}dateControlApply(e){if(We(game.user,$.globalConfiguration.permissions.changeDateTime)){let e=!1;const t=this.activeCalendar.year.selectedYear,a=this.activeCalendar.getMonthAndDayIndex("selected"),s=this.activeCalendar.getMonth("selected");if(s)if(e=!0,t===this.activeCalendar.year.visibleYear&&s.visible)this.setCurrentDate(t,a.month||0,a.day||0);else{new Dialog({title:q.Localize("FSC.SetCurrentDateDialog.Title"),content:q.Localize("FSC.SetCurrentDateDialog.Content").replace("{DATE}",V({year:t,month:a.month||0,day:a.day||0,hour:0,minute:0,seconds:0},"MMMM DD, YYYY",this.activeCalendar)),buttons:{yes:{label:q.Localize("Yes"),callback:this.setCurrentDate.bind(this,t,a.month||0,a.day||0)},no:{label:q.Localize("No")}},default:"no"}).render(!0)}}else q.UiNotification(q.Localize("FSC.Error.Calendar.GMCurrent"),"warn")}setCurrentDate(e,t,a){if(q.IsGm()&&$.primary)this.activeCalendar.setDateTime({year:e,month:t,day:a},{updateApp:!1,showWarning:!0});else if(game.users?.find((e=>e.isGM&&e.active))){const s={type:g.setDate,interval:{year:e,month:t,day:a}};O.emit({type:u.dateTimeChange,data:s}).catch(A.error)}else q.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}searchClick(){const e=document.getElementById("simpleCalendarSearchBox");e&&(this.search.term=e.value,this.search.results=[],this.search.term&&(this.search.results=G.searchNotes(this.visibleCalendar.id,this.search.term,this.search.options.fields)),this.updateApp())}searchClearClick(){this.search.term="",this.search.results=[],this.updateApp()}searchBoxChange(e){"Enter"===e.key?this.searchClick():this.search.term=e.target.value}searchOptionsToggle(e=!1){let t=document.querySelector(".fsc-zd .fsc-ze");t&&(this.uiElementStates.searchOptionsOpen=ie(t,500,e))}searchOptionsFieldsChange(e){const t=e.target;if(t){const e=t.getAttribute("data-field");e&&this.search.options.fields.hasOwnProperty(e)&&(this.search.options.fields[e]=t.checked)}}configurationClick(e){E.initializeAndShowDialog().catch(A.error)}addNote(e){e.stopPropagation(),G.addNewNote(this.visibleCalendar,"New Note").catch(A.error)}viewNote(e){e.stopPropagation();const t=e.currentTarget.getAttribute("data-index");t?G.showNote(t):A.error("No Data index on note element found.")}updateApp(){this.rendered&&this.render(!0,{})}startTime(){const e=q.GetSceneForCombatCheck(),t=game.combats;t&&t.size>0&&t.find((t=>t.started&&(null!==e&&t.scene&&t.scene.id===e.id||null===e)))?q.UiNotification(game.i18n.localize("FSC.Warn.Time.ActiveCombats"),"warn"):this.activeCalendar.generalSettings.gameWorldTimeIntegration!==p.None&&this.activeCalendar.generalSettings.gameWorldTimeIntegration!==p.Self&&this.activeCalendar.generalSettings.gameWorldTimeIntegration!==p.Mixed||(this.activeCalendar.timeKeeper.start(),this.clockClass=this.activeCalendar.timeKeeper.getStatus(),this.updateApp())}stopTime(){this.activeCalendar.timeKeeper.stop(),this.clockClass=this.activeCalendar.timeKeeper.getStatus(),this.updateApp()}async timeKeepingCheck(){this.activeCalendar.generalSettings.gameWorldTimeIntegration!==p.None&&q.IsGm()&&await this.activeCalendar.syncTime()}noteDrag(e){const t=e.target,a=t.parentNode,s=e.clientX,n=e.clientY;t.classList.add("drag-active");let i=null===document.elementFromPoint(s,n)?t:document.elementFromPoint(s,n);null!==a&&null!==i&&a===i.parentNode&&(i=i!==t.nextSibling?i:i.nextSibling,a.insertBefore(t,i))}noteDragEnd(e){const t=e.target,a=t.parentNode,s=t.getAttribute("data-index");if(t.classList.remove("drag-active"),s&&a){const e=[];for(let t=0;t<a.children.length;t++){const s=a.children[t].getAttribute("data-index");s&&e.push(s)}if(q.IsGm()&&$.primary)G.orderNotesOnDay(this.visibleCalendar.id,e,this.visibleCalendar.getDateTime()).catch(A.error);else if(game.users?.find((e=>e.isGM&&e.active))){const t={calendarId:this.visibleCalendar.id,date:this.visibleCalendar.getDateTime(),newOrder:e};O.emit({type:u.noteUpdate,data:t}).catch(A.error)}else q.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}}}$e.appWindowId="fsc-_e";class Ge{constructor(){this.primary=!1,this.sockets=new De,this.clientSettings={id:"",theme:i.dark,openOnLoad:!0,openCompact:!1,rememberPosition:!0,appPosition:{}},this.globalConfiguration={id:"",version:"",calendarsSameTimestamp:!1,combatPauseRule:o.Active,permissions:new Fe,secondsInCombatRound:6,syncCalendars:!1,showNotesFolder:!1}}get activeCalendar(){return Y.getActiveCalendar()}static ThemeChange(){this.LoadThemeCSS();const e=q.GetStringSettings(n.Theme),t=[i.light,i.dark,i.classic],a=document.getElementById($e.appWindowId);a&&(a.classList.remove(...t),a.classList.add(e));const s=document.getElementById(Ee.appWindowId);s&&(s.classList.remove(...t),s.classList.add(e)),document.querySelectorAll(".journal-sheet.simple-calendar").forEach((a=>{a.classList.remove(...t),a.classList.add(e)}))}static LoadThemeCSS(e=""){const a=e||q.GetStringSettings(n.Theme);if(null===document.head.querySelector(`#theme-${a}`)){const e=document.createElement("link");e.setAttribute("id",`theme-${a}`),e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",getRoute(`modules/${t}/styles/themes/${a}.css`)),document.head.append(e)}}initialize(){this.sockets.initialize(),G.checkNoteTriggers(this.activeCalendar.id,!0)}load(){Ge.LoadThemeCSS();const e=q.GetObjectSettings(n.GlobalConfiguration);this.globalConfiguration.permissions.loadFromSettings(e.permissions),this.globalConfiguration.secondsInCombatRound=e.secondsInCombatRound,this.globalConfiguration.calendarsSameTimestamp=e.calendarsSameTimestamp,this.globalConfiguration.syncCalendars=e.syncCalendars,this.globalConfiguration.showNotesFolder=e.showNotesFolder,e.hasOwnProperty("combatPauseRule")&&(this.globalConfiguration.combatPauseRule=e.combatPauseRule),this.clientSettings.theme=q.GetStringSettings(n.Theme),this.clientSettings.openOnLoad=q.GetBooleanSettings(n.OpenOnLoad),this.clientSettings.openCompact=q.GetBooleanSettings(n.OpenCompact),this.clientSettings.rememberPosition=q.GetBooleanSettings(n.RememberPosition),this.clientSettings.appPosition=q.GetObjectSettings(n.AppPosition)}reload(){Ge.LoadThemeCSS(),this.clientSettings.theme=q.GetStringSettings(n.Theme)}save(e=null,t=null){if(Y.saveCalendars().catch(A.error),e&&t){const a={id:"",version:q.GetModuleVersion(),permissions:e.permissions,secondsInCombatRound:e.secondsInCombatRound,calendarsSameTimestamp:e.calendarsSameTimestamp,syncCalendars:e.syncCalendars,showNotesFolder:e.showNotesFolder,combatPauseRule:e.combatPauseRule};q.SaveStringSetting(n.Theme,t.theme,!1).then(this.reload.bind(this)).catch(A.error),q.SaveBooleanSetting(n.OpenOnLoad,t.openOnLoad,!1).catch(A.error),q.SaveBooleanSetting(n.OpenCompact,t.openCompact,!1).catch(A.error),q.SaveBooleanSetting(n.RememberPosition,t.rememberPosition,!1).catch(A.error),q.SaveObjectSetting(n.AppPosition,t.appPosition,!1).catch(A.error),q.SaveObjectSetting(n.GlobalConfiguration,a).then((()=>O.emit({type:u.mainAppUpdate,data:{}}))).catch(A.error)}}getSceneControlButtons(e){if(We(game.user,this.globalConfiguration.permissions.viewCalendar)){let t=e.find((e=>"token"===e.name));t&&t.hasOwnProperty("tools")&&t.tools.push({name:"calendar",title:"FSC.Title",icon:"fas fa-calendar simple-calendar-icon",button:!0,onClick:x.showApp.bind(x)})}}async renderJournalDirectory(e,t){if(await G.createJournalDirectory(),!this.globalConfiguration.showNotesFolder&&G.noteDirectory){const e=t.find(`.folder[data-folder-id='${G.noteDirectory.id}']`);e&&e.remove()}}renderJournalSheet(e,t){if(!this.globalConfiguration.showNotesFolder&&G.noteDirectory){const e=t.find(`option[value='${G.noteDirectory.id}']`);e&&e.remove()}}gamePaused(e){this.activeCalendar.time.unifyGameAndClockPause&&(game.paused?this.activeCalendar.timeKeeper.setStatus(w.Paused):this.activeCalendar.timeKeeper.start(!0))}worldTimeUpdate(e,t){this.activeCalendar.setFromTime(e,t)}createCombatant(e,t,a){const s=game.combats;if(!this.activeCalendar.time.combatRunning&&s){const t=s.find((t=>t.id===e.parent?.id)),a=q.GetSceneForCombatCheck();t&&t.started&&(null!==a&&t.scene&&t.scene.id===a.id||null===a)&&(this.activeCalendar.time.combatRunning=!0)}}combatUpdate(e,t,a){const s=q.GetSceneForCombatCheck();e.started&&(null!==s&&e.scene&&e.scene.id===s.id||null===s)&&(this.activeCalendar.time.combatRunning=!0,a&&a.hasOwnProperty("advanceTime")&&(0!==a.advanceTime?this.activeCalendar.combatChangeTriggered=!0:this.activeCalendar.processOwnCombatRoundTime(e)))}combatDelete(e){const t=q.GetSceneForCombatCheck();null!==t&&e.scene&&e.scene.id===t.id&&(this.activeCalendar.time.combatRunning=!1)}canvasInit(e){if(q.IsGm()&&this.primary&&this.globalConfiguration.combatPauseRule===o.Current){const t=e.scene?e.scene.id:null,a=game.combats?.filter((e=>e.started&&e.scene?.id===t));this.activeCalendar.time.combatRunning=!(!a||!a.length)}}}const qe={Activate:Re.ActivateSelector.bind(Re),Get:Re.GetSelector.bind(Re),Remove:Re.RemoveSelector.bind(Re)};function Ue(e,t=null,a=null){me.CalendarFull.ActivateListeners(e,t,a)}async function ze(e,t,a,s,n,i,o,r="active",c=null){const l="active"===r?Y.getActiveCalendar():Y.getCalendar(r);return l?await G.createNote(e,t,{calendarId:l.id,startDate:a,endDate:s,allDay:n,order:0,categories:o,repeats:i,remindUsers:[],macro:c||"none"},l,!1):null}function He(e,t="active"){const a="active"===t?Y.getActiveCalendar():Y.getCalendar(t);if(a){if(We(game.user,$.globalConfiguration.permissions.changeDateTime))return ae(e,a).catch(A.error),!0}else A.error(`SimpleCalendar.api.advanceTimeToPreset - Unable to find a calendar with the passed in ID of "${t}"`);return!1}function _e(e,t="active"){const a="active"===t?Y.getActiveCalendar():Y.getCalendar(t);return a?a.changeDateTime(e,{updateMonth:!1,showWarning:!0}):(A.error(`SimpleCalendar.api.changeDate - Unable to find a calendar with the passed in ID of "${t}"`),!1)}function Be(e={},t={},a="active"){const s="active"===a?Y.getActiveCalendar():Y.getCalendar(a);let n=0,i=0,o=0,r=0,c=0,l=0;if(s){n=void 0!==e.year&&void 0!==t.year?e.year===t.year?e.year:Math.floor(Math.random()*(t.year-e.year+1))+e.year:Math.floor(1e4*Math.random()),i=void 0!==e.month&&void 0!==t.month?e.month===t.month?e.month:Math.floor(Math.random()*(t.month-e.month+1))+e.month:Math.floor(Math.random()*s.months.length),(i<0||i>=s.months.length)&&(i=s.months.length-1);let a=s.months[i];o=void 0!==e.day&&void 0!==t.day?e.day===t.day?e.day:Math.floor(Math.random()*(t.day-e.day+1))+e.day:Math.floor(Math.random()*a.days.length),(o<0||o>=a.days.length)&&(o=a.days.length-1),r=void 0!==e.hour&&void 0!==t.hour?e.hour===t.hour?e.hour:Math.floor(Math.random()*(t.hour-e.hour+1))+e.hour:Math.floor(Math.random()*s.time.hoursInDay),c=void 0!==e.minute&&void 0!==t.minute?e.minute===t.minute?e.minute:Math.floor(Math.random()*(t.minute-e.minute+1))+e.minute:Math.floor(Math.random()*s.time.minutesInHour),l=void 0!==e.seconds&&void 0!==t.seconds?e.seconds===t.seconds?e.seconds:Math.floor(Math.random()*(t.seconds-e.seconds+1))+e.seconds:Math.floor(Math.random()*s.time.secondsInMinute)}else A.error(`SimpleCalendar.api.chooseRandomDate - Unable to find a calendar with the passed in ID of "${a}"`);return{year:n,month:i,day:o,hour:r,minute:c,seconds:l}}function Ve(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);if(t){const e=t.timeKeeper.getStatus();return{started:e===w.Started,stopped:e===w.Stopped,paused:e===w.Paused}}return A.error(`SimpleCalendar.api.clockStatus - Unable to find a calendar with the passed in ID of "${e}"`),{started:!1,stopped:!1,paused:!1}}async function Ze(e,t="active"){let a=!1;if(q.IsGm()){const s="active"===t?Y.getActiveCalendar():Y.getCalendar(t);s?("string"==typeof e?a=await Oe.setToPredefined(s,e):Object.keys(e).length&&(s.loadFromSettings(e),a=!0),Y.saveCalendars().catch(A.error)):A.error(`SimpleCalendar.api.configureCalendar - Unable to find a calendar with the passed in ID of "${t}"`)}return a}function Ke(e,t="active"){const a="active"===t?Y.getActiveCalendar():Y.getCalendar(t);return a?te(e,a):(A.error(`SimpleCalendar.api.dateToTimestamp - Unable to find a calendar with the passed in ID of "${t}"`),0)}function Je(e,t="",a="active"){const s="active"===a?Y.getActiveCalendar():Y.getCalendar(a);if(s){const a=e.year?e.year:0;let n=e.month&&e.month>=0?e.month:0;n>=s.months.length&&(n=s.months.length-1);const i=s.months[n];let o=e.day&&e.day>=0?e.day:0;o>=i.days.length&&(o=i.days.length-1);let r=e.hour&&e.hour>=0?e.hour:0;r>=s.time.hoursInDay&&(r=s.time.hoursInDay-1);let c=e.minute&&e.minute>=0?e.minute:0;c>=s.time.minutesInHour&&(c=s.time.minutesInHour-1);let l=e.seconds&&e.seconds>=0?e.seconds:0;return l>=s.time.secondsInMinute&&(l=s.time.secondsInMinute-1),t?V({year:a,month:n,day:o,hour:r,minute:c,seconds:l},t,s):{date:V({year:a,month:n,day:o,hour:0,minute:0,seconds:0},s.generalSettings.dateFormat.date,s),time:V({year:0,month:0,day:0,hour:r,minute:c,seconds:l},s.generalSettings.dateFormat.time,s)}}return A.error(`SimpleCalendar.api.formatDateTime - Unable to find a calendar with the passed in ID of "${a}"`),""}function Xe(){const e=Y.getAllCalendars(),t=[];for(let a=0;a<e.length;a++)t.push(e[a].toConfig());return t}function Qe(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);return t?t.months.map((e=>e.toConfig())):(A.error(`SimpleCalendar.api.getAllMonths - Unable to find a calendar with the passed in ID of "${e}"`),[])}function et(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);return t?t.moons.map((e=>{const a=e.toConfig();return a.currentPhase=e.getMoonPhase(t),a})):(A.error(`SimpleCalendar.api.getAllMoons - Unable to find a calendar with the passed in ID of "${e}"`),[])}function tt(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);return t?t.seasons.map((e=>e.toConfig())):(A.error(`SimpleCalendar.api.getAllSeasons - Unable to find a calendar with the passed in ID of "${e}"`),[])}function at(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);return t?t.weekdays.map((e=>e.toConfig())):(A.error(`SimpleCalendar.api.getAllWeekdays - Unable to find a calendar with the passed in ID of "${e}"`),[])}function st(){return Y.getActiveCalendar().toConfig()}function nt(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);if(t){const e=t.getMonth();if(e){const t=e.getDay();if(t)return t.toConfig()}}else A.error(`SimpleCalendar.api.getCurrentDay - Unable to find a calendar with the passed in ID of "${e}"`);return null}function it(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);if(t){const e=t.getMonth();if(e)return e.toConfig()}else A.error(`SimpleCalendar.api.getCurrentMonth - Unable to find a calendar with the passed in ID of "${e}"`);return null}function ot(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);if(t){const e=t.getMonthAndDayIndex();return t.getSeason(e.month||0,e.day||0).toConfig()}return A.error(`SimpleCalendar.api.getCurrentSeason - Unable to find a calendar with the passed in ID of "${e}"`),{id:"",name:"",icon:f.None,color:"",startingMonth:0,startingDay:0,sunriseTime:0,sunsetTime:0}}function rt(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);if(t){const e=t.getMonthAndDayIndex(),a=t.dayOfTheWeek(t.year.numericRepresentation,e.month||0,e.day||0);return t.weekdays[a].toConfig()}return A.error(`SimpleCalendar.api.getCurrentWeekday - Unable to find a calendar with the passed in ID of "${e}"`),null}function ct(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);return t?t.year.toConfig():(A.error(`SimpleCalendar.api.getCurrentYear - Unable to find a calendar with the passed in ID of "${e}"`),null)}function lt(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);return t?t.year.leapYearRule.toConfig():(A.error(`SimpleCalendar.api.getLeapYearConfiguration - Unable to find a calendar with the passed in ID of "${e}"`),null)}function dt(e="active"){return e="active"===e?Y.getActiveCalendar().id:e,G.getNotes(e).map((e=>game.journal?.get(e.entryId)))}function ht(e,t,a,s="active"){return s="active"===s?Y.getActiveCalendar().id:s,G.getNotesForDay(s,e,t,a).map((e=>game.journal?.get(e.entryId)))}function mt(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);return t?t.time.toConfig():(A.error(`SimpleCalendar.api.getTimeConfiguration - Unable to find a calendar with the passed in ID of "${e}"`),null)}function ut(){return $.primary}function gt(e="active"){if($.primary){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);if(t){const e=t.timeKeeper.getStatus();if(e===w.Started)return t.timeKeeper.start(),t.timeKeeper.getStatus()===w.Paused;if(e===w.Paused)return!0}else A.error(`SimpleCalendar.api.pauseClock - Unable to find a calendar with the passed in ID of "${e}"`)}return!1}async function pt(e){const t=game.journal?.get(e);if(t){if(G.getNoteStub(t)?.isVisible)return G.removeNoteStub(t),x.updateApp(),await t.delete(),await O.emit({type:u.mainAppUpdate,data:{}}),!0}else A.error(`SimpleCalendar.api.removeNote - Unable to find a journal entry with the passed in ID of "${e}"`);return!1}function ft(){if(q.IsGm()&&$.primary){new Dialog({title:q.Localize("FSC.Migration.APIDialog.Title"),content:q.Localize("FSC.Migration.APIDialog.Content"),buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:q.Localize("FSC.Confirm"),callback:W.run.bind(W,!0)},no:{icon:'<i class="fas fa-times"></i>',label:q.Localize("FSC.Cancel")}},default:"no"}).render(!0)}}function yt(e,t={date:!0,title:!0,details:!0,categories:!0,author:!0},a="active"){const s="active"===a?Y.getActiveCalendar():Y.getCalendar(a);let n=[];return s?n=G.searchNotes(s.id,e,t).map((e=>game.journal?.get(e.entryId))):A.error(`SimpleCalendar.api.searchNotes - Unable to find a calendar with the passed in ID of "${a}"`),n}function Ct(e,t="active"){const a="active"===t?Y.getActiveCalendar():Y.getCalendar(t);return a?a.secondsToInterval(e):(A.error(`SimpleCalendar.api.secondsToInterval - Unable to find a calendar with the passed in ID of "${t}"`),{})}function bt(e,t="active"){const a="active"===t?Y.getActiveCalendar():Y.getCalendar(t);return a?a.setDateTime(e,{showWarning:!0}):(A.error(`SimpleCalendar.api.setDate - Unable to find a calendar with the passed in ID of "${t}"`),!1)}function St(e=null,t=!1,a="active"){const s="active"===a?Y.getActiveCalendar():Y.getCalendar(a);if(s){if(Y.setVisibleCalendar(s.id),null!==e){if(e.year||(e.year=s.year.numericRepresentation),!e.month||!e.day){const t=s.getMonthAndDayIndex();e.month||(e.month=t.month||0),e.day||(e.day=t.day||0)}if(Number.isInteger(e.year)&&Number.isInteger(e.month)&&Number.isInteger(e.day)){const t=s.year.leapYearRule.isLeapYear(e.year);s.year.visibleYear=e.year,(-1===e.month||e.month>s.months.length)&&(e.month=s.months.length-1),s.resetMonths("visible"),s.months[e.month].visible=!0;const a=t?s.months[e.month].numberOfLeapYearDays:s.months[e.month].numberOfDays;(-1==e.day||e.day>a)&&(e.day=a-1),s.resetMonths("selected"),s.months[e.month].days[e.day].selected=!0,s.months[e.month].selected=!0,s.year.selectedYear=s.year.visibleYear}else A.error("Main.api.showCalendar: Invalid date passed in.")}}else A.error(`SimpleCalendar.api.showCalendar - Unable to find a calendar with the passed in ID of "${a}"`);x.uiElementStates.compactView=t,x.rendered?x.updateApp():x.showApp()}function wt(e="active"){if($.primary){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);if(t)return t.timeKeeper.start(),!0;A.error(`SimpleCalendar.api.startClock - Unable to find a calendar with the passed in ID of "${e}"`)}return!1}function Dt(e="active"){if($.primary){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);if(t)return t.timeKeeper.stop(),!0;A.error(`SimpleCalendar.api.stopClock - Unable to find a calendar with the passed in ID of "${e}"`)}return!1}function vt(e="active"){const t="active"===e?Y.getActiveCalendar():Y.getCalendar(e);return t?t.toSeconds():(A.error(`SimpleCalendar.api.timestamp - Unable to find a calendar with the passed in ID of "${e}"`),NaN)}function kt(e,t,a="active"){const s="active"===a?Y.getActiveCalendar():Y.getCalendar(a);if(s){const a=s.clone(!1);s.gameSystem===b.PF2E&&s.generalSettings.pf2eSync&&(e+=B.getWorldCreateSeconds(s));const n=a.secondsToDate(e);if(a.updateTime(n),t.year&&a.changeYear(t.year,!1,"current"),t.month){if(t.month>a.months.length){let e=Math.floor(t.month/a.months.length);t.month=t.month-e*a.months.length,a.changeYear(e,!1,"current")}a.changeMonth(t.month,"current")}if(t.day&&a.changeDayBulk(t.day),t.hour&&t.hour>a.time.hoursInDay){const e=Math.floor(t.hour/a.time.hoursInDay);t.hour=t.hour-e*a.time.hoursInDay,a.changeDayBulk(e)}if(t.minute&&t.minute>a.time.hoursInDay*a.time.minutesInHour){const e=Math.floor(t.minute/(a.time.hoursInDay*a.time.minutesInHour));t.minute=t.minute-e*(a.time.hoursInDay*a.time.minutesInHour),a.changeDayBulk(e)}if(t.seconds&&t.seconds>a.time.secondsPerDay){const e=Math.floor(t.seconds/a.time.secondsPerDay);t.seconds=t.seconds-e*a.time.secondsPerDay,a.changeDayBulk(e)}const i=a.time.changeTime(t.hour,t.minute,t.seconds);return 0!==i&&a.changeDay(i),a.toSeconds()}return A.error(`SimpleCalendar.api.timestampPlusInterval - Unable to find a calendar with the passed in ID of "${a}"`),NaN}function Mt(e,t="active"){const a="active"===t?Y.getActiveCalendar():Y.getCalendar(t);return a?ee(e,a):(A.error(`SimpleCalendar.api.stopClock - Unable to find a calendar with the passed in ID of "${t}"`),null)}class Tt{static Register(){Handlebars.registerHelper("sc-date-selector",Tt.DateSelector),Handlebars.registerHelper("sc-full-calendar",Tt.FullCalendar),Handlebars.registerHelper("sc-clock",Tt.Clock),Handlebars.registerHelper("sc-icon",Tt.Icon)}static DateSelector(e){if(e.hash.hasOwnProperty("id")){const t={};e.hash.hasOwnProperty("allowDateRangeSelection")&&(t.allowDateRangeSelection=e.hash.allowDateRangeSelection),e.hash.hasOwnProperty("allowTimeRangeSelection")&&(t.allowTimeRangeSelection=e.hash.allowTimeRangeSelection),e.hash.hasOwnProperty("calendar")?t.calendar=Y.getCalendar(e.hash.calendar)||Y.getActiveCalendar():t.calendar=Y.getActiveCalendar(),e.hash.hasOwnProperty("editYear")&&(t.editYear=e.hash.editYear),e.hash.hasOwnProperty("onDateSelect")&&(t.onDateSelect=e.hash.onDateSelect),e.hash.hasOwnProperty("position")&&(t.position=e.hash.position),e.hash.hasOwnProperty("showCalendarYear")&&(t.showCalendarYear=e.hash.showCalendarYear),e.hash.hasOwnProperty("showDateSelector")&&(t.showDateSelector=e.hash.showDateSelector),e.hash.hasOwnProperty("selectedEndDate")&&(t.selectedEndDate=e.hash.selectedEndDate),e.hash.hasOwnProperty("timeSelected")&&(t.timeSelected=e.hash.timeSelected),e.hash.hasOwnProperty("selectedStartDate")&&(t.selectedStartDate=e.hash.selectedStartDate),e.hash.hasOwnProperty("showTimeSelector")&&(t.showTimeSelector=e.hash.showTimeSelector),e.hash.hasOwnProperty("timeDelimiter")&&(t.timeDelimiter=e.hash.timeDelimiter),e.hash.hasOwnProperty("useCloneCalendars")&&(t.useCloneCalendars=e.hash.useCloneCalendars);const a=e.hash.id,s=Re.GetSelector(a,t);return new Handlebars.SafeString(s.build())}return""}static FullCalendar(e){const t={id:""};let a="";e.hash.hasOwnProperty("allowChangeMonth")&&(t.allowChangeMonth=e.hash.allowChangeMonth),e.hash.hasOwnProperty("colorToMatchSeason")&&(t.colorToMatchSeason=e.hash.colorToMatchSeason),e.hash.hasOwnProperty("cssClasses")&&(t.cssClasses=e.hash.cssClasses),e.hash.hasOwnProperty("date")&&(t.date=Object.assign({},e.hash.date)),e.hash.hasOwnProperty("editYear")&&(t.editYear=e.hash.editYear),e.hash.hasOwnProperty("id")&&(t.id=e.hash.id),e.hash.hasOwnProperty("calendarId")&&(a=e.hash.calendarId),e.hash.hasOwnProperty("showCurrentDate")&&(t.showCurrentDate=e.hash.showCurrentDate),e.hash.hasOwnProperty("showSeasonName")&&(t.showSeasonName=e.hash.showSeasonName),e.hash.hasOwnProperty("showNoteCount")&&(t.showNoteCount=e.hash.showNoteCount),e.hash.hasOwnProperty("showMoonPhases")&&(t.showMoonPhases=e.hash.showMoonPhases),e.hash.hasOwnProperty("showYear")&&(t.showYear=e.hash.showYear),e.hash.hasOwnProperty("theme")&&(t.theme=e.hash.theme,"none"!==t.theme&&"auto"!==t.theme&&Ge.LoadThemeCSS(t.theme));let s=Y.getCalendar(a);return s||(s=Y.getActiveCalendar()),new Handlebars.SafeString(me.CalendarFull.Render(s,t))}static Clock(e){const t={id:""};let a="";e.hash.hasOwnProperty("id")&&(t.id=e.hash.id),e.hash.hasOwnProperty("calendarId")&&(a=e.hash.calendarId),e.hash.hasOwnProperty("theme")&&(t.theme=e.hash.theme,"none"!==t.theme&&"auto"!==t.theme&&Ge.LoadThemeCSS(t.theme));let s=Y.getCalendar(a);return s||(s=Y.getActiveCalendar()),new Handlebars.SafeString(me.Clock.Render(s,t))}static Icon(e){if(e.hash.hasOwnProperty("name")){let t="#000000",a="#000000";return e.hash.hasOwnProperty("stroke")&&(t=e.hash.stroke),e.hash.hasOwnProperty("fill")&&(a=e.hash.fill),new Handlebars.SafeString(ne(e.hash.name,t,a))}return""}}class Nt extends ve{constructor(){super(),this.rule=h.None,this.customMod=0}clone(){const e=new Nt;return e.id=this.id,e.rule=this.rule,e.customMod=this.customMod,e}toConfig(){return{id:this.id,rule:this.rule,customMod:this.customMod}}toTemplate(){return{...super.toTemplate(),rule:this.rule,customMod:this.customMod}}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),e.hasOwnProperty("rule")&&(this.rule=e.rule),e.hasOwnProperty("customMod")&&(this.customMod=e.customMod))}isLeapYear(e){const t=Y.getActiveCalendar();return t.gameSystem===b.PF2E&&t.generalSettings.pf2eSync&&B.checkLeapYearRules(this),this.rule===h.Gregorian?e%4==0&&(e%100!=0||e%100==0&&e%400==0):this.rule===h.Custom&&e%this.customMod==0}howManyLeapYears(e){let t=0;return this.rule===h.Gregorian?t=Math.floor(e/4)-Math.floor(e/100)+Math.floor(e/400):this.rule===h.Custom&&0!==this.customMod&&(t=Math.floor(e/this.customMod)),this.isLeapYear(e)&&t>0&&(t-=1),t}previousLeapYear(e){if(this.rule===h.Gregorian||this.rule===h.Custom&&0!==this.customMod){let t=e;for(;Number.isInteger(t)&&!this.isLeapYear(t);)t--;return t}return null}fraction(e){const t=this.previousLeapYear(e);if(null!==t&&0!==t){const a=e%t;return this.rule===h.Gregorian?a/4:a/this.customMod}return 0}}class It extends ve{constructor(e){super("",e),this.prefix="",this.postfix="",this.showWeekdayHeadings=!0,this.firstWeekday=0,this.yearZero=0,this.yearNames=[],this.yearNamesStart=0,this.yearNamingRule=m.Default,this.selectedYear=e,this.visibleYear=e,this.leapYearRule=new Nt}toConfig(){return{id:this.id,numericRepresentation:this.numericRepresentation,prefix:this.prefix,postfix:this.postfix,showWeekdayHeadings:this.showWeekdayHeadings,firstWeekday:this.firstWeekday,yearZero:this.yearZero,yearNames:this.yearNames,yearNamingRule:this.yearNamingRule,yearNamesStart:this.yearNamesStart}}toTemplate(){return{...super.toTemplate(),firstWeekday:this.firstWeekday,numericRepresentation:this.numericRepresentation,yearZero:this.yearZero,yearNames:this.yearNames,yearNamesStart:this.yearNamesStart,yearNamingRule:this.yearNamingRule}}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.numericRepresentation=e.numericRepresentation,this.prefix=e.prefix,this.postfix=e.postfix,e.hasOwnProperty("showWeekdayHeadings")&&(this.showWeekdayHeadings=e.showWeekdayHeadings),e.hasOwnProperty("firstWeekday")&&(this.firstWeekday=e.firstWeekday),e.hasOwnProperty("yearZero")&&(this.yearZero=e.yearZero),e.hasOwnProperty("yearNames")&&(this.yearNames=e.yearNames),e.hasOwnProperty("yearNamingRule")&&(this.yearNamingRule=e.yearNamingRule),e.hasOwnProperty("yearNamesStart")&&(this.yearNamesStart=e.yearNamesStart))}clone(){const e=new It(this.numericRepresentation);return e.id=this.id,e.postfix=this.postfix,e.prefix=this.prefix,e.yearZero=this.yearZero,e.selectedYear=this.selectedYear,e.visibleYear=this.visibleYear,e.leapYearRule=this.leapYearRule.clone(),e.showWeekdayHeadings=this.showWeekdayHeadings,e.firstWeekday=this.firstWeekday,e.yearNames=this.yearNames.map((e=>e)),e.yearNamesStart=this.yearNamesStart,e.yearNamingRule=this.yearNamingRule,e}getDisplayName(e=!1){let t;const a=this.getYearName(e?this.selectedYear:this.visibleYear);return t=a?`${this.prefix} ${a} (${e?this.selectedYear.toString():this.visibleYear.toString()}) ${this.postfix}`:`${""!==this.prefix?this.prefix+" ":""}${e?this.selectedYear.toString():this.visibleYear.toString()}${""!==this.postfix?" "+this.postfix:""}`,t}getYearName(e){let t="";if(this.yearNames.length){let a=0;if(this.yearNamingRule===m.Repeat)a=((e-this.yearNamesStart)%this.yearNames.length+this.yearNames.length)%this.yearNames.length;else if(this.yearNamingRule===m.Random){a=((function(e){let t=0;if(0==e.length)return t;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t&=t;return t}(`${e}-AbCxYz`)-this.yearNamesStart)%this.yearNames.length+this.yearNames.length)%this.yearNames.length}else a=Math.abs(this.yearNamesStart-e),a>=this.yearNames.length&&(a=this.yearNames.length-1);t=this.yearNames[a]}return t}}class Lt extends ve{constructor(){super(),this.gameWorldTimeIntegration=p.Mixed,this.showClock=!0,this.noteDefaultVisibility=!0,this.postNoteRemindersOnFoundryLoad=!0,this.pf2eSync=!0,this.dateFormat={date:"MMMM DD, YYYY",time:"HH:mm:ss",monthYear:"MMMM YAYYYYYZ"}}clone(){const e=new Lt;return e.id=this.id,e.gameWorldTimeIntegration=this.gameWorldTimeIntegration,e.showClock=this.showClock,e.noteDefaultVisibility=this.noteDefaultVisibility,e.postNoteRemindersOnFoundryLoad=this.postNoteRemindersOnFoundryLoad,e.pf2eSync=this.pf2eSync,e.dateFormat.date=this.dateFormat.date,e.dateFormat.time=this.dateFormat.time,e.dateFormat.monthYear=this.dateFormat.monthYear,e}toTemplate(){return{...super.toTemplate(),gameWorldTimeIntegration:this.gameWorldTimeIntegration,showClock:this.showClock,noteDefaultVisibility:this.noteDefaultVisibility,postNoteRemindersOnFoundryLoad:this.postNoteRemindersOnFoundryLoad,pf2eSync:this.pf2eSync,dateFormat:this.dateFormat}}toConfig(){return{id:this.id,gameWorldTimeIntegration:this.gameWorldTimeIntegration,showClock:this.showClock,noteDefaultVisibility:this.noteDefaultVisibility,postNoteRemindersOnFoundryLoad:this.postNoteRemindersOnFoundryLoad,pf2eSync:this.pf2eSync,dateFormat:this.dateFormat}}loadFromSettings(e){e&&Object.keys(e).length&&(this.id=e.id,this.gameWorldTimeIntegration=e.gameWorldTimeIntegration,this.showClock=e.showClock,this.noteDefaultVisibility=e.noteDefaultVisibility,e.hasOwnProperty("pf2eSync")&&(this.pf2eSync=e.pf2eSync),e.hasOwnProperty("dateFormat")&&(this.dateFormat=e.dateFormat),e.hasOwnProperty("postNoteRemindersOnFoundryLoad")&&(this.postNoteRemindersOnFoundryLoad=e.postNoteRemindersOnFoundryLoad))}}class Ot{constructor(e,t){this.status=w.Stopped,this.pauseClicked=!1,this.updateListeners=[],this.calendarId=e,this.updateFrequency=t}start(e=!1){this.pauseClicked=!1;const t=Y.getCalendar(this.calendarId);t&&(this.status!==w.Started?(this.pauseClicked=!1,t.time.unifyGameAndClockPause&&!e&&game.togglePause(!1,!0),void 0===this.intervalNumber?(this.intervalNumber=window.setInterval(this.interval.bind(this),1e3*this.updateFrequency),this.updateStatus(),q.IsGm()&&$.primary&&(this.saveInterval(),this.saveIntervalNumber=window.setInterval(this.saveInterval.bind(this),1e4))):this.updateStatus()):(this.pauseClicked=!0,this.updateStatus(w.Paused),t.time.unifyGameAndClockPause&&game.togglePause(!0,!0)))}stop(){if(this.pauseClicked=!1,void 0!==this.intervalNumber){window.clearInterval(this.intervalNumber),window.clearInterval(this.saveIntervalNumber);const e=Y.getCalendar(this.calendarId);e&&e.time.unifyGameAndClockPause&&game.togglePause(!0,!0),this.intervalNumber=void 0,this.saveIntervalNumber=void 0,this.updateStatus(),q.IsGm()&&$.primary&&this.saveInterval(!0)}}pause(){this.status===w.Started&&(this.pauseClicked=!0,this.status=w.Paused)}getStatus(){return this.status}setStatus(e){this.updateStatus(e)}interval(){if(this.updateStatus(),this.status===w.Started){const e=Y.getCalendar(this.calendarId);if(e){const t=e.time.gameTimeRatio*this.updateFrequency;e.changeDateTime({seconds:t},{updateApp:!1,save:!1}),q.IsGm()&&$.primary&&e.generalSettings.gameWorldTimeIntegration===p.None&&O.emit({type:u.clock,data:this.status}).catch(A.error),fe.emit(S.DateTimeChange,e,t),this.callListeners()}}}saveInterval(e=!1){if(this.status===w.Started){const e=Y.getCalendar(this.calendarId);e&&q.IsGm()&&$.primary&&(e.generalSettings.gameWorldTimeIntegration===p.None?O.emit({type:u.clock,data:this.status}).catch(A.error):e.syncTime().catch(A.error),Y.saveCalendars().catch(A.error))}}updateStatus(e=null){const t=Y.getCalendar(this.calendarId);if(t){const a=this.status;null!==e?this.status=e:void 0!==this.intervalNumber?this.pauseClicked||game.paused||t.time.combatRunning?this.status=w.Paused:this.status=w.Started:this.status=w.Stopped,a!==this.status&&(fe.emit(S.ClockStartStop,t),this.callListeners(),this.emitSocket())}}emitSocket(){if(q.IsGm()&&$.primary){const e={type:u.clock,data:this.status};O.emit(e).catch(A.error)}}registerUpdateListener(e,t){const a=this.updateListeners.findIndex((t=>t.key===e));-1===a?this.updateListeners.push({key:e,func:t}):this.updateListeners[a].func=t}callListeners(){for(let e=0;e<this.updateListeners.length;e++)this.updateListeners[e].func(this.status)}}class At extends ve{constructor(e=24,t=60,a=60){super(),this.seconds=0,this.combatRunning=!1,this.unifyGameAndClockPause=!1,this.updateFrequency=1,this.hoursInDay=e,this.minutesInHour=t,this.secondsInMinute=a,this.gameTimeRatio=1,this.secondsPerDay=this.hoursInDay*this.minutesInHour*this.secondsInMinute}toConfig(){return{id:this.id,hoursInDay:this.hoursInDay,minutesInHour:this.minutesInHour,secondsInMinute:this.secondsInMinute,gameTimeRatio:this.gameTimeRatio,unifyGameAndClockPause:this.unifyGameAndClockPause,updateFrequency:this.updateFrequency}}clone(){const e=new At(this.hoursInDay,this.minutesInHour,this.secondsInMinute);return e.id=this.id,e.seconds=this.seconds,e.gameTimeRatio=this.gameTimeRatio,e.combatRunning=this.combatRunning,e.unifyGameAndClockPause=this.unifyGameAndClockPause,e.updateFrequency=this.updateFrequency,e}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.hoursInDay=e.hoursInDay,this.minutesInHour=e.minutesInHour,this.secondsInMinute=e.secondsInMinute,this.gameTimeRatio=e.gameTimeRatio,this.secondsPerDay=this.hoursInDay*this.minutesInHour*this.secondsInMinute,e.hasOwnProperty("unifyGameAndClockPause")&&(this.unifyGameAndClockPause=e.unifyGameAndClockPause),e.hasOwnProperty("updateFrequency")&&(this.updateFrequency=e.updateFrequency))}getCurrentTime(){let e=this.seconds,t=0,a=0;return e>=this.secondsInMinute&&(t=Math.floor(e/this.secondsInMinute),e-=t*this.secondsInMinute),t>=this.minutesInHour&&(a=Math.floor(t/this.minutesInHour),t-=a*this.minutesInHour),e=Math.floor(e),{hour:a,minute:t,seconds:e}}toString(){const e=this.getCurrentTime(),t=Y.getActiveCalendar();let a=t.getMonthAndDayIndex();return V({year:t.year.numericRepresentation,month:a.month||0,day:a.day||0,...e},t.generalSettings.dateFormat.time,t)}setTime(e=0,t=0,a=0){this.seconds=e*this.minutesInHour*this.secondsInMinute+t*this.secondsInMinute+a}changeTime(e=0,t=0,a=0){a=+a.toFixed(3);const s=e*this.minutesInHour*this.secondsInMinute+t*this.secondsInMinute+a,n=this.seconds+s;if(n>=this.secondsPerDay){this.seconds=0;return this.changeTime(0,0,n-this.secondsPerDay)+1}if(n<0){this.seconds=this.secondsPerDay;return this.changeTime(0,0,n)+-1}return this.seconds=n,0}getTotalSeconds(e,t=!0){return e*this.hoursInDay*this.minutesInHour*this.secondsInMinute+(t?this.seconds:0)}async setWorldTime(e){let t=e-game.time.worldTime;await game.time.advance(t)}}class Rt extends ve{constructor(e,t,a={id:""}){if(super(t),this.generalSettings=new Lt,this.months=[],this.weekdays=[],this.seasons=[],this.moons=[],this.notes=[],this.noteCategories=[],this.timeChangeTriggered=!1,this.combatChangeTriggered=!1,this.id=e||U(),this.time=new At,this.year=new It(0),this.timeKeeper=new Ot(this.id,this.time.updateFrequency),Object.keys(a).length>1&&this.loadFromSettings(a),this.gameSystem=b.Other,game.system)switch(game.system.id){case b.DnD5E:this.gameSystem=b.DnD5E;break;case b.PF1E:this.gameSystem=b.PF1E;break;case b.PF2E:this.gameSystem=b.PF2E;break;case b.WarhammerFantasy4E:this.gameSystem=b.WarhammerFantasy4E}}clone(e=!0){const t=new Rt(this.id,this.name);return t.id=this.id,t.name=this.name,t.gameSystem=this.gameSystem,t.generalSettings=this.generalSettings.clone(),t.year=this.year.clone(),t.months=this.months.map((e=>e.clone())),t.weekdays=this.weekdays.map((e=>e.clone())),t.seasons=this.seasons.map((e=>e.clone())),t.moons=this.moons.map((e=>e.clone())),t.time=this.time.clone(),e&&(t.noteCategories=this.noteCategories.map((e=>({id:e.id,name:e.name,textColor:e.textColor,color:e.color})))),t}toTemplate(){let e,t,a=this.year.selectedYear;const s=this.getMonthAndDayIndex(),n=this.getMonthAndDayIndex("selected"),i=this.getMonthAndDayIndex("visible");void 0!==n.month?(e=n.month,t=n.day||0):(a=this.year.numericRepresentation,e=s.month||0,t=s.day||0);const o=G.getNoteCountsForDay(this.id,a,e,t);return{...super.toTemplate(),calendarDisplayId:`sc_${this.id}_calendar`,clockDisplayId:`sc_${this.id}_clock`,currentYear:this.year.toTemplate(),gameSystem:this.gameSystem,id:this.id,name:this.name,selectedDay:{dateDisplay:V({year:a,month:e,day:t,hour:0,minute:0,seconds:0},this.generalSettings.dateFormat.date,this),noteCount:o.count,noteReminderCount:o.reminderCount,notes:G.getNotesForDay(this.id,a,e,t)},visibleDate:{year:this.year.visibleYear,month:i.month||0}}}toConfig(){return{id:this.id,name:this.name,currentDate:this.getCurrentDate(),general:this.generalSettings.toConfig(),leapYear:this.year.leapYearRule.toConfig(),months:this.months.map((e=>e.toConfig())),moons:this.moons.map((e=>e.toConfig())),noteCategories:this.noteCategories,seasons:this.seasons.map((e=>e.toConfig())),time:this.time.toConfig(),weekdays:this.weekdays.map((e=>e.toConfig())),year:this.year.toConfig()}}loadFromSettings(e){e.id&&(this.id=e.id,this.timeKeeper.calendarId=this.id),e.name&&(this.name=e.name),e.year?this.year.loadFromSettings(e.year):e.yearSettings?this.year.loadFromSettings(e.yearSettings):(A.warn(`Invalid year configuration found when loading calendar "${this.name}", setting year to default configuration`),this.year=new It(0));const t=e.months||e.monthSettings;if(Array.isArray(t)){this.months=[];for(let e=0;e<t.length;e++){const a=new Me;a.loadFromSettings(t[e]),this.months.push(a)}}const a=e.weekdays||e.weekdaySettings;if(Array.isArray(a)){this.weekdays=[];for(let e=0;e<a.length;e++){const t=new Te;t.loadFromSettings(a[e]),this.weekdays.push(t)}}e.leapYear?this.year.leapYearRule.loadFromSettings(e.leapYear):e.leapYearSettings&&this.year.leapYearRule.loadFromSettings(e.leapYearSettings),e.time?(this.time.loadFromSettings(e.time),this.timeKeeper.updateFrequency=this.time.updateFrequency):e.timeSettings&&(this.time.loadFromSettings(e.timeSettings),this.timeKeeper.updateFrequency=this.time.updateFrequency);const s=e.seasons||e.seasonSettings;if(Array.isArray(s)){this.seasons=[];for(let e=0;e<s.length;e++){const t=new Ne;t.loadFromSettings(s[e]),this.seasons.push(t)}}const n=e.moons||e.moonSettings;if(Array.isArray(n)){this.moons=[];for(let e=0;e<n.length;e++){const t=new Ie;t.loadFromSettings(n[e]),this.moons.push(t)}}e.general?this.generalSettings.loadFromSettings(e.general):e.generalSettings&&this.generalSettings.loadFromSettings(e.generalSettings),e.noteCategories&&(this.noteCategories=e.noteCategories),e.currentDate?(this.year.numericRepresentation=e.currentDate.year,this.year.selectedYear=e.currentDate.year,this.year.visibleYear=e.currentDate.year,this.resetMonths("current"),this.resetMonths("visible"),e.currentDate.month>-1&&e.currentDate.month<this.months.length?(this.months[e.currentDate.month].current=!0,this.months[e.currentDate.month].visible=!0,e.currentDate.day>-1&&e.currentDate.day<this.months[e.currentDate.month].days.length?this.months[e.currentDate.month].days[e.currentDate.day].current=!0:(A.warn("Saved current day could not be found in this month, perhaps number of days has changed. Setting current day to first day of month"),this.months[e.currentDate.month].days[0].current=!0)):this.months.length&&(A.warn("Saved current month could not be found, perhaps months have changed. Setting current month to the first month"),this.months[0].current=!0,this.months[0].visible=!0,this.months[0].days[0].current=!0),this.time.seconds=e.currentDate.seconds,void 0===this.time.seconds&&(this.time.seconds=0)):this.months.length?(A.warn("No current date setting found, setting default current date."),this.months[0].current=!0,this.months[0].visible=!0,this.months[0].days[0].current=!0):A.error("Error setting the current date.")}getCurrentDate(){const e=this.getMonthAndDayIndex();return{year:this.year.numericRepresentation,month:e.month||0,day:e.day||0,seconds:this.time.seconds}}getDateTime(){const e={year:0,month:0,day:0,hour:0,minute:0,seconds:0},t=this.getMonthAndDayIndex("selected"),a=this.getMonthAndDayIndex();if(void 0!==t.month)e.year=this.year.selectedYear,e.month=t.month,e.day=t.day||0;else{e.year=this.year.numericRepresentation,e.month=a.month||0,e.day=a.day||0;const t=this.time.getCurrentTime();e.hour=t.hour,e.minute=t.minute,e.seconds=t.seconds}return e}getCurrentSeason(){let e=this.getMonthIndex("visible");-1===e&&(e=0);let t=this.months[e].getDayIndex("selected");-1===t&&(t=this.months[e].getDayIndex(),-1===t&&(t=0));const a=this.getSeason(e,t);return{name:a.name,color:a.color,icon:a.icon}}getMonth(e="current"){const t=e.toLowerCase();return this.months.find((e=>e[t]))}getMonthIndex(e="current"){const t=e.toLowerCase();return this.months.findIndex((e=>e[t]))}getMonthAndDayIndex(e="current"){const t=e.toLowerCase(),a={month:0,day:0},s=this.months.findIndex((e=>e[t]));if(s>-1){a.month=s;const e=this.months[s].getDayIndex(t);e>-1&&(a.day=e)}else a.month=void 0;return a}getSeason(e,t){let a=new Ne("",0,0);if(t>=0&&e>=0){let s=null;const n=this.seasons.sort(((e,t)=>e.startingMonth-t.startingMonth||e.startingDay-t.startingDay));for(let a=0;a<n.length;a++)(n[a].startingMonth===e&&n[a].startingDay<=t||n[a].startingMonth<e)&&(s=n[a]);null===s&&(s=n[n.length-1]),s&&(a=s.clone())}return a}getSunriseSunsetTime(e,t,a,s=!0,n=!0){const i=Y.getActiveCalendar(),o=this.seasons.sort(((e,t)=>e.startingMonth-t.startingMonth||e.startingDay-t.startingDay));let r=o.length-1;for(let e=0;e<o.length;e++)(o[e].startingMonth===t&&o[e].startingDay<=a||o[e].startingMonth<t)&&(r=e);const c=(r+1)%this.seasons.length;if(r<o.length&&c<o.length){let l=o[r];const d=o[c];let h=e,m=h;r===o.length-1&&((t<o[r].startingMonth||o[r].startingMonth===t&&a<o[r].startingDay)&&(h=e-1),m=h+1);const u=X(i,{year:h,month:l.startingMonth,day:l.startingDay,hour:0,minute:0,seconds:0},{year:e,month:t,day:a,hour:0,minute:0,seconds:0}),g=X(i,{year:h,month:l.startingMonth,day:l.startingDay,hour:0,minute:0,seconds:0},{year:m,month:d.startingMonth,day:d.startingDay,hour:0,minute:0,seconds:0}),p=u*((s?d.sunriseTime-l.sunriseTime:d.sunsetTime-l.sunsetTime)/g),f=Math.round((s?l.sunriseTime:l.sunsetTime)+p);return n?te({year:e,month:t,day:a,hour:0,minute:0,seconds:0},i)+f:f}return 0}daysIntoWeeks(e,t,a){const s=[],n=this.monthStartingDayOfWeek(e,t),i=this.year.leapYearRule.isLeapYear(t),o=this.months[e].getDaysForTemplate(i);if(o.length&&a>0){const e=[];let t=0;for(let s=0;s<a;s++)if(s<n)e.push(!1);else{const a=s-n;a<o.length?(e.push(o[a]),t++):e.push(!1)}s.push(e);const i=Math.ceil((o.length-t)/a);for(let e=0;e<i;e++){const n=[];for(let s=0;s<a;s++){const i=t+e*a+s;i<o.length?n.push(o[i]):n.push(!1)}s.push(n)}}return s}dayOfTheWeek(e,t,a){if(this.weekdays.length){const s=Y.getActiveCalendar();if(s.gameSystem===b.PF2E&&s.generalSettings.pf2eSync){const e=B.weekdayAdjust();void 0!==e&&(this.year.firstWeekday=e)}const n=this.months[t];let i;return i=n&&null!==n.startingWeekday?a+n.startingWeekday-1:this.dateToDays(e,t,a)+this.year.firstWeekday,(i%this.weekdays.length+this.weekdays.length)%this.weekdays.length}return 0}monthStartingDayOfWeek(e,t){return e>-1&&e<this.months.length&&(!this.months[e].intercalary||this.months[e].intercalaryInclude)?this.dayOfTheWeek(t,e,0):0}resetMonths(e="current"){const t=e.toLowerCase();this.months.forEach((a=>{"visible"!==e&&a.resetDays(e),a[t]=!1}))}setCurrentToVisible(){this.year.visibleYear=this.year.numericRepresentation,this.resetMonths("visible");const e=this.getMonth();e&&(e.visible=!0)}updateMonth(e,t,a,s=null){const n=t.toLowerCase(),i="current"===n?this.year.numericRepresentation:"visible"===n?this.year.visibleYear:this.year.selectedYear,o=this.year.leapYearRule.isLeapYear(i);let r;if((-1===e||e>=this.months.length)&&(e=this.months.length-1),null!==s)r=s;else{r=this.getMonthAndDayIndex().day||0}if(this.resetMonths(t),o&&0===this.months[e].numberOfLeapYearDays||!o&&0===this.months[e].numberOfDays)return this.months[e][n]=!0,this.changeMonth(a?1:-1,t,s);this.months[e][n]=!0,"current"===n&&this.months[e].updateDay(r,o)}changeYear(e,t=!0,a="visible",s=null){const n=a.toLowerCase();if("visible"===n?this.year.visibleYear=this.year.visibleYear+e:"selected"===n?this.year.selectedYear=this.year.selectedYear+e:this.year.numericRepresentation=this.year.numericRepresentation+e,this.months.length&&t){let t=0;-1===e&&(t=this.months.length-1),this.updateMonth(t,a,e>0,s)}}changeMonth(e,t="visible",a=null){const s=t.toLowerCase(),n=e>0;for(let i=0;i<this.months.length;i++){if(this.months[i][s]){if(n&&i+e>=this.months.length){this.changeYear(1,!0,s,a);const t=e-(this.months.length-i);t>0&&this.changeMonth(t,s,a)}else if(!n&&i+e<0){this.changeYear(-1,!0,s,a);const t=e+i+1;t<0&&this.changeMonth(t,s,a)}else this.updateMonth(i+e,t,n,a);break}}}changeDay(e,t="current"){const a=t.toLowerCase(),s="current"===a?this.year.numericRepresentation:this.year.selectedYear,n=this.year.leapYearRule.isLeapYear(s),i=this.getMonth(a);if(i){const t=e>0;let s=i.getDayIndex(a);const o=n?i.numberOfLeapYearDays:i.numberOfDays;t&&s+e>=o?(this.changeMonth(1,a,0),this.changeDay(e-(o-s),a)):!t&&s+e<0?(this.changeMonth(-1,a,-1),this.changeDay(e+s+1,a)):i.changeDay(e,n,a)}}changeDayBulk(e,t="current"){let a=this.year.leapYearRule.isLeapYear(this.year.numericRepresentation),s=this.totalNumberOfDays(a,!0);for(;e>s;)this.changeYear(1,!1,t),e-=s,a=this.year.leapYearRule.isLeapYear(this.year.numericRepresentation),s=this.totalNumberOfDays(a,!0);this.changeDay(e,t)}totalNumberOfDays(e=!1,t=!1){let a=0;return this.months.forEach((s=>{(s.intercalary&&s.intercalaryInclude||!s.intercalary||t)&&(a+=e?s.numberOfLeapYearDays:s.numberOfDays)})),a}dateToDays(e,t,a,s=!1,n=!1){const i=e<this.year.yearZero,o=this.totalNumberOfDays(!1,n),r=this.totalNumberOfDays(!0,n)-o,c=this.year.leapYearRule.isLeapYear(e),l=this.year.leapYearRule.howManyLeapYears(e),d=this.year.leapYearRule.howManyLeapYears(this.year.yearZero);let m,u=Math.abs(e-this.year.yearZero);t<0?t=0:t>=this.months.length&&(t=this.months.length-1),i&&(u-=1);let g=a-this.months[t].numericRepresentationOffset+1,p=o*u;if(g<1&&(g=1),i){m=c?(d-(l+1))*r:(d-l)*r,p+=m;for(let e=this.months.length-1;e>=0;e--)e>t&&(n||!this.months[e].intercalary||this.months[e].intercalary&&this.months[e].intercalaryInclude)&&(p+=c?this.months[e].numberOfLeapYearDays:this.months[e].numberOfDays);p+=(c?this.months[t].numberOfLeapYearDays:this.months[t].numberOfDays)-g}else{m=Math.abs(l-d)*r,p+=m;for(let e=0;e<this.months.length;e++)e<t&&(n||!this.months[e].intercalary||this.months[e].intercalary&&this.months[e].intercalaryInclude)&&(p+=c?this.months[e].numberOfLeapYearDays:this.months[e].numberOfDays);p+=g}return i?(p+=1,e<=0&&this.year.leapYearRule.rule!==h.None&&(0!==this.year.yearZero||c?0!==this.year.yearZero&&c&&(p+=r):p-=r)):p-=1,e>0&&0===this.year.yearZero&&this.year.leapYearRule.rule!==h.None&&(p+=r),i?-1*p:p}secondsToDate(e){const t=e<0;let a,s,n,i,o,r,c;e=Math.abs(e),o=Math.floor(e/this.time.secondsPerDay),e-=o*this.time.secondsPerDay;let l=t?this.time.secondsPerDay-e:e;if(n=Math.floor(l/(this.time.secondsInMinute*this.time.minutesInHour))%this.time.hoursInDay,l-=n*(this.time.secondsInMinute*this.time.minutesInHour),s=Math.floor(l/this.time.secondsInMinute)%this.time.secondsInMinute,l-=s*this.time.secondsInMinute,a=l%60,t){c=this.year.yearZero-1;let e=this.year.leapYearRule.isLeapYear(c);for(r=this.months.length-1,i=e?this.months[r].numberOfLeapYearDays-1:this.months[r].numberOfDays-1,0===a&&0===s&&0===n&&o--;o>0;){const t=this.totalNumberOfDays(e,!0);let a=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays;if(o>=t)c-=1,e=this.year.leapYearRule.isLeapYear(c),a=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,o-=t;else if(o>=a){r-=1;let t=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,s=0;for(;0===t&&s<=this.months.length;)r--,t=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,s++;i=e?this.months[r].numberOfLeapYearDays-1:this.months[r].numberOfDays-1,o-=a}else i-=1,o-=1}}else{c=this.year.yearZero;let e=this.year.leapYearRule.isLeapYear(c);for(r=0,i=0;o>0;){const t=this.totalNumberOfDays(e,!0),a=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays;if(o>=t)c+=1,e=this.year.leapYearRule.isLeapYear(c),o-=t;else if(o>=a){r+=1;let t=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,s=0;for(;0===t&&s<=this.months.length;)r++,t=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,s++;o-=a}else i+=1,o-=1}c<0&&i++}return{year:c,month:r,day:i,hour:n,minute:s,seconds:a}}secondsToInterval(e){let t,a,s,n=e,i=0,o=0;n>=this.time.secondsInMinute&&(i=Math.floor(n/this.time.secondsInMinute),n-=i*this.time.secondsInMinute),i>=this.time.minutesInHour&&(o=Math.floor(i/this.time.minutesInHour),i-=o*this.time.minutesInHour);let r=0;o>=this.time.hoursInDay&&(r=Math.floor(o/this.time.hoursInDay),o-=r*this.time.hoursInDay);const c=this.totalNumberOfDays(!1,!1)/this.months.map((e=>!e.intercalary)).length;return a=Math.floor(r/c),t=r-Math.round(a*c),s=Math.floor(a/this.months.length),a-=Math.round(s*this.months.length),{seconds:n,minute:i,hour:o,day:t,month:a,year:s}}toSeconds(){const e=this.getMonthAndDayIndex();return Z(this,this.year.numericRepresentation,e.month||0,e.day||0,!0)}changeDateTime(e,t={}){if(t=P({},{updateMonth:!0,updateApp:!0,save:!0,sync:!0,showWarning:!1},t),We(game.user,$.globalConfiguration.permissions.changeDateTime)){let a=this.toSeconds(),s=!1;if(e.year&&(this.changeYear(e.year,t.updateMonth,"current"),s=!0),e.month&&(this.changeMonth(e.month,"current"),s=!0),e.day&&(this.changeDay(e.day),s=!0),e.hour||e.minute||e.seconds){const t=this.time.changeTime(e.hour,e.minute,e.seconds);0!==t&&this.changeDay(t),s=!0}if(s){let e=this.toSeconds()-a;fe.emit(S.DateTimeChange,this,e),t.fromCalSync||!Y.syncWithAllCalendars||isNaN(a)||Y.syncWithCalendars({seconds:e}),t.save&&Y.saveCalendars().catch(A.error),t.sync&&this.syncTime().catch(A.error),t.updateApp&&x.updateApp()}return!0}return t.showWarning&&q.UiNotification(q.Localize("FSC.Warn.Macros.GMUpdate"),"warn"),!1}setDateTime(e,t={}){if(t=P({},{updateMonth:!0,updateApp:!0,save:!0,sync:!0,showWarning:!1,bypassPermissionCheck:!1},t),We(game.user,$.globalConfiguration.permissions.changeDateTime)||t.bypassPermissionCheck){let a=this.toSeconds();const s={year:e.year||0,month:e.month||0,day:e.day||0,hour:e.hour||0,minute:e.minute||0,seconds:e.seconds||0},n=this.getMonthAndDayIndex(),i=this.time.getCurrentTime();void 0===e.seconds&&(s.seconds=i.seconds),void 0===e.minute&&(s.minute=i.minute),void 0===e.hour&&(s.hour=i.hour),void 0===e.year&&(s.year=this.year.numericRepresentation),void 0===e.month&&(s.month=n.month||0),void 0===e.day&&(s.day=n.day||0),this.updateTime(s);let o=this.toSeconds()-a;return fe.emit(S.DateTimeChange,this,o),t.fromCalSync||!Y.syncWithAllCalendars||isNaN(a)||Y.syncWithCalendars({seconds:o}),t.save&&Y.saveCalendars().catch(A.error),t.sync&&this.syncTime().catch(A.error),t.updateApp&&x.updateApp(),!0}return t.showWarning&&q.UiNotification(q.Localize("FSC.Warn.Macros.GMUpdate"),"warn"),!1}async syncTime(e=!1){let t=NaN;!We(game.user,$.globalConfiguration.permissions.changeDateTime)||this.generalSettings.gameWorldTimeIntegration!==p.Self&&this.generalSettings.gameWorldTimeIntegration!==p.Mixed||(t=this.toSeconds(),(t!==game.time.worldTime||e)&&(this.timeChangeTriggered=!0,q.IsGm()&&await this.time.setWorldTime(t)))}setFromTime(e,t){if(this.gameSystem===b.PF2E&&this.generalSettings.pf2eSync&&(e+=B.getWorldCreateSeconds(this)),0!==t)if(this.generalSettings.gameWorldTimeIntegration!==p.Self&&this.generalSettings.gameWorldTimeIntegration!==p.Mixed||this.timeKeeper.getStatus()!==w.Started){if(this.generalSettings.gameWorldTimeIntegration!==p.Self&&this.generalSettings.gameWorldTimeIntegration!==p.Mixed||!this.timeChangeTriggered&&!this.combatChangeTriggered){if((this.generalSettings.gameWorldTimeIntegration===p.ThirdParty||this.generalSettings.gameWorldTimeIntegration===p.Mixed)&&!this.timeChangeTriggered){const t=this.secondsToDate(e);this.setDateTime(t,{updateApp:!1,sync:!1,save:q.IsGm()&&$.primary})}}else if(!this.timeChangeTriggered){const t=this.secondsToDate(e);this.setDateTime(t,{updateApp:!1,sync:!1,save:q.IsGm()&&$.primary})}}else{const a=this.secondsToDate(e);this.setDateTime(a,{updateApp:this.time.updateFrequency*this.time.gameTimeRatio!==t,sync:!1,save:!1,bypassPermissionCheck:!0}),me.Clock.UpdateListener(`sc_${this.id}_clock`,this.timeKeeper.getStatus())}this.timeChangeTriggered=!1,this.combatChangeTriggered=!1}processOwnCombatRoundTime(e){let t=$.globalConfiguration.secondsInCombatRound,a=1;e.hasOwnProperty("previous")&&e.previous.round&&(a=e.round-e.previous.round),0!==t&&0!==a&&this.changeDateTime({seconds:t*a},{updateApp:!1,sync:!0,save:q.IsGm()&&$.primary})}updateTime(e){let t=this.year.leapYearRule.isLeapYear(e.year);this.year.numericRepresentation=e.year,this.updateMonth(e.month,"current",!0),this.months[e.month].updateDay(e.day,t),this.time.setTime(e.hour,e.minute,e.seconds)}}class Ft{constructor(){this.calendars={},this.activeId="",this.visibleId=""}get syncWithAllCalendars(){return $.globalConfiguration.syncCalendars&&Object.keys(this.calendars).length>1}async initialize(){if(this.loadCalendars())this.loadActiveCalendar();else{const e=await this.getDefaultCalendar();this.activeId=e.id,this.visibleId=e.id}}async saveCalendars(){const e=[];for(const[t,a]of Object.entries(this.calendars))e.push(a.toConfig());await q.SaveStringSetting(n.ActiveCalendar,this.calendars[this.activeId].id),await q.SaveObjectSetting(n.CalendarConfiguration,e)}loadCalendars(){const e=q.GetObjectSettings(n.CalendarConfiguration);if(1!==e.length||e[0]||e.shift(),e.length)for(let t=0;t<e.length;t++)if(e[t].id){let a=this.getCalendar(e[t].id);a?a.loadFromSettings(e[t]):a=this.addCalendar(e[t].id,e[t].name||`Calendar ${t}`,e[t]),0===t&&""===this.activeId&&(this.activeId=e[t].id,this.visibleId=e[t].id)}G.checkNoteTriggers(this.activeId);const t=this.getVisibleCalendar();return t&&t.timeKeeper.getStatus()!==w.Started&&x.updateApp(),e.length}loadActiveCalendar(){const e=q.GetStringSettings(n.ActiveCalendar),t=this.getCalendar(e);t&&(this.activeId=t.id,this.visibleId=t.id),x.updateApp()}addCalendar(e,t,a){const s=new Rt(e,t,a);return this.calendars[s.id]=s,this.calendars[s.id]}addTempCalendar(e){const t=new Rt("",e);return t.id+="_temp",this.calendars[t.id]=t,this.calendars[t.id]}async getDefaultCalendar(){let e=this.getCalendar("default");return e||(e=this.addCalendar("default","Default",{id:""}),await Oe.setToPredefined(e,c.Gregorian)),e}getCalendar(e){return this.calendars.hasOwnProperty(e)?this.calendars[e]:null}static sortCalendars(e,t){return"default"===e.id||"default_temp"===e.id?-1:"default"===t.id||"default_temp"===t.id?1:0}getAllCalendars(e=!1){const t=[];for(const[a,s]of Object.entries(this.calendars))(!e&&!a.endsWith("_temp")||e&&a.endsWith("_temp"))&&t.push(s);return t.sort(Ft.sortCalendars)}getActiveCalendar(){return this.calendars[this.activeId]}getVisibleCalendar(){return this.calendars[this.visibleId]}setCalendars(e){if(e.length){for(const[t,a]of Object.entries(this.calendars)){e.findIndex((e=>e.id===t))>-1||delete this.calendars[t]}for(let t=0;t<e.length;t++)this.calendars[e[t].id]?this.calendars[e[t].id].loadFromSettings(e[t].toConfig()):this.calendars[e[t].id]=e[t];this.setActiveCalendar(e[0].id),this.setVisibleCalendar(e[0].id)}}setActiveCalendar(e){const t=this.getCalendar(e);if(t){for(const[e,t]of Object.entries(this.calendars))t.timeKeeper.pause();this.activeId=t.id,this.visibleId=t.id,t.timeKeeper.getStatus()===w.Paused&&t.timeKeeper.start(!0),game.socket?.emit(u.clock),x.clockClass=t.timeKeeper.getStatus(),q.SaveStringSetting(n.ActiveCalendar,t.id).catch(A.error),t.syncTime(!0).catch(A.error),fe.emit(S.DateTimeChange,t)}}setVisibleCalendar(e){const t=this.getCalendar(e);t&&(this.visibleId=t.id,x.clockClass=t.timeKeeper.getStatus(),x.updateApp())}removeCalendar(e){this.calendars.hasOwnProperty(e)&&(this.calendars[e].timeKeeper.stop(),delete this.calendars[e])}cloneCalendars(){const e=[];for(const[t,a]of Object.entries(this.calendars))if(a.id.endsWith("_temp"))e.push(a);else{const t=a.clone();t.id+="_temp",this.calendars[t.id]=t,e.push(t)}return e.sort(Ft.sortCalendars)}mergeClonedCalendars(){const e=[];for(const[t,a]of Object.entries(this.calendars))t.endsWith("_temp")&&(a.id=a.id.replace("_temp",""),e.push({key:t.replace("_temp",""),value:a}));for(let t=0;t<e.length;t++){const a=this.getCalendar(e[t].key);a?a.loadFromSettings(e[t].value.toConfig()):this.calendars[e[t].key]=e[t].value}for(const[t,a]of Object.entries(this.calendars)){e.findIndex((e=>e.value.id===t))>-1||delete this.calendars[t]}this.getActiveCalendar()||this.setActiveCalendar(e[0].key),this.getVisibleCalendar()||this.setVisibleCalendar(e[0].key)}clearClones(){for(const[e,t]of Object.entries(this.calendars))t.id.endsWith("_temp")&&delete this.calendars[e]}syncWithCalendars(e){const t=this.getActiveCalendar();for(const[a,s]of Object.entries(this.calendars))a!==t.id&&s.changeDateTime(e,{sync:!1,save:!1,updateApp:!1,fromCalSync:!0})}}class jt{static runCalendarMigration(){const e={id:"default",name:"Default",currentDate:q.GetObjectSettings(n.CurrentDate),general:q.GetObjectSettings(n.GeneralConfiguration),leapYear:q.GetObjectSettings(n.LeapYearRule),months:q.GetObjectSettings(n.MonthConfiguration),moons:q.GetObjectSettings(n.MoonConfiguration),noteCategories:q.GetObjectSettings(n.NoteCategories),seasons:q.GetObjectSettings(n.SeasonConfiguration),time:q.GetObjectSettings(n.TimeConfiguration),weekdays:q.GetObjectSettings(n.WeekdayConfiguration),year:q.GetObjectSettings(n.YearConfiguration)};if(e.months){if(e.currentDate&&!isObjectEmpty(e.currentDate)&&(e.currentDate.month=e.months.findIndex((t=>t.numericRepresentation===e.currentDate?.month)),e.currentDate.month<0&&(e.currentDate.month=0),e.currentDate.day--),e.seasons)for(let t=0;t<e.seasons.length;t++){const a=e.seasons[t].startingMonth;switch(e.seasons[t].startingMonth=e.months.findIndex((e=>e.numericRepresentation===a)),e.seasons[t].startingMonth<0&&(e.seasons[t].startingMonth=0),e.seasons[t].startingDay--,e.seasons[t].color){case"#fffce8":e.seasons[t].color="#46B946";break;case"#f3fff3":e.seasons[t].color="#E0C40B";break;case"#fff7f2":e.seasons[t].color="#FF8E47";break;case"#f2f8ff":e.seasons[t].color="#479DFF"}}if(e.moons)for(let t=0;t<e.moons.length;t++){const a=e.moons[t].firstNewMoon.month;e.moons[t].firstNewMoon.month=e.months.findIndex((e=>e.numericRepresentation===a)),e.moons[t].firstNewMoon.month<0&&(e.moons[t].firstNewMoon.month=0),e.moons[t].firstNewMoon.day--}}const t=new Rt("default","Default",e);let a=!1;return t.year&&t.months.length&&(a=!0),a?t:null}static runGlobalConfigurationMigration(){const e=q.GetObjectSettings(n.GeneralConfiguration),t=q.GetObjectSettings(n.TimeConfiguration);if(e.hasOwnProperty("permissions")&&e.permissions){const t=new Fe;t.loadFromSettings(e.permissions),t.changeActiveCalendar={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},$.globalConfiguration.permissions=t}else A.info("No old permissions found, using default permission values!");if(t.hasOwnProperty("secondsInCombatRound")&&Number.isInteger(t.secondsInCombatRound)){const e=parseInt(t.secondsInCombatRound.toString());isNaN(e)||($.globalConfiguration.secondsInCombatRound=e)}else A.info("No old seconds in combat round setting found, using default value!");return!0}static async runNoteMigration(){const e=q.GetObjectSettings(n.Notes),t=Y.getActiveCalendar();for(let a=0;a<e.length;a++){const s=e[a],n={year:s.year||t.year.numericRepresentation,month:t.months.findIndex((e=>e.numericRepresentation===s.month)),day:(s.day||1)-1,hour:s.hour||0,minute:s.minute||0,seconds:0},i={allDay:void 0===s.allDay||s.allDay,calendarId:t.id,repeats:s.repeats||0,order:s.order||0,categories:s.categories||[],remindUsers:s.remindUsers||[],startDate:n,endDate:n};s.hasOwnProperty("endDate")&&(i.endDate={year:s.endDate.year||n.year,month:t.months.findIndex((e=>e.numericRepresentation===s.endDate.month)),day:(s.endDate.day||1)-1,hour:s.endDate.hour||0,minute:s.endDate.minute||0,seconds:0}),i.startDate.month<0&&(i.startDate.month=0),i.endDate.month<0&&(i.endDate.month=0);const o=await G.createNote(s.title,s.content,i,t,!1,!1);if(o){const e={};Object.keys(o.data.permission).forEach((t=>{e[t]=t===s.author?3:s.playerVisible?2:0})),await o.update({permission:e})}}return!0}static async cleanUpOldData(){const e=await q.SaveObjectSetting(n.GeneralConfiguration,{}),t=await q.SaveObjectSetting(n.YearConfiguration,{}),a=await q.SaveObjectSetting(n.WeekdayConfiguration,[]),s=await q.SaveObjectSetting(n.MonthConfiguration,[]),i=await q.SaveObjectSetting(n.CurrentDate,{}),o=await q.SaveObjectSetting(n.LeapYearRule,{}),r=await q.SaveObjectSetting(n.TimeConfiguration,{}),c=await q.SaveObjectSetting(n.SeasonConfiguration,[]),l=await q.SaveObjectSetting(n.MoonConfiguration,[]),d=await q.SaveObjectSetting(n.Notes,[]),h=await q.SaveObjectSetting(n.NoteCategories,[]);return e&&t&&a&&s&&i&&o&&r&&c&&l&&d&&h}}class Pt extends Application{constructor(){super(),this.MigrationType=r.none,this.displayData={calendarMigrationStatusIcon:"fa-sync fa-spin fsc-af",globalConfigMigrationStatusIcon:"fa-sync fa-spin fsc-af",notesMigrationStatusIcon:"fa-sync fa-spin fsc-af",enableCleanUp:!1,migrationDone:!1}}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/migration.html",e.title="FSC.Migration.Title",e.classes=["simple-calendar"],e.id=this.appWindowId,e.resizable=!1,e.width=500,e}showApp(){this.render(!0,{classes:["simple-calendar",q.GetStringSettings(n.Theme)]})}getData(e){return{...super.getData(e),display:this.displayData,headingTitle:this.headingTitle,description:this.description}}get headingTitle(){let e="";if(this.MigrationType===r.v1To2)e="FSC.Migration.v1v2.Title";return e}get description(){let e="";if(this.MigrationType===r.v1To2)e="FSC.Migration.v1v2.Help";return e}initialize(){q.IsGm()&&this.determineMigrationType()}activateListeners(e){const t=document.getElementById(Pt.appWindowId);t&&t.querySelector(".fsc-bf")?.addEventListener("click",this.runCleanData.bind(this))}determineMigrationType(){const e=q.GetObjectSettings(n.GlobalConfiguration),t=q.GetObjectSettings(n.YearConfiguration);j(t)&&j(e)?this.MigrationType=r.none:j(t)||e.hasOwnProperty("version")||(A.info("Migration required from Simple Calendar v1 to Version 2"),this.MigrationType=r.v1To2)}get showMigration(){return this.MigrationType!==r.none}async run(e=!1){e&&(this.MigrationType=r.v1To2),A.info("Running Migration!"),this.showApp();const t=this.runCalendarMigration();this.showApp();const a=await this.runNoteMigration();this.showApp(),t&&a&&(this.displayData.enableCleanUp=!0,this.displayData.migrationDone=!0,x.showApp(),this.showApp())}runCalendarMigration(){if(A.info("Migrating Calendar Configuration..."),this.MigrationType==r.v1To2){let e=!1,t=!1;const a=jt.runCalendarMigration();return null!==a?(Y.setCalendars([a]),this.displayData.calendarMigrationStatusIcon="fa-check-circle fsc-cf",A.info("Calendar Configuration successfully migrated!"),A.info("Migrating Permissions and General Settings..."),e=!0):(A.error("There was an error converting the existing calendar configuration to the new calendar data model."),this.displayData.calendarMigrationStatusIcon="fa-times-circle fsc-df",this.displayData.globalConfigMigrationStatusIcon="fa-ban fsc-ef"),jt.runGlobalConfigurationMigration()?(A.info("Permissions and General Settings successfully migrated!"),this.displayData.globalConfigMigrationStatusIcon="fa-check-circle fsc-cf",this.saveMigratedData(),t=!0):(A.error("There was an error converting the existing permissions and general settings to the new permissions and general settings data model."),this.displayData.globalConfigMigrationStatusIcon="fa-times-circle fsc-df"),e&&t}return!1}saveMigratedData(){$.save($.globalConfiguration,{id:"",theme:i.dark,openOnLoad:!0,openCompact:!1,rememberPosition:!0,appPosition:{}})}async runNoteMigration(){if(A.info("Migrating Calendar Notes..."),this.MigrationType==r.v1To2){if(await jt.runNoteMigration())return A.info("Calendar Notes successfully migrated!"),this.displayData.notesMigrationStatusIcon="fa-check-circle fsc-cf",!0;A.error("There was an error converting the existing notes to journal entries."),this.displayData.notesMigrationStatusIcon="fa-times-circle fsc-df"}return!1}runCleanData(){A.info("Clearing all old data..."),this.MigrationType==r.v1To2&&(jt.cleanUpOldData().then((e=>{q.UiNotification(q.Localize("FSC.Migration.v1v2.CleanupSuccess"),"info")})).catch(A.error),A.info("All old data has been cleared."))}}Pt.appWindowId="fsc-ff";class NoteSheet extends DocumentSheet{constructor(e,t={}){super(e,t),this.dirty=!1,this.resized=!1,this.editMode=!1,this.advancedOpen=!1,this.journalData={name:"",content:"",flags:{},permission:{}},this.appWindow=null,this.dateSelectorId=`scNoteDate_${this.object.id}`}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/note-sheet.html",e.title="Simple Calendar Note",e.id=this.appWindowId,e.classes=["sheet","journal-sheet","simple-calendar"],e.resizable=!0,e.closeOnSubmit=!1,game.settings&&e.classes.push(q.GetStringSettings(n.Theme)),e}static get defaultObject(){return{}}get template(){return this.options.template||""}get type(){return"simplecalendarnote"}copyData(){this.journalData.name=this.object.data.name,this.journalData.content=this.object.data.content,this.journalData.flags=mergeObject({},this.object.data.flags),this.journalData.permission=mergeObject({},this.object.data.permission)}_getHeaderButtons(){const e=super._getHeaderButtons(),t=[];for(let a=0;a<e.length;a++)"close"!==e[a].class&&"configure-sheet"!==e[a].class||t.push(e[a]);return t}close(e){if(this.dirty){return new Dialog({title:q.Localize("FSC.NoteDirty"),content:q.Localize("FSC.NoteDirtyText"),buttons:{yes:{icon:'<i class="fas fa-trash"></i>',label:q.Localize("FSC.DiscardChanges"),callback:this.isDirtyDialogClose.bind(this,!1)},save:{icon:'<i class="fas fa-save"></i>',label:q.Localize("FSC.Save"),callback:this.isDirtyDialogClose.bind(this,!0)}},default:"save"}).render(!0),Promise.resolve()}return this.dirty=!1,this.editMode=!1,this.resized=!1,this.advancedOpen=!1,super.close(e)}async isDirtyDialogClose(e){return this.dirty=!1,e&&await this.save(new Event("click")),this.close()}render(e,t,a){return void 0!==a&&(this.editMode=a),super.render(e,t)}getData(e){this.copyData();let t={...super.getData(),editable:this.isEditable,editMode:this.editMode,name:"",display:{date:"",reminder:!1,repeats:0,repeatsDisplay:"",author:{colorText:"",color:"",name:""},categories:[],enrichedContent:"",macro:""},edit:{dateDisplay:"",repeats:l.Never,noteData:{},users:[],timeSelected:!1,dateSelectorId:this.dateSelectorId,dateSelectorSelect:this.dateSelectorSelect.bind(this),repeatOptions:{0:"FSC.Notes.Repeat.Never",1:"FSC.Notes.Repeat.Weekly",2:"FSC.Notes.Repeat.Monthly",3:"FSC.Notes.Repeat.Yearly"},allCategories:[],advancedOpen:this.advancedOpen,macroList:{none:"No Macro"},selectedMacro:""}};const a=G.getNoteStub(this.object);if(a)if(t.name=a.title,this.editMode){t.edit.noteData=a.noteData||{},t.edit.timeSelected=!a.allDay,t.edit.repeats=a.repeats;const e=game.users;e&&(t.edit.users=e.map((e=>({name:e.name,id:e.id,color:e.data.color,textColor:se(e.color||""),selected:!(0===this.object.data.permission[e.id]||!this.object.testUserPermission(e,2)),disabled:e.id===game.user?.id}))));const s=a.noteData;if(s){const e=Y.getCalendar(s.calendarId);e&&(t.edit.dateDisplay=V(s.startDate,"MMMM DD, YYYY",e),J(s.startDate,s.endDate)||(t.edit.dateDisplay+=` - ${V(s.endDate,"MMMM DD, YYYY",e)}`),t.edit.allCategories=e.noteCategories.map((e=>({name:e.name,color:e.color,textColor:e.textColor,selected:void 0!==s.categories.find((t=>t===e.name))}))))}game.macros?.forEach((e=>{e.canExecute&&e.name&&(t.edit.macroList[e.id]=e.name)})),t.edit.selectedMacro=a.macro}else t.display.date=a.fullDisplayDate,t.display.reminder=a.userReminderRegistered,t.display.repeats=a.repeats,t.display.repeatsDisplay=q.Localize(t.edit.repeatOptions[a.repeats]||""),t.display.author=a.authorDisplay||{colorText:"",color:"",name:""},t.display.categories=a.categories,t.display.enrichedContent=TextEditor.enrichHTML(a.content),this.isEditable&&(t.display.macro=game.macros?.get(a.macro)?.name||"");return t}static setHeight(e){if(e.appWindow&&!e.resized){const t=e.appWindow.getElementsByTagName("form");if(t&&t.length){let a=46;if(e.editMode)a+=t[0].scrollHeight;else{const t=e.appWindow.querySelector(".fsc-gf"),s=e.appWindow.querySelector(".fsc-hf"),n=e.appWindow.querySelector(".fsc-if");if(t){const e=window.getComputedStyle(t);a+=t.offsetHeight+parseInt(e.marginTop)+parseInt(e.marginBottom)}if(s){const e=window.getComputedStyle(s);a+=s.scrollHeight+parseInt(e.marginTop)+parseInt(e.marginBottom)}if(n){const e=window.getComputedStyle(n);a+=n.offsetHeight+parseInt(e.marginTop)+parseInt(e.marginBottom)}}e.editMode&&a<845&&(a=845);const s=.95*window.outerHeight;a>s&&(a=s),e.setPosition({height:a,width:720})}}}activateEditorCustom(){if(this.appWindow){const e=this.appWindow.querySelector(".fsc-jf .editor-content");if(e){let a=0;const s={target:e,body_class:"simple-calendar",content_css:["/css/mce.css",`modules/${t}/styles/themes/tinymce-${$.clientSettings.theme}.css`],preview_styles:!1,height:a,save_onsavecallback:e=>this.saveEditor("content")};this.editors.content={target:"content",button:e.nextElementSibling,hasButton:!1,mce:null,active:!0,changed:!1,options:s,initial:this.object.data.content},this.activateEditor("content",s,this.object.data.content)}}}activateListeners(e){if(this.appWindow=document.getElementById(`${NoteSheet.appWindowId}-${this.object.id}`),this.appWindow){const e=[i.light,i.dark,i.classic];this.appWindow.classList.remove(...e),this.appWindow.classList.add($.clientSettings.theme),this.editMode?(this.activateEditorCustom(),Re.ActivateSelector(this.dateSelectorId),this.updateNoteRepeatDropdown(),this.appWindow.querySelector(".fsc-kf")?.addEventListener("click",this.toggleAdvanced.bind(this)),this.appWindow.querySelectorAll("input, select").forEach((e=>{e.addEventListener("change",this.inputChange.bind(this))}))):(this.appWindow.querySelector("#scNoteReminder")?.removeAttribute("disabled"),this.appWindow.querySelector("#scNoteReminder")?.addEventListener("click",this.reminderChange.bind(this))),this.appWindow.querySelector("#scSubmit")?.addEventListener("click",this.save.bind(this)),this.appWindow.querySelector("#scNoteEdit")?.addEventListener("click",this.edit.bind(this)),this.appWindow.querySelector("#scNoteDelete")?.addEventListener("click",this.delete.bind(this))}}toggleAdvanced(){if(this.advancedOpen=!this.advancedOpen,this.appWindow){const e=this.appWindow.querySelector(".fsc-kf"),t=this.appWindow.querySelector(".fsc-ld");e&&t&&(e.innerHTML=this.advancedOpen?`${q.Localize("FSC.HideAdvanced")}<span class='fa fa-chevron-up'></span>`:`${q.Localize("FSC.ShowAdvanced")}<span class='fa fa-chevron-down'></span>`,ie(t,500))}}async inputChange(){await this.writeInputValuesToObjects()}_onResize(e){this.resized=!0,super._onResize(e)}async dateSelectorSelect(e){if(Y.getCalendar(this.journalData.flags[t].noteData.calendarId)){const a=!e.startDate.month||e.startDate.month<0?0:e.startDate.month,s=!e.startDate.day||e.startDate.day<0?0:e.startDate.day,n=!e.endDate.month||e.endDate.month<0?0:e.endDate.month,i=!e.endDate.day||e.endDate.day<0?0:e.endDate.day;this.journalData.flags[t].noteData.allDay=!e.timeSelected,this.journalData.flags[t].noteData.startDate={year:e.startDate.year||0,month:a,day:s,hour:e.startDate.hour||0,minute:e.startDate.minute||0,seconds:e.startDate.seconds||0},this.journalData.flags[t].noteData.endDate={year:e.endDate.year||0,month:n,day:i,hour:e.endDate.hour||0,minute:e.endDate.minute||0,seconds:e.endDate.seconds||0},this.updateNoteRepeatDropdown()}}updateNoteRepeatDropdown(){if(this.appWindow){const e=this.appWindow.querySelector("#scNoteRepeats"),a=this.journalData.flags[t].noteData;if(e&&a){const t=Y.getCalendar(a.calendarId);if(t){const s=X(t,a.startDate,a.endDate);let n={0:"FSC.Notes.Repeat.Never",1:"FSC.Notes.Repeat.Weekly",2:"FSC.Notes.Repeat.Monthly",3:"FSC.Notes.Repeat.Yearly"};s>=t.totalNumberOfDays(!1,!0)?(delete n[1],delete n[2],delete n[3]):s>=t.months[a.startDate.month].days.length?(delete n[1],delete n[2]):s>=t.weekdays.length&&delete n[1];let i="";for(let e in n){i+=`<option value="${e}" ${a.repeats.toString()===e?"selected":""}>${q.Localize(n[e])}</option>`}e.innerHTML=i}}}}async writeInputValuesToObjects(){if(this.appWindow){this.journalData.name=je("#scNoteTitle",i.dark,this.appWindow),this.journalData.flags[t].noteData.repeats=Pe("#scNoteRepeats",l.Never,!1,this.appWindow),this.journalData.flags[t].noteData.categories=xe("scNoteCategories",this.appWindow),this.journalData.flags[t].noteData.macro=je("#scNoteMacro","none",this.appWindow);const e=xe("scUserPermissions",this.appWindow);for(let e in this.journalData.permission)3!==this.journalData.permission[e]&&(this.journalData.permission[e]=0);for(let t=0;t<e.length;t++){const a=this.journalData.permission[e[t]];void 0===a||a<2?this.journalData.permission[e[t]]=2:3===a&&(this.journalData.permission[e[t]]=3)}this.editors.content&&(this.journalData.content=this.editors.content.mce?.getContent()||""),this.dirty=!0}}async reminderChange(){const e=game.user;if(e){const a=e.id;if(this.object.testUserPermission(e,3)){const e=this.journalData.flags[t].noteData.remindUsers.indexOf(a);""!==a&&-1===e?this.journalData.flags[t].noteData.remindUsers.push(a):""!==a&&-1!==e&&this.journalData.flags[t].noteData.remindUsers.splice(e,1),await this.object.update(this.journalData)}else{const e={type:u.noteUpdate,data:{userId:a,journalId:this.object.id}};await O.emit(e)}this.render(!0),x.updateApp()}}async edit(e){e.preventDefault(),this.resized=!1,this.editMode=!0,this.render(!0)}async save(e){e.preventDefault(),await this.writeInputValuesToObjects(),this.journalData.flags[t].noteData.fromPredefined=!1,await this.object.update(this.journalData),x.updateApp(),await O.emit({type:u.mainAppUpdate,data:{}}),this.resized=!1,this.editMode=!1,this.dirty=!1,this.render(!0)}delete(e){e.preventDefault();new Dialog({title:q.Localize("FSC.DeleteConfirm"),content:q.Localize("FSC.DeleteConfirmText"),buttons:{yes:{icon:'<i class="fas fa-trash"></i>',label:q.Localize("FSC.Delete"),callback:this.deleteConfirm.bind(this)},no:{icon:'<i class="fas fa-times"></i>',label:q.Localize("FSC.Cancel")}},default:"no"}).render(!0)}async deleteConfirm(){G.removeNoteStub(this.object),x.updateApp(),await this.object.delete(),await O.emit({type:u.mainAppUpdate,data:{}}),await this.close()}}NoteSheet.appWindowId="fsc-lf";class Yt{constructor(e,t){this.fireOnce=!0,this.fired=!1,this.fireOnce=t,this.onFire=e}fire(e,t=!1){(!this.fireOnce||this.fireOnce&&!this.fired)&&(this.fired=this.onFire(e,t))}}class xt{constructor(e){this.triggers=[],this.entryId=e,this.triggers.push(new Yt(xt.reminderNoteTrigger,!0)),this.triggers.push(new Yt(xt.macroNoteTrigger,!0))}static reminderNoteTrigger(e,t){const a=e.noteData;if(a&&e.userReminderRegistered){const s=Y.getCalendar(a.calendarId);if(s&&(!t||t&&s.generalSettings.postNoteRemindersOnFoundryLoad))return ChatMessage.create({speaker:{alias:"Simple Calendar Reminder"},whisper:[q.UserID()],content:`<div class='simple-calendar ${q.GetStringSettings(n.Theme)}'><h2>${e.title}</h2><div style="display: flex;"><div class="note-category"><span class="fa fa-calendar"></span> ${e.fullDisplayDate}</div></div>${e.content}</div>`}).catch(A.error),!0}return!1}static macroNoteTrigger(e,t){const a=e.macro;if(!t&&a&&"none"!==a){const e=game.macros?.get(a);if(e&&e.canExecute)return e.execute(),!0}return!1}get noteData(){const e=game.journal?.get(this.entryId);return e?e.getFlag(t,"noteData"):null}get allDay(){const e=this.noteData;return!e||e.allDay}get content(){const e=game.journal?.get(this.entryId);return e?.data.content||""}get title(){const e=game.journal?.get(this.entryId);return e?.name||""}get repeats(){const e=this.noteData;return e?e.repeats:l.Never}get order(){const e=this.noteData;return e?e.order:0}async setOrder(e){const a=game.journal?.get(this.entryId);if(a){const s=a.getFlag(t,"noteData");s&&(s.order=e,await a.setFlag(t,"noteData",s))}}get authorDisplay(){const e=game.journal?.get(this.entryId);if(e){const a=e.getFlag(t,"noteData");if(a&&a.fromPredefined)return{name:"System",color:"",colorText:""};for(let t in e.data.permission)if(3===e.data.permission[t]){const e=game.users?.get(t);if(e)return{name:e.name||"",color:e.data.color||"",colorText:se(e.data.color||"")}}}return null}get canEdit(){let e=q.IsGm();if(!e){const t=game.journal?.get(this.entryId);if(t)for(let a in t.data.permission)if(3===t.data.permission[a]&&a===q.UserID()){e=!0;break}}return e}get categories(){const e=this.noteData;if(e){const t=Y.getCalendar(e.calendarId);if(t)return t.noteCategories.filter((t=>e.categories.indexOf(t.name)>-1))}return[]}get displayDate(){return this.getDisplayDate(!1)}get fullDisplayDate(){return this.getDisplayDate(!0)}get playerVisible(){const e=game.journal?.get(this.entryId);if(e)for(let t in e.data.permission){if((e.data.permission[t]||0)>=2){const e=game.users?.get(t);if(e&&!e.isGM)return!0}}return!1}get userReminderRegistered(){let e=!1;if(this.canUserView()){const t=this.noteData,a=game.user;t&&a&&(e=t.remindUsers.indexOf(a.id)>-1)}return e}get fromPredefined(){const e=this.noteData;return!(!e||void 0===e.fromPredefined)&&e.fromPredefined}get macro(){const e=this.noteData;return e&&void 0!==e.macro?e.macro:"none"}canUserView(){const e=game.journal?.get(this.entryId),t=game.user;return!(!e||!t)&&!(0===e.data.permission[t.id]||!e.testUserPermission(t,2))}getDisplayDate(e){const t=this.noteData;if(t){const a=Y.getCalendar(t.calendarId);if(a){let s="",n=a.year.selectedYear||a.year.visibleYear,i=a.getMonthAndDayIndex("selected");void 0===i.month&&(i=a.getMonthAndDayIndex());let o=t.startDate.year,r=t.startDate.month,c=t.startDate.day,d=t.endDate.year,h=t.endDate.month,m=t.endDate.day;if(t.repeats===l.Weekly){o=n,d=n;let e=a.dayOfTheWeek(t.startDate.year,r,c),s=a.dayOfTheWeek(t.endDate.year,h,m),l=a.dayOfTheWeek(n,i.month||0,i.day||0),u=s-e;u<0&&(u=a.weekdays.length+u),u++,r=i.month||0,h=i.month||0;let g=l-e,p=s-l;if(g<0&&(g=a.weekdays.length+g),p<0&&(p=a.weekdays.length+p),g+p<u){c=(i.day||0)-g,m=(i.day||0)+p;let e=0;for(;c<0&&e<a.months.length;){r--,r<0&&(o--,r=a.months.length-1);const t=a.year.leapYearRule.isLeapYear(o);c=a.months[r][t?"numberOfLeapYearDays":"numberOfDays"]+c,e++}let t=a.year.leapYearRule.isLeapYear(d);for(e=0;m>=a.months[h][t?"numberOfLeapYearDays":"numberOfDays"]&&e<a.months.length;)m-=a.months[h][t?"numberOfLeapYearDays":"numberOfDays"],h++,h>=a.months.length&&(d++,h=0,t=a.year.leapYearRule.isLeapYear(d)),e++}}else if(t.repeats===l.Monthly){if(o=n,d=n,r=i.month||0,h=i.month||0,t.startDate.month!==t.endDate.month&&(t.startDate.day<=(i.day||0)?(h=(i.month||0)+1,h>=a.months.length&&(h=0,d=n+1)):t.endDate.day>=(i.day||0)&&(r=(i.month||0)-1,r<0&&(r=a.months.length-1,o=n-1))),t.startDate.day>=a.months[r].days.length){c=(a.year.leapYearRule.isLeapYear(o)?a.months[r].numberOfLeapYearDays:a.months[r].numberOfDays)-1}if(t.endDate.day>=a.months[h].days.length){m=(a.year.leapYearRule.isLeapYear(d)?a.months[h].numberOfLeapYearDays:a.months[h].numberOfDays)-1}}else if(t.repeats===l.Yearly)if(t.startDate.year!==t.endDate.year){const e=t.endDate.year-t.startDate.year;t.startDate.month===(i.month||0)&&t.startDate.day<=(i.day||0)?(o=n,d=n+e):t.endDate.month===(i.month||0)&&t.endDate.day>=(i.day||0)&&(o=n-e,d=n)}else o=n,d=n;return s=K(a,{year:o,month:r,day:c,hour:t.startDate.hour,minute:t.startDate.minute,seconds:0},{year:d,month:h,day:m,hour:t.endDate.hour,minute:t.endDate.minute,seconds:0},t.allDay,!e),s}}return""}isVisible(e,t,a,s){const n=Y.getCalendar(e),i=this.noteData;let o=!1;if(i&&n&&this.canUserView()){let e=d.None;if(i.repeats===l.Weekly){let o=0,r=0,c=1;o=n.dayOfTheWeek(i.startDate.year,i.startDate.month,i.startDate.day),c=n.dayOfTheWeek(t,a,s),r=n.dayOfTheWeek(i.endDate.year,i.endDate.month,i.endDate.day),o===c?e=d.Start:r===c?e=d.End:(o<r&&o<c&&r>c||o>r&&(o<c&&r<c||o>c&&r>c))&&(e=d.Middle)}else if(i.repeats===l.Monthly)if(i.startDate.month!==i.endDate.month){let o=a-1,r=a+1,c=t,l=t;o<0&&(o=n.months.length-1,c--),r>=n.months.length&&(r=0,l++);const h=Q(n,{year:t,month:a,day:s,hour:0,minute:0,seconds:0},{year:c,month:o,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:t,month:a,day:i.endDate.day,hour:0,minute:0,seconds:0}),m=Q(n,{year:t,month:a,day:s,hour:0,minute:0,seconds:0},{year:t,month:a,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:l,month:r,day:i.endDate.day,hour:0,minute:0,seconds:0});h===d.None&&m===d.None||(e=d.Middle)}else e=Q(n,{year:t,month:a,day:s,hour:0,minute:0,seconds:0},{year:t,month:a,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:t,month:a,day:i.endDate.day,hour:0,minute:0,seconds:0});else if(i.repeats===l.Yearly){let o=t,r=t;if(i.startDate.year!==i.endDate.year){const c=i.endDate.year-i.startDate.year;o=t-c,r=t+c;const l=Q(n,{year:t,month:a,day:s,hour:0,minute:0,seconds:0},{year:t,month:i.startDate.month,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:r,month:i.endDate.month,day:i.endDate.day,hour:0,minute:0,seconds:0}),h=Q(n,{year:t,month:a,day:s,hour:0,minute:0,seconds:0},{year:o,month:i.startDate.month,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:t,month:i.endDate.month,day:i.endDate.day,hour:0,minute:0,seconds:0});l===d.None&&h===d.None||(e=d.Middle)}else e=Q(n,{year:t,month:a,day:s,hour:0,minute:0,seconds:0},{year:t,month:i.startDate.month,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:t,month:i.endDate.month,day:i.endDate.day,hour:0,minute:0,seconds:0})}else e=Q(n,{year:t,month:a,day:s,hour:0,minute:0,seconds:0},{year:i.startDate.year,month:i.startDate.month,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:i.endDate.year,month:i.endDate.month,day:i.endDate.day,hour:0,minute:0,seconds:0});o=e!==d.None}return o}}class Et{constructor(e,t={}){this.k1=1.3,this.b=.75,this.totalDocumentTermCount=0,this.averageDocumentTermCount=0,this.documents={},this.terms={},this.stopWords=["a","about","above","after","again","against","all","am","an","and","any","are","aren't","as","at","be","because","been","before","being","below","between","both","but","by","can't","cannot","could","couldn't","did","didn't","do","does","doesn't","doing","don't","down","during","each","few","for","from","further","had","hadn't","has","hasn't","have","haven't","having","he","he'd","he'll","he's","her","here","here's","hers","herself","him","himself","his","how","how's","i","i'd","i'll","i'm","i've","if","in","into","is","isn't","it","it's","its","itself","let's","me","more","most","mustn't","my","myself","no","nor","not","of","off","on","once","only","or","other","ought","our","ours","ourselves","out","over","own","same","shan't","she","she'd","she'll","she's","should","shouldn't","so","some","such","than","that","that's","the","their","theirs","them","themselves","then","there","there's","these","they","they'd","they'll","they're","they've","this","those","through","to","too","under","until","up","very","was","wasn't","we","we'd","we'll","we're","we've","were","weren't","what","what's","when","when's","where","where's","which","while","who","who's","whom","why","why's","with","won't","would","wouldn't","you","you'd","you'll","you're","you've","your","yours","yourself","yourselves"],e.forEach((e=>this.addDocument(e))),this.calculateIdf()}addDocument(e){let t=Array.isArray(e.content)?e.content.join(" "):e.content;const a=this.tokenize(t),s={id:e.id,content:t.toLowerCase(),score:0,terms:{},tokens:a,termCount:a.length};this.totalDocumentTermCount+=a.length;for(let e=0;e<a.length;e++){const t=a[e];s.terms[t]||(s.terms[t]={count:0,freq:0}),s.terms[t].count++}for(let e in s.terms)s.terms[e].freq=s.terms[e].count/s.termCount,this.terms[e]||(this.terms[e]={n:0,idf:0}),this.terms[e].n++;this.documents[s.id]=s,this.averageDocumentTermCount=this.totalDocumentTermCount/Object.keys(this.documents).length}calculateIdf(){const e=Object.keys(this.documents).length;for(let t in this.terms)this.terms[t].idf=Math.max(Math.log10((e-this.terms[t].n+.5)/(this.terms[t].n+.5)),.01)}static _min(e,t,a,s,n){return e<t||a<t?e>a?a+1:e+1:s===n?t:t+1}static levenshteinDistance(e,t){if(e.length>t.length){const a=e;e=t,t=a}let a=e.length,s=t.length;for(;a>0&&e.charCodeAt(a-1)===t.charCodeAt(s-1);)a--,s--;let n=0;for(;n<a&&e.charCodeAt(n)===t.charCodeAt(n);)n++;if(a-=n,s-=n,0===a||s<3)return s;let i,o,r,c,l,d,h,m,u,g,p,f=0,y=1e3;const C=[];for(i=0;i<a;i++)C.push(i+1),C.push(e.charCodeAt(n+i));let b=C.length-1;for(;f<s-3;)for(m=t.charCodeAt(n+(o=f)),u=t.charCodeAt(n+(r=f+1)),g=t.charCodeAt(n+(c=f+2)),p=t.charCodeAt(n+(l=f+3)),y=f+=4,i=0;i<b;i+=2)d=C[i],h=C[i+1],o=Et._min(d,o,r,m,h),r=Et._min(o,r,c,u,h),c=Et._min(r,c,l,g,h),y=Et._min(c,l,y,p,h),C[i]=y,l=c,c=r,r=o,o=d;for(;f<s;)for(m=t.charCodeAt(n+(o=f)),y=++f,i=0;i<b;i+=2)d=C[i],C[i]=y=Et._min(d,o,y,m,C[i+1]),o=d;return y}tokenize(e){return e.toLowerCase().replace(/\r?\n|\r/g," ").trim().split(" ").filter((e=>-1===this.stopWords.indexOf(e)))}search(e){const t=this.tokenize(e),a=[];for(let e in this.documents){this.documents[e].score=0;for(let a=0;a<t.length;a++){const s=t[a];if(this.terms[s]&&this.documents[e].terms[s]){const t=this.documents[e].terms[s].count+this.k1*(1-this.b+this.b*this.documents[e].termCount/this.averageDocumentTermCount);this.documents[e].score+=this.terms[s].idf*(this.documents[e].terms[s].count*(this.k1+1))/t}else{const t=Object.keys(this.documents[e].terms).filter((e=>-1!==e.indexOf(s))).length,a=Object.keys(this.documents[e].terms).map((e=>Et.levenshteinDistance(e,s)/3)).filter((e=>e<1)).reduce(((e,t)=>e+(1-t)),0);this.documents[e].score+=.00125*t+.0025*a}}!isNaN(this.documents[e].score)&&this.documents[e].score>0&&a.push(this.documents[e])}return a.sort((function(e,t){return t.score-e.score})),a.map((e=>e.id))}}class Wt{constructor(){this.notes={}}async initialize(){this.registerNoteSheets(),await this.createJournalDirectory(),this.loadNotes()}registerNoteSheets(){Journal.registerSheet(t,NoteSheet,{types:["base"],makeDefault:!1,label:"Simple Calendar: Note Sheet"})}async createJournalDirectory(){const e=game.journal?.directory;e&&(this.noteDirectory=e.folders.find((e=>e.getFlag(t,"root"))),!this.noteDirectory&&q.IsGm()&&(await Folder.create({name:"_simple_calendar_notes_directory",type:"JournalEntry",parent:null,flags:{[t]:{root:!0}}}),this.noteDirectory=e.folders.find((e=>e.getFlag(t,"root")))))}async addNewNote(e,t){const a=e.getDateTime(),s={calendarId:e.id,startDate:a,endDate:a,allDay:!0,repeats:l.Never,order:0,categories:[],remindUsers:[]};await this.createNote(t,"",s,e)}async createNote(e,a,s,n,i=!0,o=!0){const r={};game.users?.forEach((e=>r[e.id]=game.user?.id===e.id?3:n.generalSettings.noteDefaultVisibility?2:0));const c=await JournalEntry.create({name:e,folder:this.noteDirectory?.id,content:a,flags:{core:{sheetClass:`${t}.${NoteSheet.name}`},[t]:{noteData:s}},permission:r});if(c){if(i){new NoteSheet(c).render(!0,{},!0)}return o&&(x.updateApp(),await O.emit({type:u.mainAppUpdate,data:{}})),c}return null}journalEntryUpdate(e,a){const s=a.getFlag(t,"noteData");s&&(0===e?this.addNoteStub(a,s.calendarId):2===e?this.removeNoteStub(a):1==e&&x.updateApp())}addNoteStub(e,t){this.notes.hasOwnProperty(t)||(this.notes[t]=[]),this.notes[t].push(new xt(e.id||""))}removeNoteStub(e){const a=e.getFlag(t,"noteData");if(a&&this.notes.hasOwnProperty(a.calendarId)){const t=this.notes[a.calendarId].findIndex((t=>t.entryId===e.id));t>=0&&this.notes[a.calendarId].splice(t,1)}}loadNotes(){if(this.noteDirectory){this.notes={},this.loadNotesFromFolder(this.noteDirectory);const e=game.journal?.directory;if(e)for(let t=0;t<e.folders.length;t++){const a=e.folders[t];a.parentFolder&&a.parentFolder.id===this.noteDirectory.id&&this.loadNotesFromFolder(a)}}}loadNotesFromFolder(e){for(let a=0;a<e.contents.length;a++){const s=e.contents[a],n=s.getFlag(t,"noteData");n&&this.addNoteStub(s,n.calendarId)}}showNote(e){const t=game.journal?.get(e);t&&t.sheet&&(t.sheet.rendered?t.sheet.bringToTop():t.sheet.render(!0))}getNoteStub(e){const a=e.getFlag(t,"noteData");if(a&&this.notes.hasOwnProperty(a.calendarId))return this.notes[a.calendarId].find((t=>t.entryId===e.id))}getNotes(e){return(this.notes[e]||[]).filter((e=>e.canUserView()))}getNotesForDay(e,t,a,s){const n=(this.notes[e]||[]).filter((n=>n.isVisible(e,t,a,s)));return n.sort(Wt.dayNoteSort),n}getNoteCountsForDay(e,t,a,s){const n=G.getNotesForDay(e,t,a,s),i={count:0,reminderCount:0};for(let e=0;e<n.length;e++)n[e].userReminderRegistered?i.reminderCount++:i.count++;return i}async orderNotesOnDay(e,t,a){const s=this.getNotesForDay(e,a.year,a.month,a.day);for(let e=0;e<t.length;e++){const a=s.find((a=>a.entryId===t[e]));a&&await a.setOrder(e)}await O.emit({type:u.mainAppUpdate,data:{}})}static dayNoteSort(e,t){const a=e.noteData,s=t.noteData;return a&&s?a.order-s.order||a.startDate.hour-s.startDate.hour||a.startDate.minute-s.startDate.minute:0}noteTriggered(e,t){let a=!1;const s=e.noteData,n=t.getCurrentDate();if(s&&e.isVisible(t.id,n.year,n.month,n.day))if(s.allDay)a=!0;else{const e=Q(t,{year:n.year,month:n.month,day:n.day,hour:0,minute:0,seconds:0},s.startDate,s.endDate);if(e===d.Start){const e=s.startDate.hour*t.time.minutesInHour*t.time.secondsInMinute+s.startDate.minute*t.time.secondsInMinute+s.startDate.seconds;a=n.seconds>=e}else if(e===d.Middle)a=!0;else if(e===d.End){const e=s.endDate.hour*t.time.minutesInHour*t.time.secondsInMinute+s.endDate.minute*t.time.secondsInMinute+s.endDate.seconds;a=n.seconds<=e}else if(e===d.Exact){const e=s.startDate.hour*t.time.minutesInHour*t.time.secondsInMinute+s.startDate.minute*t.time.secondsInMinute+s.startDate.seconds,i=s.endDate.hour*t.time.minutesInHour*t.time.secondsInMinute+s.endDate.minute*t.time.secondsInMinute+s.endDate.seconds;a=n.seconds>=e&&n.seconds<=i}}return a}checkNoteTriggers(e,t=!1){const a=Y.getCalendar(e);if(a&&this.notes[e]){const s=this.notes[e];for(let e=0;e<s.length;e++)this.noteTriggered(s[e],a)&&s[e].triggers.forEach((a=>a.fire(s[e],t)))}}searchNotes(e,t,a){const s=this.notes[e];let n=[];if(s){const e=[];for(let t=0;t<s.length;t++)if(s[t].canUserView()){const n=[];if(a.title&&n.push(s[t].title),a.details){let e=document.createElement("DIV");e.innerHTML=s[t].content,n.push((e.textContent||e.innerText||"").replace(/\r?\n|\r/g," "))}a.date&&n.push(s[t].fullDisplayDate),a.author&&n.push(s[t].authorDisplay?.name||""),a.categories&&n.push(s[t].categories.map((e=>e.name)).join(", ")),e.push({id:s[t].entryId,content:n})}const i=new Et(e).search(t);n=s.filter((e=>-1!==i.indexOf(e.entryId)))}return n}}var $t,Gt,qt;$t=new Ft,Y=$t,Gt=new Ge,$=Gt,qt=new $e,x=qt,function(e){E=e}(new Ee),function(e){W=e}(new Pt),function(e){G=e}(new Wt),window.SimpleCalendar={api:e,Hooks:S},Hooks.on("init",(async()=>{Tt.Register(),class{static Register(){game.settings.register(t,n.Theme,{name:"FSC.Configuration.Theme.Title",hint:"FSC.Configuration.Theme.Description",scope:"client",config:!0,type:String,choices:{dark:q.Localize("FSC.Configuration.Theme.Dark"),light:q.Localize("FSC.Configuration.Theme.Light"),classic:q.Localize("FSC.Configuration.Theme.Classic")},default:"dark",onChange:Ge.ThemeChange.bind(Ge)}),game.settings.register(t,n.OpenOnLoad,{name:"FSC.Configuration.Client.OpenOnLoad.Title",hint:"FSC.Configuration.Client.OpenOnLoad.Description",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register(t,n.OpenCompact,{name:"FSC.Configuration.Client.OpenCompact.Title",hint:"FSC.Configuration.Client.OpenCompact.Description",scope:"client",config:!0,type:Boolean,default:!1}),game.settings.register(t,n.RememberPosition,{name:"FSC.Configuration.Client.RememberPosition.Title",hint:"FSC.Configuration.Client.RememberPosition.Description",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register(t,n.AppPosition,{name:"Application Position",hint:"",scope:"client",config:!1,type:Object,default:{}}),game.settings.registerMenu(t,n.CalendarConfigurationMenu,{name:"",label:"FSC.Configuration.Title",hint:"",icon:"fa fa-cog",type:Ee,restricted:!0}),game.settings.register(t,n.CalendarConfiguration,{name:"Calendar Configuration",scope:"world",config:!1,type:Array,default:[],onChange:Y.loadCalendars.bind(Y)}),game.settings.register(t,n.ActiveCalendar,{name:"Active Calendar",scope:"world",config:!1,type:String,default:"default",onChange:Y.loadActiveCalendar.bind(Y)}),game.settings.register(t,n.GlobalConfiguration,{name:"Global Configuration",scope:"world",config:!1,type:Object,default:{},onChange:$.load.bind($)}),game.settings.register(t,n.GeneralConfiguration,{name:"General Configuration",scope:"world",config:!1,type:Object}),game.settings.register(t,n.YearConfiguration,{name:"Year Configuration",scope:"world",config:!1,type:Object,default:{}}),game.settings.register(t,n.WeekdayConfiguration,{name:"Weekday Configuration",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.MonthConfiguration,{name:"Month Configuration",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.CurrentDate,{name:"Current Date",scope:"world",config:!1,type:Object}),game.settings.register(t,n.LeapYearRule,{name:"Leap Year Rule",scope:"world",config:!1,type:Object}),game.settings.register(t,n.DefaultNoteVisibility,{name:"FSC.Configuration.DefaultNoteVisibility",hint:"FSC.Configuration.DefaultNoteVisibilityHint",scope:"world",type:Boolean,default:!1}),game.settings.register(t,n.Notes,{name:"Notes",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.TimeConfiguration,{name:"Time",scope:"world",config:!1,type:Object,default:{}}),game.settings.register(t,n.SeasonConfiguration,{name:"Season Configuration",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.MoonConfiguration,{name:"Moon Configuration",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.NoteCategories,{name:"Note Categories",scope:"world",config:!1,type:Array,default:[{name:"Holiday",color:"#148e94",textColor:"#FFFFFF"}]})}}.Register(),await Y.initialize(),$.load()})),Hooks.on("ready",(async()=>{W.initialize(),W.showMigration?(await W.run(),await G.initialize(),$.initialize()):(await G.initialize(),$.initialize(),$.clientSettings.openOnLoad&&x.showApp())})),Hooks.on("canvasInit",$.canvasInit.bind($)),Hooks.on("getSceneControlButtons",$.getSceneControlButtons.bind($)),Hooks.on("renderJournalDirectory",$.renderJournalDirectory.bind($)),Hooks.on("renderJournalSheet",$.renderJournalSheet.bind($)),Hooks.on("updateWorldTime",$.worldTimeUpdate.bind($)),Hooks.on("createCombatant",$.createCombatant.bind($)),Hooks.on("updateCombat",$.combatUpdate.bind($)),Hooks.on("deleteCombat",$.combatDelete.bind($)),Hooks.on("pauseGame",$.gamePaused.bind($)),Hooks.on("renderNoteSheet",NoteSheet.setHeight),Hooks.on("createJournalEntry",G.journalEntryUpdate.bind(G,0)),Hooks.on("updateJournalEntry",G.journalEntryUpdate.bind(G,1)),Hooks.on("deleteJournalEntry",G.journalEntryUpdate.bind(G,2)),A.debugMode=!1})()})();