const _0x25761b=_0x356f;(function(_0x3e521a,_0x35ac43){const _0x13cfe1=_0x356f,_0x2e06cb=_0x3e521a();while(!![]){try{const _0x44a885=parseInt(_0x13cfe1(0x128))/0x1*(parseInt(_0x13cfe1(0xf5))/0x2)+-parseInt(_0x13cfe1(0x160))/0x3+-parseInt(_0x13cfe1(0x13e))/0x4*(-parseInt(_0x13cfe1(0xf7))/0x5)+parseInt(_0x13cfe1(0x127))/0x6*(parseInt(_0x13cfe1(0x112))/0x7)+-parseInt(_0x13cfe1(0x15f))/0x8*(parseInt(_0x13cfe1(0x134))/0x9)+-parseInt(_0x13cfe1(0x120))/0xa+parseInt(_0x13cfe1(0x12c))/0xb*(parseInt(_0x13cfe1(0x14d))/0xc);if(_0x44a885===_0x35ac43)break;else _0x2e06cb['push'](_0x2e06cb['shift']());}catch(_0x29a188){_0x2e06cb['push'](_0x2e06cb['shift']());}}}(_0x4c66,0xea3e5));import{GameStorage}from'./GameStorage.js';import{Config}from'./Config.js';import{LGT,Util}from'./Util.js';import{SharedConsts}from'../shared/SharedConsts.js';function _0x356f(_0x2f8e54,_0x16b60f){const _0x4c66b5=_0x4c66();return _0x356f=function(_0x356f44,_0x4434d3){_0x356f44=_0x356f44-0xec;let _0x2560fa=_0x4c66b5[_0x356f44];return _0x2560fa;},_0x356f(_0x2f8e54,_0x16b60f);}import{UtilChat}from'./UtilChat.js';class _LoginDialogue extends Application{constructor({userId:_0x5dc693}={}){const _0x1ef579=_0x356f;super({'title':'Access\x20Patron-Only\x20Features','template':SharedConsts['MODULE_LOCATION']+_0x1ef579(0x105),'width':0x190,'height':0x118}),this[_0x1ef579(0x11d)]=_0x5dc693,this[_0x1ef579(0x103)]=null,this[_0x1ef579(0x106)]=null,this['_promise']=new Promise((_0x5d36cc,_0x94cfb9)=>{const _0x545dee=_0x1ef579;this[_0x545dee(0x103)]=_0x5d36cc,this[_0x545dee(0x106)]=_0x94cfb9;}),this[_0x1ef579(0x10a)]=null,this['_ivLoading']=null;}get[_0x25761b(0x146)](){const _0x2e552f=_0x25761b;return this[_0x2e552f(0x12f)];}[_0x25761b(0x12e)](_0x383910){const _0xc56a39=_0x25761b;return{...super[_0xc56a39(0x12e)](_0x383910),'srcImagePatreon':'modules/'+SharedConsts[_0xc56a39(0x154)]+_0xc56a39(0xec)};}[_0x25761b(0x10e)](_0x23451b){const _0xf30a8b=_0x25761b;super[_0xf30a8b(0x10e)](_0x23451b),this['_$btnLogin']=_0x23451b[_0xf30a8b(0x155)]('[name=\x22btn-log-in\x22]')[_0xf30a8b(0x15c)](_0x5531ac=>this[_0xf30a8b(0x110)]({'evt':_0x5531ac}));}async[_0x25761b(0x110)]({evt:_0x190f1b}){const _0x347add=_0x25761b;try{await this[_0x347add(0x104)]({'evt':_0x190f1b});}catch(_0x4fcd7a){console['error'](...LGT,_0x4fcd7a);}finally{if(this['_ivLoading']!=null)clearInterval(this[_0x347add(0x115)]);if(this[_0x347add(0x10a)]!=null)this[_0x347add(0x10a)]['removeClass'](_0x347add(0x13d))[_0x347add(0x140)](_0x347add(0x10c))['prop'](_0x347add(0x153),![]);}}async[_0x25761b(0x104)]({evt:_0x27e0ba}){const _0x236ef7=_0x25761b;_0x27e0ba['stopPropagation'](),_0x27e0ba[_0x236ef7(0xf6)](),this[_0x236ef7(0x10a)][_0x236ef7(0x150)]('italic')[_0x236ef7(0x140)](_0x236ef7(0x15a))[_0x236ef7(0xee)]('disabled',!![]);let _0x3fded4=0x0;this[_0x236ef7(0x115)]=setInterval(()=>{const _0x51ba59=_0x236ef7;this['_$btnLogin']['text'](_0x51ba59(0x126)+''['padEnd'](++_0x3fded4%0x4,'.')[_0x51ba59(0x113)](0x4,'\u00a0'));},0x1f4);const _0x338ec1=await UtilPatreon[_0x236ef7(0xfa)]({'userId':this['_userId']});this[_0x236ef7(0x103)]({'isPatron':_0x338ec1,'isExisting':![]}),await this['close']();}async['close'](_0x1135b8){const _0x34b70b=_0x25761b,_0xdf1135=await super['close'](_0x1135b8);return this[_0x34b70b(0x103)](null),_0xdf1135;}}function _0x4c66(){const _0x48cb20=['<p>','_pGetLogin_','_LOCK','log','italic','3090524CSkakC','_pGetClientUserId','text','baseSiteUrl','_pDeleteUserId','pDoUnlinkAccount','Patron-only\x20features\x20were\x20not\x20activated.','pDoReload','promise','pHasUserIdStrict','[data-plut-patreon-user-id]','_STORAGE_KEY','patreon_info','_blank','_pDoNotifyActivated','70836OWTtGo','race','notifications','addClass','no-cache,\x20no-store','&fast=true','disabled','MODULE_NAME','find','<button\x20class=\x22w-20\x20bl-0\x20ml-0\x22\x20data-plut-chat-cancel=\x22true\x22><i\x20class=\x22fas\x20fa-times\x22></i>\x20No</button>','Failed\x20to\x20authenticate—timed\x20out.','_pGetUserId','render','Logging\x20In\u00a0\u00a0\u00a0','now','click','ANFG4r9Eq2akQk9Bz0O2M60AjbgvZDRQ1cN_reGdytGBVUVx8jYaQ6m0BKZi0Yay','body','343648YQkPLy','1689399uscOjS','SRD\x20Module','/media/img/patreon.png','misc','prop','&scope=identity\x20identity.memberships&state=','open','name','_pGetSaveUserIdNew','init','_pHasWorldUserId','1958LHsgYh','preventDefault','5uWZZFq','json','_init_gm','pGetLogin','user','\x22><i\x20class=\x22fas\x20fa-check\x22></i>\x20Yes</button>','error','/summary?t=','_pGetLoginFast','get','_pSetUserId','currentTarget','_resolve','_pHandleClick_btnLogin_','/template/LoginDialogue.hbs','_reject','sounds/notify.wav','pSetClient','pGetClient','_$btnLogin','_getUserSummary','Log\x20In','Patron\x20features\x20activated!','activateListeners','<button\x20class=\x22w-80\x22\x20data-plut-patreon-user-id=\x22','_pHandleClick_btnLogin','pSendGmOnlyMessage','2766862ewRgir','padEnd','pDeleteMessage','_ivLoading','warn','_CLIENT_ID','userId','pRemoveUserIdStrict','pRemoveClient','pGetWorld','_getUserSummary_','_userId','registerWorld','_getFallbackUserSummary','870750YHlYMR','isGM','patreon/redirect','pLock','getCleanServerUrl','pDelay','Logging\x20In','6hzRXIx','493CcYmxk','</div>','pRemoveWorld','tool-','1925bXCsJj','registerClient','getData','_promise','isRegistered','user/','unlock','pSetWorld','225fEOutL','application/json','then','pGetShowLoginDialogue','\x20has\x20activated\x20Patron-only\x20features.\x20Would\x20you\x20like\x20to\x20activate\x20Patron-only\x20features\x20for\x20this\x20game?</p>\x0a\x09\x09\x09\x09\x09<p><b>Warning:</b>\x20this\x20will\x20reload\x20the\x20game.</p>\x0a\x09\x09\x09\x09\x09<div\x20class=\x22btn-group\x20ve-flex\x22>'];_0x4c66=function(){return _0x48cb20;};return _0x4c66();}class UtilPatreon{static [_0x25761b(0x117)]=_0x25761b(0x15d);static [_0x25761b(0x149)]=_0x25761b(0x14a);static #_IS_AUTHENTICATED;static [_0x25761b(0x13b)]=new VeLock();static[_0x25761b(0xf3)](){const _0x4024ef=_0x25761b;GameStorage[_0x4024ef(0x12d)](this[_0x4024ef(0x149)]),GameStorage[_0x4024ef(0x11e)](this[_0x4024ef(0x149)]);if(game[_0x4024ef(0xfb)][_0x4024ef(0x121)])this[_0x4024ef(0xf9)]();}static['_init_gm'](){const _0x5a0c52=_0x25761b;$(document[_0x5a0c52(0x15e)])['on'](_0x5a0c52(0x15c),_0x5a0c52(0x148),async _0x5f5977=>{const _0x23aeb6=_0x5a0c52,_0x2a3cd3=$(_0x5f5977[_0x23aeb6(0x102)])['attr']('data-plut-patreon-user-id');await GameStorage['pSetWorld'](this[_0x23aeb6(0x149)],{'userId':_0x2a3cd3}),await UtilChat[_0x23aeb6(0x114)]({'ele':_0x5f5977[_0x23aeb6(0x102)]}),GameStorage[_0x23aeb6(0x145)]()[_0x23aeb6(0x136)](null);});}static async[_0x25761b(0x143)](){const _0x4b9a8b=_0x25761b;await this[_0x4b9a8b(0x142)](),GameStorage['pDoReload']()[_0x4b9a8b(0x136)](null);}static async[_0x25761b(0x137)](){const _0x33432c=_0x25761b;if(this.#_IS_AUTHENTICATED)return{'isPatron':!![],'isExisting':!![]};if(await this[_0x33432c(0xff)]())return{'isPatron':!![],'isExisting':!![]};let _0x34e3fe;if(!game['user'][_0x33432c(0x121)]&&await this[_0x33432c(0xf4)]()){_0x34e3fe=await this[_0x33432c(0x13f)]();if(!_0x34e3fe)_0x34e3fe=await this[_0x33432c(0xf2)]();else{if(await this[_0x33432c(0xff)]({'userId':_0x34e3fe}))return{'isPatron':!![],'isExisting':!![]};}}const _0x47f0ae=new _LoginDialogue({'userId':_0x34e3fe});return _0x47f0ae[_0x33432c(0x159)](!![]),_0x47f0ae[_0x33432c(0x146)];}static async[_0x25761b(0xff)]({userId:_0x6fefdd}={}){const _0x437819=_0x25761b;if(this.#_IS_AUTHENTICATED)return!![];_0x6fefdd=_0x6fefdd||await this[_0x437819(0x158)]();const {isPatron:_0x1b349b,patreonUserId:_0xbd67aa}=await this[_0x437819(0x10b)]({'userId':_0x6fefdd,'isFast':!![]});if(_0x1b349b){this.#_IS_AUTHENTICATED=!![];if(_0xbd67aa&&_0x6fefdd!==_0xbd67aa)await this[_0x437819(0x101)]({'userId':_0xbd67aa});return await this[_0x437819(0x14c)](),!![];}return![];}static async[_0x25761b(0xfa)]({userId:_0x181b00}={}){const _0x39dce0=_0x25761b;try{return await this['_LOCK'][_0x39dce0(0x123)](),await this[_0x39dce0(0x13a)]({'userId':_0x181b00});}finally{this[_0x39dce0(0x13b)]['unlock']();}}static async[_0x25761b(0x13a)]({userId:_0x38933b}){const _0x1f32e9=_0x25761b;if(this.#_IS_AUTHENTICATED)return!![];_0x38933b=_0x38933b||await this[_0x1f32e9(0x158)]();const {isPatron:_0x4470a5,patreonUserId:_0x1b60d9}=await this[_0x1f32e9(0x10b)]({'userId':_0x38933b});if(_0x4470a5){this.#_IS_AUTHENTICATED=!![];if(_0x1b60d9&&_0x38933b!==_0x1b60d9)await this['_pSetUserId']({'userId':_0x1b60d9});return await this['_pDoNotifyActivated'](),!![];}const _0x3dcbb3=Util[_0x1f32e9(0x124)](Config[_0x1f32e9(0x100)](_0x1f32e9(0xed),'baseSiteUrl'))+_0x1f32e9(0x122);return window[_0x1f32e9(0xf0)]('https://www.patreon.com/oauth2/authorize?response_type=code&client_id='+this[_0x1f32e9(0x117)]+'&redirect_uri='+_0x3dcbb3+_0x1f32e9(0xef)+_0x38933b,_0x1f32e9(0x14b)),this.#_IS_AUTHENTICATED=await new Promise((_0x4f28a3,_0x530095)=>{const _0xf3a66d=_0x1f32e9;let _0x203439=Date[_0xf3a66d(0x15b)](),_0x2e79b5=0x0;const _0x2b8f46=new VeLock(),_0x5d41b8=async()=>{const _0x64d3ff=_0xf3a66d;try{await _0x2b8f46['pLock']();if(Date['now']()-_0x203439>0x1d4c0){const _0x316ed7=_0x64d3ff(0x157);ui['notifications'][_0x64d3ff(0xfd)](_0x316ed7),_0x530095(_0x316ed7);return;}const {isError:_0x47bfd6,isRegistered:_0x2a3a82,isPatron:_0x266baf,patreonUserId:_0x1cca81}=await Promise[_0x64d3ff(0x14e)]([MiscUtil[_0x64d3ff(0x125)](0x3a98,this[_0x64d3ff(0x11f)]()),this[_0x64d3ff(0x10b)]({'userId':_0x38933b})]);if(_0x2a3a82){if(_0x1cca81&&_0x38933b!==_0x1cca81)await this[_0x64d3ff(0x101)]({'userId':_0x1cca81});_0x4f28a3(_0x266baf);return;}if(_0x47bfd6&&++_0x2e79b5>0x5){const _0x3be48d='Failed\x20to\x20authenticate—too\x20many\x20failed\x20requests.';ui[_0x64d3ff(0x14f)][_0x64d3ff(0xfd)](_0x3be48d),_0x530095(_0x3be48d);}}finally{_0x2b8f46[_0x64d3ff(0x132)]();}setTimeout(_0x5d41b8,0x1388);};_0x5d41b8();}),await this[_0x1f32e9(0x14c)]({'isNotifyGm':!![]}),this.#_IS_AUTHENTICATED;}static async[_0x25761b(0x14c)]({isNotifyGm:isNotifyGm=![]}={}){const _0x1f0860=_0x25761b;if(this.#_IS_AUTHENTICATED){const _0x2237ff=_0x1f0860(0x10d);if(!isNotifyGm||game[_0x1f0860(0xfb)][_0x1f0860(0x121)])return console['log'](...LGT,_0x2237ff);const _0x4a5e60=await GameStorage[_0x1f0860(0x11b)](this[_0x1f0860(0x149)]),_0x5f244d=await GameStorage[_0x1f0860(0x109)](this[_0x1f0860(0x149)]);if(_0x4a5e60?.[_0x1f0860(0x118)]&&_0x4a5e60?.[_0x1f0860(0x118)]===_0x5f244d?.[_0x1f0860(0x118)]||!_0x5f244d?.['userId'])return console['log'](...LGT,_0x2237ff);const _0x51e24a=_0x1f0860(0x10f)+_0x5f244d[_0x1f0860(0x118)]['qq']()+_0x1f0860(0xfc),_0x3f55f2=_0x1f0860(0x156);return UtilChat[_0x1f0860(0x111)]({'content':_0x1f0860(0x139)+game[_0x1f0860(0xfb)][_0x1f0860(0xf1)]+_0x1f0860(0x138)+_0x51e24a+_0x3f55f2+_0x1f0860(0x129)})[_0x1f0860(0x136)](null),console[_0x1f0860(0x13c)](...LGT,_0x2237ff);}ui[_0x1f0860(0x14f)][_0x1f0860(0x116)](_0x1f0860(0x144)),ChatMessage['create']({'sound':_0x1f0860(0x107),'content':'<div>\x0a\x09\x09\x09\x09<p>Patron-only\x20features\x20were\x20not\x20activated.</p>\x0a\x09\x09\x09\x09<p>You\x20may\x20need\x20to\x20<a\x20target=\x22_blank\x22\x20href=\x22https://www.patreon.com/Giddy5e\x22\x20rel=\x22noopener\x20noreferrer\x22>subscribe</a>\x20(&quot;Goblin&quot;\x20tier\x20or\x20higher).</p>\x0a\x09\x09\x09\x09<p>For\x20help\x20and\x20support,\x20join\x20our\x20<a\x20target=\x22_blank\x22\x20href=\x22https://discord.gg/nGvRCDs\x22\x20rel=\x22noopener\x20noreferrer\x22>Discord</a>.</p>\x0a\x09\x09\x09</div>','user':game['userId'],'type':0x4,'whisper':[game[_0x1f0860(0x118)]],'speaker':{'alias':''+(Config['get']('ui','isStreamerMode')?_0x1f0860(0x161):'Plutonium')}})[_0x1f0860(0x136)](null);}static async[_0x25761b(0x158)](){const _0x42a5dc=_0x25761b,_0x23c763=await GameStorage[_0x42a5dc(0x11b)](this['_STORAGE_KEY']);if(_0x23c763?.[_0x42a5dc(0x118)])return _0x23c763[_0x42a5dc(0x118)];const _0x290ff6=await this[_0x42a5dc(0x13f)]();if(_0x290ff6)return _0x290ff6;return this[_0x42a5dc(0xf2)]();}static async['_pSetUserId']({userId:_0x4ecd87}){const _0x500307=_0x25761b;await(game['user'][_0x500307(0x121)]?GameStorage[_0x500307(0x133)](this[_0x500307(0x149)],{'userId':_0x4ecd87}):GameStorage[_0x500307(0x108)](this[_0x500307(0x149)],{'userId':_0x4ecd87}));}static async[_0x25761b(0x13f)](){const _0x37cf68=_0x25761b;if(game['user'][_0x37cf68(0x121)])return null;const _0xda3789=await GameStorage[_0x37cf68(0x109)](this[_0x37cf68(0x149)]);if(_0xda3789?.[_0x37cf68(0x118)])return _0xda3789[_0x37cf68(0x118)];return null;}static async[_0x25761b(0xf4)](){const _0x5cbff7=_0x25761b,_0x508045=await GameStorage[_0x5cbff7(0x11b)](this[_0x5cbff7(0x149)]);return!!_0x508045?.[_0x5cbff7(0x118)];}static async[_0x25761b(0xf2)](){const _0x14d098=_0x25761b,_0x49b6c0=_0x14d098(0x12b)+foundry['utils']['randomID'](0x1a);return await this[_0x14d098(0x101)]({'userId':_0x49b6c0}),_0x49b6c0;}static async['_pDeleteUserId'](){const _0xa7923e=_0x25761b;await GameStorage[_0xa7923e(0x11a)](this[_0xa7923e(0x149)]),game[_0xa7923e(0xfb)][_0xa7923e(0x121)]&&await GameStorage[_0xa7923e(0x12a)](this['_STORAGE_KEY']);}static async[_0x25761b(0x10b)]({userId:_0x318e86,isFast:_0x47f38e}){const _0x2aef4c=_0x25761b;try{return await this[_0x2aef4c(0x11c)]({'userId':_0x318e86,'isFast':_0x47f38e});}catch(_0x46c509){return this[_0x2aef4c(0x11f)]();}}static['_getFallbackUserSummary'](){return{'isError':!![],'isRegistered':![],'isPatron':![],'patreonUserId':null};}static async[_0x25761b(0x11c)]({userId:_0x3d583d,isFast:isFast=![]}){const _0x3fe777=_0x25761b,_0x18922e=await fetch(Util[_0x3fe777(0x124)](Config['get'](_0x3fe777(0xed),_0x3fe777(0x141)))+_0x3fe777(0x131)+_0x3d583d+_0x3fe777(0xfe)+new Date()['getTime']()+(isFast?_0x3fe777(0x152):''),{'headers':{'Accept':_0x3fe777(0x135),'Content-Type':_0x3fe777(0x135),'Cache-Control':_0x3fe777(0x151)}}),_0x3cde60=await _0x18922e[_0x3fe777(0xf8)]();return{'isError':_0x18922e['status']!==0xc8,'isRegistered':!!_0x3cde60[_0x3fe777(0x130)],'isPatron':!!_0x3cde60['isPatron'],'patreonUserId':_0x3cde60['patreonUserId']};}static async[_0x25761b(0x147)](){const _0x474fb2=_0x25761b;if(game[_0x474fb2(0xfb)][_0x474fb2(0x121)]){const _0x8a9f00=await GameStorage[_0x474fb2(0x11b)](this['_STORAGE_KEY']);return!!_0x8a9f00?.['userId'];}const _0x320471=await this[_0x474fb2(0x13f)]();return!!_0x320471;}static async[_0x25761b(0x119)](){const _0x4d0f33=_0x25761b;if(game[_0x4d0f33(0xfb)][_0x4d0f33(0x121)])return GameStorage['pRemoveWorld'](this[_0x4d0f33(0x149)]);return GameStorage[_0x4d0f33(0x11a)](this[_0x4d0f33(0x149)]);}}export{UtilPatreon};